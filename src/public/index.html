<!DOCTYPE html>
<html lang='en'>

<head>
	<meta charset='UTF-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/marked/15.0.12/marked.min.js'></script>
	<title>Fly Notes</title>
	<script src='https://unpkg.com/turndown@7.2.1/dist/turndown.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js'></script>
	<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
	<link id='hljs-light-theme' rel='stylesheet'
		href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css'>
	<link id='hljs-dark-theme' rel='stylesheet'
		href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css' disabled>
	<link rel='icon' type='image/png' href='/favicon.png'>
</head>
<style>
	:root {
		--bg-color: #f4f7f9;
		--surface-color: #ffffff;
		--primary-color: #367cff;
		--primary-hover: #2a63cc;
		--text-color: #333;
		--text-secondary: #667;
		--border-color: #e2e8f0;
		--danger-color: #e53e3e;
		--accent-color: #38b2ac;
		--accent-hover: #2c918b;
		--border-radius-base: 6px;
		--font-family: -apple-system, 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', sans-serif;
	}

	button,
	.btn,
	.auth-form input,
	textarea,
	#note-form,
	.note,
	.sidebar-content {
		border-radius: var(--border-radius-base);
	}

	.file-tag-item,
	.tag-count {
		border-radius: calc(var(--border-radius-base) / 2);
	}

	aside#left-sidebar::-webkit-scrollbar {
		width: 0;
		height: 0;
		background: transparent;
	}

	#heatmap-scroll-container::-webkit-scrollbar {
		width: 0;
		height: 0;
		background: transparent;
	}

	aside#left-sidebar {
		scrollbar-width: none;
	}

	#heatmap-scroll-container {
		scrollbar-width: none;
	}

	html[data-theme='dark'] {
		--bg-color: #0a1222;
		--surface-color: #151f31;
		--text-color: #e2e8f0;
		--text-secondary: #a0aec0;
		--border-color: #4a5568;
		--danger-color: #f56565;
	}

	html {
		scrollbar-width: thin;
		scrollbar-color: var(--border-color) var(--surface-color);
	}

	::-webkit-scrollbar {
		width: 8px;
		height: 8px;
		background-color: var(--surface-color);
	}

	::-webkit-scrollbar-track {
		background-color: transparent;
		border-radius: 10px;
	}

	::-webkit-scrollbar-thumb {
		background-color: var(--border-color);
		border-radius: 10px;
		border: 2px solid var(--surface-color);
	}

	::-webkit-scrollbar-thumb:hover {
		background-color: var(--primary-color);
		border-color: var(--surface-color);
	}

	::-webkit-scrollbar-thumb:active {
		background-color: var(--primary-hover);
	}

	body[data-theme='dark'] .auth-form input,
	body[data-theme='dark'] textarea {
		background-color: var(--surface-input-bg, #2d3748);
		color: var(--text-color);
		border-color: var(--border-color);
	}

	body[data-theme='dark'] .auth-form input,
	body[data-theme='dark'] textarea {
		background-color: var(--surface-input-bg, #2d3748);
		color: var(--text-color);
		border-color: var(--border-color);
	}

	body[data-theme='dark'] .auth-form input:focus,
	body[data-theme='dark'] textarea:focus {
		box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.25);
	}

	body[data-theme='dark'] .file-tag-item,
	body[data-theme='dark'] .edit-file-tag,
	body[data-theme='dark'] .attachment-link {
		background-color: #4a5568;
		color: #e2e8f0;
		border-color: #718096;
	}

	body[data-theme='dark'] .attachment-link:hover {
		background-color: #2d3748;
	}

	body:not(.auth-visible) #app-container {
		display: block;
	}

	body.auth-visible #app-container {
		display: none !important;
	}

	#initial-loader {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: var(--bg-color);
		display: flex;
		align-items: center;
		justify-content: center;
		z-index: 9999;
		opacity: 1;
		transition: opacity 0.5s ease;
	}

	#initial-loader .spinner {
		width: 40px;
		height: 40px;
		border: 4px solid var(--border-color);
		border-top-color: var(--primary-color);
		border-radius: 50%;
		animation: spin 1s linear infinite;
	}

	#auth-container,
	#app-container {
		display: none;
	}

	#app-layout-container {
		display: grid;
		grid-template-columns: 300px 1fr 100px;
		gap: 0rem;
		max-width: 1280px;
		margin: 0 auto;
		padding: 2rem 2rem 1rem;
	}

	#right-sidebar {
		position: fixed;
		right: 2rem;
		top: 2rem;
		align-self: start;
		height: calc(100vh - 4rem);
		overflow-y: auto;
		display: flex;
		flex-direction: column;
		padding-top: 0.5rem;
	}

	#main-content-area {
		min-width: 0;
	}

	#main-content-area .container {
		width: 90%;
		max-width: 800px;
		margin: 0 auto;
		padding: 0;
	}

	#left-sidebar {
		position: sticky;
		top: 2rem;
		align-self: start;
		max-height: calc(100vh - 4rem);
		overflow-y: auto;
		scrollbar-gutter: stable;
	}

	#clear-filter-btn,
	#clear-tags-filter-btn {
		opacity: 0;
		visibility: hidden;
		transform: scale(0.8);
		transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
	}

	#clear-filter-btn.visible,
	#clear-tags-filter-btn.visible {
		opacity: 1;
		visibility: visible;
		transform: scale(1);
	}

	#timeline-container ul {
		list-style: none;
		padding-left: 0.5rem;
		margin: 0;
	}

	#timeline-container li {
		margin: 0.25rem 0;
	}

	.timeline-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 6px 8px;
		cursor: pointer;
		border-radius: 4px;
		transition: background-color 0.2s ease;
	}

	.timeline-item:hover {
		background-color: var(--border-color);
	}

	.timeline-item.active {
		background-color: var(--primary-color);
		color: white;
	}

	.timeline-item.active .timeline-count {
		color: white;
	}

	.timeline-label {
		display: flex;
		align-items: center;
	}

	.timeline-toggle {
		width: 16px;
		height: 16px;
		margin-right: 8px;
		transition: transform 0.2s ease;
		opacity: 0.5;
	}

	.timeline-toggle.expanded {
		transform: rotate(90deg);
	}

	.timeline-count {
		font-size: 0.8rem;
		color: var(--text-secondary);
		background-color: var(--bg-color);
		padding: 1px 6px;
		border-radius: .5rem;
	}

	body[data-theme='dark'] .timeline-count {
		background-color: #4a5568;
	}

	.timeline-item.active .timeline-count {
		background-color: rgba(255, 255, 255, 0.2);
	}

	.timeline-actions {
		display: flex;
		align-items: center;
		gap: 8px;
	}

	.timeline-filter-btn {
		background: none;
		border: none;
		padding: 4px;
		margin: 0;
		line-height: 1;
		border-radius: 50%;
		cursor: pointer;
		color: var(--text-secondary);
		display: none;
		transition: background-color 0.2s, color 0.2s;
	}

	.timeline-item:hover .timeline-filter-btn {
		display: block;
	}

	.timeline-filter-btn:hover {
		background-color: var(--bg-color);
		color: var(--text-color);
	}

	body[data-theme='dark'] .timeline-filter-btn:hover {
		background-color: #4a5568;
	}

	.timeline-item.active .timeline-filter-btn {
		display: block;
		color: white;
	}

	.timeline-item.active .timeline-filter-btn:hover {
		background-color: rgba(255, 255, 255, 0.2);
	}

	.timeline-children {
		display: none;
		padding-left: 1rem;
		border-left: 1px solid var(--border-color);
		margin-left: 8px;
	}



	@media (max-width: 600px) {
		#app-layout-container {
			padding: 2rem .5rem 0.5rem;
		}

		#main-content-area .container {
			width: 100%;
		}

		.container {
			min-width: 300px !important;
		}
	}

	/* 鍝嶅簲寮忚璁★細鍦ㄥ皬灞忓箷涓婇殣钘忎晶杈规爮 */
	@media (max-width: 1250px) {
		#app-layout-container {
			grid-template-columns: 1fr !important;
		}

		#left-sidebar {
			display: none !important;
			/* 隐藏侧边栏 */
		}

		/* 鍦ㄥ灞忔ā寮忎笅锛屽鏋滃彸渚ф爮瀛樺湪锛屽垯涓棿鏍忎緷鐒跺彈闄?*/
		#app-layout-container.full-width-mode #main-content-area .container {
			max-width: 85%;
			max-width: 1400px !important;
		}
	}

	@media (max-width: 1150px) {
		#right-sidebar {
			display: none !important;
			/* 隐藏侧边栏 */
		}

		#wide-mode-toggle-btn {
			display: none;
		}
	}

	@media (max-width: 700px) {
		#waterfall-toggle-btn {
			display: none;
		}
	}

	@media (max-width: 1300px) and (min-width: 1250px) {
		#app-layout-container {
			grid-template-columns: 300px 800px;
			justify-content: center;
		}
	}

	@media (max-width: 1300px) {
		.sidebar-tab-btn {
			width: 60px !important;
			height: 60px !important;
		}

		.tag-name {
			max-width: 120px;
		}
	}

	.header-actions {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	#theme-toggle-btn {
		width: 36px;
		height: 36px;
		border-radius: 50%;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		transition: all 0.2s ease;
	}

	body {
		font-family: var(--font-family);
		background-color: var(--bg-color);
		color: var(--text-color);
		margin: 0;
		padding: 0rem 0rem;
		line-height: 1.6;
	}

	.container {
		min-width: 390px;
		margin: 0 auto;
		padding: 0 1rem;
	}

	body.auth-visible {
		display: flex;
		align-items: center;
		justify-content: center;
		min-height: 100vh;
		padding: 1rem;
		box-sizing: border-box;
	}

	body.auth-visible #app-layout-container {
		display: none;
	}

	#login-form h3 {
		margin-bottom: 0;
	}

	#login-btn {
		margin-top: 1rem;
		width: 120px;
	}

	#auth-container {
		text-align: center;
		background: var(--surface-color);
		max-width: 400px;
		width: 100%;
		padding: 2rem;
		border-radius: .5rem;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
	}

	#auth-container h1 {
		margin-top: 0;
		color: var(--primary-color);
	}

	.auth-form input {
		display: block;
		width: 100%;
		max-width: 400px;
		padding: 12px;
		margin-bottom: 1rem;
		border: 1px solid var(--border-color);
		border-radius: 0px;
		font-size: 1rem;
		box-sizing: border-box;
	}

	#login-error {
		color: var(--danger-color);
		margin-bottom: .5rem;
		min-height: 1.2em;
	}

	#app-container {
		display: none;
	}

	.app-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1rem;
	}

	.app-header h1 {
		margin: 0;
		font-size: 1.8rem;
		color: #445;
	}

	#note-form {
		background: var(--surface-color);
		padding: 1rem;
		border-radius: .5rem;
		margin-bottom: 1rem;
		border: 1px solid var(--border-color);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
		transition: all 0.3s ease;
	}

	#note-form.dragover {
		border-color: var(--primary-color);
		box-shadow: 0 0 15px rgba(54, 124, 255, 0.2);
		transform: translateY(-2px);
	}

	textarea {
		width: 100%;
		padding: 12px;
		border-radius: 0px;
		border: 1px solid var(--border-color);
		font-size: 1rem;
		margin-bottom: 0.5rem;
		box-sizing: border-box;
		resize: vertical;
		transition: box-shadow 0.2s, border-color 0.2s;
		font-family: -apple-system, 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', sans-serif;
	}

	.auth-form input:focus,
	textarea:focus {
		border-color: var(--primary-color);
		outline: none;
		box-shadow: 0 0 0 3px rgba(54, 124, 255, 0.15);
	}

	.form-actions {
		display: flex;
		justify-content: flex-end;
		align-items: center;
		gap: 1rem;
		flex-wrap: wrap;
	}

	.file-list-display .file-tag {
		display: inline-flex;
		align-items: center;
		background-color: #edf2f7;
		color: #4a5568;
		padding: 4px 10px;
		font-size: 0.85rem;
		margin-right: 6px;
		margin-bottom: 6px;
	}

	button,
	.btn {
		background-color: var(--primary-color);
		color: white;
		padding: 6px 12px;
		border: none;
		/*border-radius: 0px;*/
		cursor: pointer;
		font-size: 1rem;
		transition: all 0.2s ease;
		font-weight: 500;
	}

	button:hover,
	.btn:hover {
		background-color: var(--primary-hover);
		transform: translateY(-1px);
	}

	.btn-secondary {
		background-color: var(--surface-color);
		color: var(--text-color);
		border: 1px solid var(--border-color);
	}

	.btn-secondary:hover {
		background-color: var(--border-color);
		color: var(--text-color);
	}

	button:disabled {
		background-color: #a0aec0;
		cursor: not-allowed;
		transform: none;
	}

	.btn-secondary {
		background-color: #a0aec0;
	}

	.btn-secondary:hover {
		background-color: #718096;
	}

	.btn-danger {
		background-color: var(--danger-color);
	}

	.btn-danger:hover {
		background-color: #c53030;
	}

	.btn-accent {
		background-color: var(--accent-color);
	}

	.btn-accent:hover {
		background-color: var(--accent-hover);
	}

	.btn-accent:hover {
		background-color: var(--accent-hover);
	}

	.icon-btn {
		background: none;
		border: none;
		padding: 0;
		cursor: pointer;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 32px;
		height: 32px;
		border-radius: 50%;
		color: var(--text-secondary);
		transition: all 0.2s ease;
	}

	.icon-btn:hover {
		background-color: var(--border-color);
		color: var(--text-color);
	}

	.icon-btn svg {
		width: 20px;
		height: 20px;
	}

	.icon-btn.btn-danger:hover {
		color: var(--danger-color);
		background-color: rgba(229, 62, 62, 0.1);
	}

	.icon-btn.btn-accent:hover {
		color: var(--accent-color);
		background-color: rgba(56, 178, 172, 0.1);
	}

	body[data-theme='dark'] .icon-btn:hover {
		background-color: #4a5568;
	}

	.text-link-button {
		background: none;
		border: none;
		color: var(--primary-color);
		padding: 0;
		font-size: 1rem;
		cursor: pointer;
		font-weight: 500;
		text-decoration: none;
		display: inline-block;
		vertical-align: middle;
	}

	.text-link-button:hover {
		text-decoration: underline;
	}

	.edit-actions .text-link-button {
		font-size: 0.8rem;
	}

	.file-list-display {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}

	.file-list-display:empty {
		display: none;
	}

	.file-tag-item {
		position: relative;
		display: inline-flex;
		align-items: center;
		background-color: #edf2f7;
		color: #4a5568;
		padding: 4px 24px 4px 10px;
		font-size: 0.85rem;
		border-radius: 0px;
	}

	.remove-file-main-btn {
		position: absolute;
		top: 0;
		right: 0;
		bottom: 0;
		width: 24px;
		background: none;
		border: none;
		color: var(--danger-color);
		font-size: 1.2rem;
		cursor: pointer;
		line-height: 1;
		padding: 0;
		opacity: 0.6;
		transition: opacity 0.2s;
	}

	.remove-file-main-btn:hover {
		opacity: 1;
	}

	.note {
		background: var(--surface-color);
		border: 1px solid var(--border-color);
		border-radius: .5rem;
		padding: .5rem 1rem;
		margin-bottom: .5rem;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
		transition: transform 0.2s ease, box-shadow 0.2s ease;
		box-sizing: border-box;
	}

	.note:hover {
		box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
	}

	.note-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: .5rem;
		padding-bottom: 0rem;
	}

	.note-meta {
		font-size: 0.8rem;
		color: var(--text-secondary);
	}

	.note-actions,
	.edit-actions {
		display: flex;
	}

	.note-actions button,
	.edit-actions button {
		font-size: 0.8rem;
	}

	.note-content {
		white-space: pre-wrap;
		word-wrap: break-word;
		font-size: 1rem;
		margin-bottom: 1rem;
	}

	/* Collapsed note styles */
	.note.collapsed .note-content.view-mode {
		max-height: 600px;
		overflow: hidden;
		position: relative;
	}

	.note.collapsed .note-content.view-mode::after {
		content: '';
		position: absolute;
		bottom: 0;
		left: 0;
		right: 0;
		height: 80px;
		background: linear-gradient(to bottom, transparent, var(--surface-color));
		pointer-events: none;
	}

	.expand-note-btn {
		display: none;
		width: 100%;
		text-align: center;
		padding: 0.5rem;
		background: none;
		border: none;
		color: var(--primary-color);
		cursor: pointer;
		font-size: 0.9rem;
		margin-top: -0.5rem;
	}

	.expand-note-btn:hover {
		text-decoration: underline;
		background: none;
		transform: none;
	}

	.note.collapsed .expand-note-btn {
		display: block;
	}

	.note-content a {
		color: var(--primary-color);
		text-decoration: none;
		border-bottom: 1px solid transparent;
		transition: border-color 0.2s;
		word-break: break-all;
	}

	.note-content a:hover {
		border-bottom-color: var(--primary-color);
	}

	.attachments-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
		gap: 1rem;
		margin-top: 0.5rem;
		padding: 0.75rem;
	}

	.attachment-img a {
		display: block;
		overflow: hidden;
		border-radius: 0px;
	}

	.attachment-img img {
		max-width: 100%;
		display: block;
		transition: transform 0.3s ease;
	}

	.attachment-img a:hover img {
		transform: scale(1.05);
	}

	.attachment-link {
		display: flex;
		flex-direction: column;
		justify-content: center;
		background-color: #f7fafc;
		padding: 0.25rem 0.75rem;
		border-radius: 0px;
		color: var(--text-color);
		text-decoration: none;
		font-size: 1rem;
		transition: background-color 0.2s;
		border: 1px solid var(--border-color);
	}

	.attachment-link:hover {
		background-color: #edf2f7;
	}

	.attachment-link .file-name {
		word-break: break-all;
		font-weight: 500;
	}

	.attachment-link .file-size {
		color: var(--text-secondary);
		font-size: 0.75rem;
	}

	.edit-area {
		display: none;
	}

	.edit-textarea {
		min-height: 100px;
	}

	.edit-textarea.dragover {
		border-color: var(--primary-color);
		box-shadow: inset 0 0 10px rgba(54, 124, 255, 0.2);
	}

	.edit-files-container {
		display: none;
		flex-wrap: wrap;
		gap: 0.5rem;
		padding-bottom: 0.75rem;
	}

	.edit-file-tag {
		position: relative;
		display: inline-flex;
		align-items: center;
		background-color: #edf2f7;
		color: #4a5568;
		padding: 4px 20px 4px 10px;
		font-size: 0.85rem;
	}

	.edit-file-tag.deleted {
		text-decoration: line-through;
		opacity: 0.6;
	}

	.remove-file-btn {
		position: absolute;
		top: 0;
		right: 0;
		bottom: 0;
		width: 20px;
		background: none;
		border: none;
		color: var(--danger-color);
		font-size: 1.2rem;
		cursor: pointer;
		line-height: 1;
		padding: 0;
		opacity: 0.7;
	}

	.remove-file-btn:hover {
		opacity: 1;
	}

	.note.editing .view-mode,
	.note:not(.editing) .edit-mode {
		display: none;
	}

	.note.editing .note-content,
	.note.editing .attachments-grid {
		display: none;
	}

	.note.editing .edit-area {
		display: block;
	}

	.loading-indicator {
		text-align: center;
		padding: 3rem;
		color: var(--text-secondary);
	}

	#refresh-loader {
		position: absolute;
		top: 0.5rem;
		left: 50%;
		transform: translateX(-50%);
		z-index: 10;

		display: none;
		align-items: center;
		gap: 0.5rem;

		background-color: var(--primary-color);
		color: white;
		padding: 6px 14px;
		border-radius: 20px;
		font-size: 0.8rem;
		font-weight: 500;
		box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
		white-space: nowrap;
	}

	#refresh-loader .spinner {
		width: 14px;
		height: 14px;
		border: 2px solid rgba(255, 255, 255, 0.3);
		border-top-color: #ffffff;
		/* 鍦ㄤ富鑹茶儗鏅笂浣跨敤绾櫧 */
		border-radius: 50%;
		animation: spin 1s linear infinite;
	}

	@keyframes spin {
		to {
			transform: rotate(360deg);
		}
	}

	body[data-theme='dark'] #refresh-loader {
		box-shadow: none;
	}

	#notes-section {
		position: relative;
	}

	.icon-btn.pinned {
		opacity: 1;
		visibility: visible;
		color: var(--primary-color);
	}

	.icon-btn.pinned svg {
		fill: currentColor;
	}

	.custom-modal-overlay {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.5);
		z-index: 1000;
		display: flex;
		align-items: center;
		justify-content: center;
		opacity: 0;
		visibility: hidden;
		transition: opacity 0.3s ease, visibility 0.3s ease;
	}

	.alert-modal {
		z-index: 1010;
	}

	body[data-theme='dark'] .custom-modal-overlay {
		background: rgba(10, 10, 20, 0.7);
	}

	.custom-modal-overlay.visible {
		opacity: 1;
		visibility: visible;
	}

	.custom-modal-box {
		display: none;
		background: var(--surface-color);
		padding: 1.5rem;
		box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
		width: 90%;
		max-width: 400px;
		text-align: center;
		transform: scale(0.9);
		transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
	}

	.custom-modal-overlay.visible .custom-modal-box.active {
		display: block;
		/* Show the active box */
		transform: scale(1) translate3d(0, 0, 0);
	}

	#custom-alert-message {
		margin: 0 0 1.5rem;
	}

	.custom-modal-actions {
		display: flex;
		justify-content: flex-end;
		gap: 1rem;
		margin-top: 1.5rem;
	}

	#custom-confirm-message,
	#custom-alert-message {
		color: var(--text-color);
		font-size: 1rem;
		line-height: 1.5;
		word-wrap: break-word;
	}

	.note-content h1,
	.edit-preview h1,
	.note-content h2,
	.edit-preview h2,
	.note-content h3,
	.edit-preview h3 {
		margin-top: 1em;
		margin-bottom: 0.5em;
		line-height: 1.3;
		border-bottom: none;
	}

	.note-content h1,
	.edit-preview h1 {
		font-size: 1.5em;
	}

	.note-content h2,
	.edit-preview h2 {
		font-size: 1.25em;
	}

	.note-content h3,
	.edit-preview h3 {
		font-size: 1.1em;
	}

	.note-content p,
	.edit-preview p {
		margin: 0 0 1em;
	}

	.note-content ul,
	.edit-preview ul,
	.note-content ol,
	.edit-preview ol {
		padding-left: 1.5em;
		margin-bottom: 1em;
	}

	.note-content li,
	.edit-preview li {
		margin-bottom: 0.25em;
	}

	.note-content blockquote,
	.edit-preview blockquote {
		border-left: 3px solid var(--primary-color);
		padding-left: 1em;
		margin: 1em 0;
		color: var(--text-secondary);
	}

	.note-content code,
	.edit-preview code {
		background-color: var(--border-color);
		padding: 0.2em 0.4em;
		border-radius: 4px;
		font-size: 85%;
		font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
	}

	.note-content pre,
	.edit-preview pre {
		padding: 1rem;
		border-radius: 8px;
		overflow-x: auto;
		margin: 1em 0;
		white-space: pre;
		line-height: 1.5;
		font-size: 85%;
	}

	.note-content pre,
	.edit-preview pre {
		background-color: var(--border-color);
		padding: 1rem;
		border-radius: 4px;
		overflow-x: auto;
		margin: 1em 0;
		white-space: pre;
	}

	.note-content pre code,
	.edit-preview pre code {
		background: none;
		padding: 0;
		font-size: inherit;
		white-space: inherit;
		color: inherit;
	}

	body[data-theme='dark'] .note-content pre,
	body[data-theme='dark'] .edit-preview pre {
		background-color: #282c34;
		border-color: #282c34;
	}

	.note-content img,
	.edit-preview img {
		max-width: 100%;
		height: auto;
		border-radius: 4px;
		display: block;
		margin: 0.5rem 0;
	}

	.note-content img.inline-img,
	.edit-preview img.inline-img {
		display: inline-block;
		margin: 0 4px;
		/* 浣跨敤 1.25em 纭繚绋嶅ぇ浜庢枃瀛楋紝鍨傜洿灞呬腑 */
		height: 1.25em;
		width: auto;
		vertical-align: text-bottom;
		border-radius: 0;
	}

	.note-content,
	.edit-preview {
		white-space: normal;
	}

	.edit-preview {
		display: none;
		min-height: 150px;
		padding: 12px;
		border-radius: 0px;
		border: 1px solid var(--border-color);
		font-size: 1rem;
		word-wrap: break-word;
		background-color: var(--bg-color);
	}

	body[data-theme='dark'] .edit-preview {
		background-color: var(--surface-color);
		border-color: var(--border-color);
	}

	.note.editing[data-edit-mode="preview"] .edit-textarea,
	.note.editing[data-edit-mode="preview"] .edit-files-container,
	.note.editing[data-edit-mode="preview"] label[title="Add files"] {
		display: none;
	}

	.note.editing.split-mode[data-edit-mode="preview"] .edit-textarea {
		display: block;
	}

	.note.editing[data-edit-mode="raw"] .edit-files-container {
		display: flex;
	}

	.note.editing[data-edit-mode="preview"] .edit-preview {
		display: block;
	}

	.md-preview-toggle-btn.active {
		color: var(--primary-color);
		background-color: rgba(54, 124, 255, 0.1);
	}

	#main-edit-preview {
		display: none;
		margin-bottom: .5rem;
	}

	#note-form.preview-mode #note-input,
	#note-form.preview-mode #file-list-display,
	#note-form.preview-mode #select-files-btn {
		display: none;
	}

	#note-form.preview-mode #main-edit-preview {
		display: block;
	}

	#main-preview-toggle-btn.active {
		color: var(--primary-color);
		background-color: rgba(54, 124, 255, 0.1);
	}

	.image-preview-modal {
		display: none;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 20px;
		box-sizing: border-box;
		position: fixed;
		z-index: 1001;
		padding-top: 60px;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		overflow: auto;
		background-color: rgba(0, 0, 0, 0.9);
		transition: opacity 0.3s ease;
	}

	.image-preview-content {
		display: block;
		max-width: calc(100% - 40px);
		max-height: calc(100% - 100px);
		animation-name: zoom;
		animation-duration: 0.4s;
		border-radius: 4px;
		object-fit: contain;
	}

	@keyframes zoom {
		from {
			transform: scale(0)
		}

		to {
			transform: scale(1)
		}
	}

	.image-preview-close {
		position: absolute;
		top: 15px;
		right: 35px;
		color: #f1f1f1;
		font-size: 40px;
		font-weight: bold;
		transition: 0.3s;
		cursor: pointer;
	}

	.image-preview-close:hover,
	.image-preview-close:focus {
		color: #bbb;
		text-decoration: none;
	}

	.video-preview-close {
		position: absolute;
		top: 15px;
		right: 35px;
		color: #f1f1f1;
		font-size: 40px;
		font-weight: bold;
		transition: 0.3s;
		cursor: pointer;
	}

	.video-preview-close:hover,
	.video-preview-close:focus {
		color: #bbb;
		text-decoration: none;
	}

	#image-preview-caption {
		display: block;
		width: 100%;
		max-width: 80vw;
		text-align: center;
		color: #ccc;
		padding: 15px 0 0;
		font-size: 0.9rem;
		flex-shrink: 0;
	}

	.table-wrapper {
		width: 100%;
		overflow-x: auto;
		-webkit-overflow-scrolling: touch;
		margin: 1em 0;
	}

	.note-content table,
	.edit-preview table {
		margin: 0;
	}

	.note-content table,
	.edit-preview table {
		width: 100%;
		border-collapse: collapse;
		margin: 1em 0;
		overflow: hidden;
		border-radius: 8px;
		border: 1px solid var(--border-color);
		box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
	}

	.note-content th,
	.edit-preview th,
	.note-content td,
	.edit-preview td {
		padding: 10px 15px;
		border: 1px solid var(--border-color);
		text-align: left;
	}

	.note-content thead th,
	.edit-preview thead th {
		background-color: var(--bg-color);
		font-weight: 600;
		color: var(--text-color);
	}

	body[data-theme='dark'] .note-content thead th,
	body[data-theme='dark'] .edit-preview thead th {
		background-color: var(--surface-color);
	}

	.note-content tbody tr:nth-of-type(even),
	.edit-preview tbody tr:nth-of-type(even) {
		background-color: rgba(0, 0, 0, 0.02);
	}

	body[data-theme='dark'] .note-content tbody tr:nth-of-type(even),
	body[data-theme='dark'] .edit-preview tbody tr:nth-of-type(even) {
		background-color: rgba(255, 255, 255, 0.03);
	}

	#fullscreen-editor-overlay .custom-modal-box {
		width: 90vw;
		max-width: 5000px;
		height: 95vh;
		padding: 0;
		display: flex;
		flex-direction: column;
		text-align: left;
		border: 2px solid var(--border-color);
		box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
	}

	body[data-theme='dark'] #fullscreen-editor-overlay .custom-modal-box {
		border-color: #4a5568;
	}

	#editor-toolbar {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 0.5rem 1rem;
		border-bottom: 1px solid var(--border-color);
		background-color: var(--bg-color);
		flex-shrink: 0;
	}

	.toolbar-left,
	.toolbar-right {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.toolbar-btn {
		background-color: transparent;
		border: 1px solid var(--border-color);
		color: var(--text-color);
		padding: 4px 8px;
		font-size: 0.8rem;
		cursor: pointer;
		border-radius: 4px;
	}

	.toolbar-btn:hover {
		background-color: var(--border-color);
	}

	#fs-color-picker-wrapper {
		display: flex;
		align-items: center;
	}

	#view-mode-selector {
		padding: 4px;
		border-radius: 4px;
		border: 1px solid var(--border-color);
		background-color: var(--surface-color);
		color: var(--text-color);
	}

	#editor-content-area {
		flex-grow: 1;
		display: flex;
		overflow: hidden;
	}

	#fs-editor-textarea,
	#fs-preview-pane {
		height: 100%;
		padding: 1rem;
		box-sizing: border-box;
		overflow-y: auto;
		border: none;
		background: transparent;
		font-size: 1rem;
		line-height: 1.6;
		flex-basis: 50%;
		flex-grow: 0;
		flex-shrink: 0;
	}

	#fs-editor-textarea {
		resize: none;
		line-height: 1.6;
	}

	textarea {
		line-height: 1.6;
		resize: none;
	}

	#fs-editor-divider {
		flex-basis: 6px;
		flex-shrink: 0;
		flex-grow: 0;
		background-color: var(--border-color);
		cursor: col-resize;
		transition: background-color 0.2s ease;
	}

	#fs-editor-divider:hover {
		background-color: var(--primary-color);
	}

	#editor-content-area[data-view-mode="source"] #fs-preview-pane,
	#editor-content-area[data-view-mode="source"] #fs-editor-divider {
		display: none;
	}

	#editor-content-area[data-view-mode="source"] #fs-editor-textarea {
		flex-basis: 100%;
		display: block;
	}

	#editor-content-area[data-view-mode="preview"] #fs-editor-textarea,
	#editor-content-area[data-view-mode="preview"] #fs-editor-divider {
		display: none;
	}

	#editor-content-area[data-view-mode="preview"] #fs-preview-pane {
		flex-basis: 100%;
		display: block;
	}

	#editor-content-area[data-view-mode="split"] #fs-editor-textarea,
	#editor-content-area[data-view-mode="split"] #fs-preview-pane,
	#editor-content-area[data-view-mode="split"] #fs-editor-divider {
		display: block;
	}

	@media (max-width: 800px) {
		#enter-fullscreen-btn {
			display: none;
		}

		.note .fullscreen-edit {
			display: none;
		}
	}

	#app-layout-container {
		min-height: 100vh;
		box-sizing: border-box;
	}

	#back-to-top-btn {
		position: fixed;
		bottom: 25px;
		right: 25px;
		z-index: 999;
		background-color: var(--primary-color);
		color: white;
		border: none;
		border-radius: 50%;
		width: 48px;
		height: 48px;
		cursor: pointer;
		box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
		display: flex;
		align-items: center;
		justify-content: center;
		opacity: 0;
		visibility: hidden;
		transform: translateY(20px);
		transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
	}

	#back-to-top-btn.visible {
		opacity: 1;
		visibility: visible;
		transform: translateY(0);
	}

	#back-to-top-btn:hover {
		background-color: var(--primary-hover);
		transform: translateY(-2px);
	}

	#back-to-top-btn svg {
		width: 24px;
		height: 24px;
	}

	.code-block-wrapper {
		position: relative;
		margin: 1em 0;
	}

	.code-block-wrapper pre {
		margin: 0;
	}

	.copy-code-btn {
		position: absolute;
		top: 0;
		right: 0;
		width: 30px;
		height: 30px;
		padding: 0;
		background-color: #616161;
		color: white;
		border: none;
		border-radius: 0 4px 0 4px;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		opacity: 0;
		transition: opacity 0.2s ease, background-color 0.2s ease;
	}

	.code-block-wrapper:hover .copy-code-btn {
		opacity: 1;
	}

	.copy-code-btn:hover {
		display: flex;
		background-color: var(--primary-color);
	}

	.copy-code-btn.copied {
		background-color: var(--accent-color);
	}

	#left-sidebar .sidebar-content {
		padding: 1rem 1.25rem;
		border-radius: 12px;
		transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease, background-color 0.2s ease;
	}

	#left-sidebar .sidebar-content h4 {
		display: flex;
		justify-content: space-between;
		margin-top: 0rem;
		margin-bottom: 1rem;
		padding-right: 8px;
		min-height: 36px;
	}

	#clear-tags-filter-btn {
		opacity: 0;
		visibility: hidden;
		transform: scale(0.8);
		transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
	}

	#clear-tags-filter-btn.visible {
		opacity: 1;
		visibility: visible;
		transform: scale(1);
	}

	#tags-container ul {
		list-style: none;
		padding-left: 0.5rem;
		margin: 0;
	}

	#tags-container li {
		margin: 0.25rem 0;
	}

	.tag-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 6px 12px;
		border-radius: 4px;
		transition: background-color 0.2s ease;
		cursor: pointer;
	}

	.tag-item:hover {
		background-color: var(--border-color);
	}

	.tag-item.active {
		background-color: var(--primary-color);
		color: white;
	}

	.tag-item.active .tag-count,
	.tag-item.active .tag-label {
		color: white;
	}

	.tag-label {
		word-break: break-all;
		padding-right: 1rem;
	}

	.tag-count {
		font-size: 0.8rem;
		color: var(--text-secondary);
		background-color: var(--bg-color);
		padding: 1px 6px;
		border-radius: 10px;
		white-space: nowrap;
	}

	body[data-theme='dark'] .tag-count {
		background-color: #4a5568;
	}

	.tag-item.active .tag-count {
		background-color: rgba(255, 255, 255, 0.2);
	}

	.tag-item-placeholder {
		font-size: 0.8rem;
		color: var(--text-secondary);
		padding: 6px 12px;
	}

	.inline-tag {
		color: var(--primary-color);
		text-decoration: none;
		background-color: rgba(54, 124, 255, 0.1);
		padding: 2px 6px;
		border-radius: 4px;
		font-weight: 500;
		transition: background-color 0.2s ease, color 0.2s ease;
	}

	body[data-theme='dark'] .inline-tag {
		background-color: rgba(66, 153, 225, 0.15);
	}

	.inline-tag:hover {
		color: white;
		background-color: var(--primary-hover);
		text-decoration: none;
	}

	#app-layout-container.no-right-sidebar {
		grid-template-columns: 300px 1fr;
	}

	#app-layout-container.full-width-mode {
		grid-template-columns: 1fr;
		gap: 0;
		padding: 2rem 1rem;
		position: relative;
	}

	#app-layout-container.full-width-mode #left-sidebar {
		display: none;
	}

	#app-layout-container.full-width-mode #main-content-area .container {
		max-width: 85% !important;
	}

	.sidebar-buttons-group {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
		align-items: center;
		width: 100%;
	}

	.sidebar-tab-btn {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		width: 70px;
		height: 70px;
		margin-bottom: 1rem;
		background-color: var(--surface-color);
		border: 1px solid var(--border-color);
		border-radius: 8px;
		color: var(--text-secondary);
		cursor: pointer;
		font-size: 0.75rem;
		font-weight: 500;
		transition: all 0.2s ease;
		text-align: center;
		gap: 0.25rem;
	}

	.sidebar-tab-btn:hover {
		background-color: var(--border-color);
		color: var(--text-color);
		transform: translateY(-2px);
	}

	.sidebar-tab-btn.active {
		background-color: var(--primary-color);
		color: white;
		border-color: var(--primary-color);
		transform: none;
	}

	.sidebar-tab-btn.active svg {
		fill: white;
	}

	.sidebar-tab-btn svg {
		width: 28px;
		height: 28px;
		fill: currentColor;
		transition: fill 0.2s ease;
	}

	.timeline-item[data-level="year"] .timeline-label {
		font-weight: 600;
	}

	.timeline-item.active .timeline-count,
	.tag-item.active .tag-count {
		color: white;
	}

	.timeline-item[data-level="month"] .timeline-label {
		font-weight: 500;
	}

	#heatmap-container-wrapper {
		padding: 1rem 1.75rem !important;
	}

	.form-actions {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 1rem;
		flex-wrap: wrap;
	}

	.toolbar-group-left,
	.toolbar-group-right {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.toolbar-group-left {
		position: relative;
	}

	.tag-dropdown-container {
		display: none;
		position: absolute;
		top: 100%;
		left: 0;
		margin-top: 8px;
		width: 280px;
		background-color: var(--surface-color);
		border: 1px solid var(--border-color);
		border-radius: 8px;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		z-index: 100;
	}

	#tag-search-input {
		width: 100%;
		padding: 10px;
		box-sizing: border-box;
		border: none;
		border-bottom: 1px solid var(--border-color);
		background-color: transparent;
		color: var(--text-color);
		outline: none;
	}

	#tag-dropdown-list {
		list-style: none;
		margin: 0;
		padding: 0.5rem;
	}

	#tag-dropdown-list li {
		padding: 8px 12px;
		cursor: pointer;
		border-radius: 4px;
		font-size: 0.9rem;
	}

	#tag-dropdown-list li:hover {
		background-color: var(--border-color);
	}

	#tag-dropdown-list li.no-results {
		color: var(--text-secondary);
		cursor: default;
		background-color: transparent;
	}

	.sidebar-search-container {
		position: relative;
		margin-bottom: 1rem;
	}

	#global-search-input {
		width: 100%;
		padding: 10px 12px 10px 38px;
		font-size: 0.9rem;
		border-radius: 8px;
		border: 1px solid var(--border-color);
		background-color: var(--surface-color);
		color: var(--text-color);
		box-sizing: border-box;
		outline: none;
		transition: border-color 0.2s, box-shadow 0.2s;
	}

	#global-search-input:focus {
		border-color: var(--primary-color);
		box-shadow: 0 0 0 3px rgba(54, 124, 255, 0.15);
	}

	.search-icon {
		position: absolute;
		top: 50%;
		left: 12px;
		transform: translateY(-50%);
		width: 20px;
		height: 20px;
		color: var(--text-secondary);
		pointer-events: none;
	}

	#clear-search-btn {
		position: absolute;
		top: 50%;
		right: 6px;
		transform: translateY(-50%);
		width: 28px;
		height: 28px;
	}

	#global-search-input::-webkit-search-cancel-button {
		-webkit-appearance: none;
		display: none;
	}

	.header-actions {
		position: relative;
	}

	.theme-popover {
		display: none;
		position: fixed;
		width: 180px;
		background-color: var(--surface-color);
		border: 1px solid var(--border-color);
		border-radius: 12px;
		box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
		padding: 0.75rem;
		z-index: 102;
		opacity: 0;
		visibility: hidden;
		transform: translateY(-10px);
		transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
	}

	.theme-popover.visible {
		display: block;
		opacity: 1;
		visibility: visible;
		transform: translateY(0);
	}

	.color-palette {
		display: grid;
		grid-template-columns: repeat(4, 1fr);
		gap: 0.75rem;
	}

	.color-swatch {
		width: 28px;
		height: 28px;
		border-radius: 50%;
		cursor: pointer;
		border: 2px solid var(--border-color);
		transition: transform 0.2s ease, border-color 0.2s ease;
		justify-self: center;
	}

	.color-swatch:hover {
		transform: scale(1.1);
	}

	.color-swatch.active {
		border-color: var(--text-color);
		box-shadow: 0 0 0 2px var(--surface-color), 0 0 0 4px var(--text-color);
	}

	.custom-color-separator {
		height: 1px;
		background-color: var(--border-color);
		margin: 1rem 0;
	}

	.custom-color-picker {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.color-picker-label {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		cursor: pointer;
		font-size: 0.9rem;
	}

	.color-picker-preview {
		width: 24px;
		height: 24px;
		border-radius: 6px;
		border: 1px solid var(--border-color);
	}

	.hidden-color-input {
		position: absolute;
		opacity: 0;
		width: 0;
		height: 0;
		pointer-events: none;
	}

	.hex-input-wrapper {
		display: flex;
		align-items: center;
		border: 1px solid var(--border-color);
		border-radius: 6px;
		padding: 4px 8px;
		background-color: var(--bg-color);
	}

	body[data-theme='dark'] .hex-input-wrapper {
		background-color: var(--surface-color);
	}

	.hex-input-wrapper span {
		color: var(--text-secondary);
	}

	.hex-color-input {
		width: 60px;
		border: none;
		background: none;
		outline: none;
		font-family: monospace;
		color: var(--text-color);
		margin-left: 4px;
	}

	.tag-label {
		display: inline-flex;
		align-items: center;
		word-break: break-all;
		padding-right: 1rem;
	}

	.tag-hash {
		font-size: 1.5em;
		font-weight: 600;
		color: var(--primary-color);
		margin-right: 0.5rem;
		line-height: 1;
	}

	.tag-item.active .tag-hash {
		color: inherit;
		opacity: 0.8;
	}

	.tag-name {
		text-overflow: ellipsis;
		white-space: nowrap;
		overflow: hidden;
	}

	#stats-card {
		display: flex;
		justify-content: space-around;
		align-items: center;
		text-align: center;
		padding: 0.75rem 0.5rem;
	}

	.stat-item {
		display: flex;
		flex-direction: column;
	}

	.stat-value {
		font-size: 1.6em;
		font-weight: 600;
		color: var(--primary-color);
		line-height: 1.2;
	}

	.stat-label {
		font-size: 0.75em;
		color: var(--text-secondary);
		text-transform: uppercase;
	}

	.sidebar-content h4 {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.sidebar-header-actions {
		display: flex;
		align-items: center;
		gap: 0.25rem;
	}

	.sidebar-toggle-btn {
		background: none;
		border: none;
		padding: 0;
		margin: 0;
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		width: 28px;
		height: 28px;
		border-radius: 50%;
		color: var(--primary-color);
		opacity: 0.7;
		transition: background-color 0.2s, color 0.2s, opacity 0.2s;
	}

	.sidebar-toggle-btn:hover {
		background-color: var(--border-color);
		color: var(--primary-hover);
		opacity: 1;
	}

	body[data-theme='dark'] .sidebar-toggle-btn:hover {
		background-color: #4a5568;
	}

	.sidebar-toggle-btn .toggle-icon {
		transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
	}

	.sidebar-content.is-collapsed .sidebar-toggle-btn .toggle-icon {
		transform: rotate(180deg);
	}

	.sidebar-content.is-collapsed .sidebar-collapsible-content {
		display: none;
	}

	.note-content img {
		max-width: 100%;
	}

	#header-title {
		margin-top: 0;
	}

	.icon-btn.favorited {
		opacity: 1;
		visibility: visible;
		color: #ffc107;
	}

	.icon-btn.unarchive-mode {
		color: var(--primary-color);
	}

	.note-view-actions {
		display: flex;
		gap: 0.25rem;
		padding-left: 0.5rem;
	}

	.note.editing .note-view-actions {
		display: none;
	}

	#notes-section.waterfall-mode #notes-container {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(var(--waterfall-card-width), 1fr));
		grid-auto-rows: 1px;
		gap: 0.5rem 1rem;
		align-items: start;
	}

	#notes-section.waterfall-mode .note {
		width: 100%;
		margin-bottom: 0;
	}

	#notes-section.waterfall-mode .note-content {
		word-break: break-all;
	}

	.waterfall-more-btn {
		display: none;
	}

	#notes-section.waterfall-mode .waterfall-more-btn {
		display: none;
		margin-left: auto;
	}



	#notes-section.waterfall-mode .attachment-img img {
		border-radius: 0;
	}

	#notes-section.waterfall-mode .attachments-grid {
		border-radius: 0;
	}

	.popover-menu {
		position: fixed;
		z-index: 100;
		display: flex;
		gap: 0.5rem;
		padding: 0.5rem;
		background-color: var(--surface-color);
		border: 1px solid var(--border-color);
		border-radius: 8px;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		opacity: 0;
		visibility: hidden;
		transform: translateY(-10px) scale(0.95);
		transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
	}

	.popover-menu.visible {
		opacity: 1;
		visibility: visible;
		transform: translateY(0) scale(1);
	}

	#settings-modal-box {
		max-width: 500px;
		text-align: left;
		padding: 0;
	}

	.settings-header {
		cursor: grab;
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 1rem 1.5rem;
		border-bottom: 1px solid var(--border-color);
	}

	.settings-header:active {
		cursor: grabbing;
	}

	.settings-header h3 {
		margin: 0;
	}

	#close-settings-btn {
		font-size: 1.5rem;
	}

	.settings-content {
		padding: 1rem 1.5rem 1.5rem;
		max-height: 70vh;
		overflow-y: auto;
	}

	.setting-group {
		margin-bottom: 2rem;
	}

	.setting-group:last-child {
		margin-bottom: 0;
	}

	.setting-group h4 {
		margin-top: 0;
		margin-bottom: 1rem;
		color: var(--text-secondary);
		font-size: 1rem;
		text-transform: uppercase;
	}

	.setting-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: .5rem;
		padding-left: 1rem;
	}

	.setting-item label {
		font-weight: 500;
	}

	.setting-item input[type="text"] {
		width: 60%;
		padding: 6px 10px;
		border-radius: 4px;
		border: 1px solid var(--border-color);
		background-color: var(--bg-color);
		color: var(--text-color);
	}

	.setting-item input[type="range"] {
		width: 50%;
	}

	.toggle-switch {
		position: relative;
		display: inline-block;
		width: 50px;
		height: 28px;
		-webkit-appearance: none;
		appearance: none;
		background-color: var(--border-color);
		border-radius: 28px;
		cursor: pointer;
		transition: background-color 0.2s;
	}

	.toggle-switch::before {
		content: "";
		position: absolute;
		top: 3px;
		left: 4px;
		width: 22px;
		height: 22px;
		background-color: white;
		border-radius: 50%;
		transition: transform 0.2s;
	}

	.toggle-switch:checked {
		background-color: var(--primary-color);
	}

	.toggle-switch:checked::before {
		transform: translateX(21px);
	}

	.btn-sm {
		padding: 4px 8px;
		font-size: 0.8rem;
	}

	body.custom-background {
		position: relative;
		z-index: 0;
	}

	body.custom-background::before {
		content: '';
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-image: var(--bg-image-url);
		background-size: cover;
		background-position: center;
		background-attachment: fixed;
		opacity: var(--bg-opacity, 1);
		z-index: -1;
	}

	#app-layout-container.glass-effect,
	.auth-form.glass-effect {
		background: rgba(255, 255, 255, 0.2);
		backdrop-filter: blur(var(--bg-blur, 0px));
		border: 1px solid rgba(255, 255, 255, 0.3);
		border-radius: 12px;
	}

	body[data-theme='dark'] #app-layout-container.glass-effect,
	body[data-theme='dark'] .auth-form.glass-effect {
		background: rgba(21, 31, 49, 0.4);
		border: 1px solid rgba(255, 255, 255, 0.1);
	}

	#app-layout-container.no-sidebars {
		grid-template-columns: 1fr !important;
	}

	#app-layout-container.no-sidebars #left-sidebar {
		display: none !important;
	}

	#app-layout-container.no-sidebars #main-content-area .container {
		max-width: 1000px;
	}

	/* --- 鍏ㄥ睆缂栬緫鍣ㄨ鍥惧垏鎹㈡寜閽殑婵€娲荤姸鎬?--- */
	.toolbar-right .icon-btn.active {
		color: var(--primary-color);
		background-color: rgba(54, 124, 255, 0.1);
	}

	body[data-theme='dark'] .toolbar-right .icon-btn.active {
		background-color: rgba(66, 153, 225, 0.15);
		/* 閫傞厤娣辫壊妯″紡 */
	}

	.toolbar-selector {
		background-color: transparent;
		border: 1px solid var(--border-color);
		color: var(--text-color);
		padding: 4px 8px;
		font-size: 0.8rem;
		cursor: pointer;
		border-radius: 4px;
		-webkit-appearance: none;
		appearance: none;
		padding-right: 20px;
		background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='var(--text-color)' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
		background-repeat: no-repeat;
		background-position: right 0.5rem center;
		background-size: 1em;
	}

	#fs-color-popover {
		top: calc(100% + 8px);
		left: 0;
		width: 180px;
	}

	.header-actions .icon-btn.active {
		color: var(--primary-color);
		background-color: rgba(54, 124, 255, 0.1);
	}

	body[data-theme='dark'] .header-actions .icon-btn.active {
		background-color: rgba(66, 153, 225, 0.15);
	}

	#heatmap-container-wrapper {
		border: none !important;
		min-height: 120px;
	}

	#heatmap-scroll-container {
		overflow-x: auto;
		-webkit-overflow-scrolling: touch;
	}

	#heatmap-grid {
		display: grid;
		grid-template-rows: repeat(7, 1fr);
		grid-auto-flow: column;
		gap: 3px;
		padding-bottom: 5px;
	}

	.heatmap-day {
		aspect-ratio: 1 / 1;
		min-width: 16px;
		background-color: var(--border-color);
		border-radius: 2px;
		cursor: pointer;
		transition: transform 0.1s ease-in-out;
	}

	.heatmap-day:hover {
		transform: scale(1.2);
		box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
	}

	.heatmap-day[data-level="1"] {
		background-color: rgba(var(--primary-color-rgb), 0.3);
	}

	.heatmap-day[data-level="2"] {
		background-color: rgba(var(--primary-color-rgb), 0.5);
	}

	.heatmap-day[data-level="3"] {
		background-color: rgba(var(--primary-color-rgb), 0.75);
	}

	.heatmap-day[data-level="4"] {
		background-color: rgba(var(--primary-color-rgb), 1);
	}

	body[data-theme='dark'] .heatmap-day {
		background-color: rgba(255, 255, 255, 0.08);
	}

	body[data-theme='dark'] .heatmap-day[data-level="1"] {
		background-color: rgba(var(--primary-color-rgb), 0.15);
	}

	body[data-theme='dark'] .heatmap-day[data-level="2"] {
		background-color: rgba(var(--primary-color-rgb), 0.4);
	}

	body[data-theme='dark'] .heatmap-day[data-level="3"] {
		background-color: rgba(var(--primary-color-rgb), 0.7);
	}

	body[data-theme='dark'] .heatmap-day[data-level="4"] {
		background-color: rgba(var(--primary-color-rgb), 1);
	}

	#heatmap-tooltip {
		position: absolute;
		display: none;
		padding: 5px 10px;
		background-color: var(--text-color);
		color: var(--surface-color);
		border-radius: 4px;
		font-size: 0.8rem;
		font-weight: 500;
		white-space: nowrap;
		z-index: 1001;
		pointer-events: none;
		transform: translate(-50%, -120%);
	}

	/* ========================================
	   移动端优化样式
	   ======================================== */

	/* 遮罩层 - 用于移动端下拉菜单 */
	.dropdown-overlay {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: rgba(0, 0, 0, 0.5);
		z-index: 99;
		opacity: 0;
		transition: opacity 0.3s ease;
	}

	.dropdown-overlay.visible {
		display: block;
		opacity: 1;
	}

	/* 平板和手机端优化 (768px 及以下) */
	@media (max-width: 768px) {

		/* 标签下拉菜单 - 移动端居中显示 */
		.tag-dropdown-container {
			position: fixed !important;
			top: 50% !important;
			left: 50% !important;
			transform: translate(-50%, -50%);
			margin-top: 0 !important;
			width: calc(100vw - 2rem) !important;
			max-width: 320px !important;
			z-index: 100;
			box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
		}

		/* 增大移动端按钮触摸目标 */
		.icon-btn {
			min-width: 44px;
			min-height: 44px;
			width: 44px;
			height: 44px;
		}

		.icon-btn svg {
			width: 22px;
			height: 22px;
		}

		/* 工具栏优化 */
		.form-actions {
			gap: 0.75rem;
		}

		.toolbar-group-left,
		.toolbar-group-right {
			gap: 0.5rem;
		}

		/* 文本输入框 - 防止移动端自动缩放 */
		textarea,
		input[type="text"],
		input[type="search"],
		#tag-search-input {
			font-size: 16px !important;
		}

		/* 标签下拉列表项 - 增大触摸目标 */
		#tag-dropdown-list li {
			padding: 12px 16px;
			font-size: 1rem;
			min-height: 44px;
			display: flex;
			align-items: center;
		}

		/* 侧边栏标签项 - 增大触摸目标 */
		.tag-item,
		.timeline-item {
			padding: 10px 12px;
			min-height: 44px;
		}

		/* 笔记卡片优化 */
		.note {
			padding: 0.75rem;
		}

		.note-actions button,
		.edit-actions button {
			min-width: 40px;
			min-height: 40px;
		}

		/* 优化主题色板 */
		.color-swatch {
			width: 36px;
			height: 36px;
		}

		/* 设置面板优化 */
		.sidebar-tab-btn {
			width: 64px !important;
			height: 64px !important;
		}

		/* 优化更多菜单 */
		.more-menu-item {
			padding: 12px 16px;
			min-height: 48px;
		}
	}

	/* 小屏手机优化 (480px 及以下) */
	@media (max-width: 480px) {

		/* 进一步优化标签下拉菜单 */
		.tag-dropdown-container {
			width: calc(100vw - 1rem) !important;
			max-width: none !important;
		}

		/* 工具栏按钮在极小屏幕上略微缩小 */
		.icon-btn {
			min-width: 40px;
			min-height: 40px;
			width: 40px;
			height: 40px;
		}

		.icon-btn svg {
			width: 20px;
			height: 20px;
		}

		/* 减小工具栏间距 */
		.form-actions {
			gap: 0.5rem;
		}

		.toolbar-group-left,
		.toolbar-group-right {
			gap: 0.35rem;
		}

		/* 笔记卡片进一步优化 */
		.note {
			padding: 0.5rem 0.75rem;
		}

		/* 优化笔记操作按钮 */
		.note-actions,
		.edit-actions {
			gap: 0.15rem;
		}

		/* 主题色板在小屏幕上调整 */
		.color-palette {
			grid-template-columns: repeat(3, 1fr);
		}

		.color-swatch {
			width: 32px;
			height: 32px;
		}
	}

	/* 触摸设备优化 */
	@media (hover: none) and (pointer: coarse) {

		/* 移除 hover 效果,使用 active 状态 */
		.icon-btn:hover {
			transform: none;
		}

		.icon-btn:active {
			transform: scale(0.95);
			background-color: var(--border-color);
		}

		.tag-item:hover,
		.timeline-item:hover {
			background-color: transparent;
		}

		.tag-item:active,
		.timeline-item:active {
			background-color: var(--border-color);
		}

		/* 优化按钮点击反馈 */
		button:active,
		.btn:active {
			transform: scale(0.97);
		}
	}

	#note-form.split-mode #main-editor-container {
		display: flex;
		gap: 1rem;
		margin-bottom: 1rem;
	}

	#note-form.split-mode #note-input,
	#note-form.split-mode #main-edit-preview {
		flex: 1;
		min-width: 0;
		margin-bottom: 0;
	}

	#note-form.split-mode #main-edit-preview {
		display: block;
		min-height: 200px;
		border: 1px solid var(--border-color);
		padding: 12px;
		border-radius: 0;
		background-color: var(--bg-color);
	}

	.note.split-mode .edit-area {
		display: flex;
		gap: 1rem;
		margin-bottom: 1rem;
	}

	.note.split-mode .edit-area .edit-textarea,
	.note.split-mode .edit-area .edit-preview {
		flex: 1;
		min-width: 0;
		margin-bottom: 0;
	}

	.note.split-mode .edit-preview {
		display: block;
		min-height: 200px;
		border: 1px solid var(--border-color);
		padding: 12px;
		border-radius: 0;
		background-color: var(--bg-color);
	}

	#main-split-toggle-btn.active,
	.md-split-toggle-btn.active {
		color: var(--primary-color);
		background-color: rgba(54, 124, 255, 0.1);
	}

	body.loading #app-layout-container,
	body.loading #auth-container {
		visibility: hidden;
	}

	body.loading #initial-loader {
		display: flex !important;
		opacity: 1 !important;
	}

	/* --- 鏃ュ巻缁勪欢鏍峰紡 --- */
	#calendar-wrapper {
		padding: 0.5rem;
	}

	.calendar-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	#calendar-month-year {
		font-weight: 600;
		font-size: 0.9rem;
		color: var(--primary-color);
	}

	.calendar-nav-btn {
		background: none;
		border: none;
		cursor: pointer;
		padding: 0.4rem;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		color: var(--text-secondary);
		transition: background-color 0.2s, color 0.2s;
	}

	.calendar-nav-btn:hover {
		background-color: var(--border-color);
		color: var(--text-color);
	}

	.calendar-nav-btn:disabled {
		opacity: 0.3;
		cursor: not-allowed;
		background-color: transparent !important;
	}

	body[data-theme='dark'] .calendar-nav-btn:hover {
		background-color: #4a5568;
	}

	.calendar-grid {
		display: grid;
		grid-template-columns: repeat(7, 1fr);
		gap: .25rem;
	}

	.calendar-date {
		font-size: 0.875rem;
	}

	.calendar-day-name,
	.calendar-date-wrapper {
		text-align: center;
		width: 1.5rem;
		font-size: 0.875rem;
		aspect-ratio: 1 / 1;
		position: relative;
	}

	.calendar-day-name {
		font-weight: 500;
		color: var(--text-secondary);
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.calendar-date-wrapper {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
	}

	.calendar-date {
		background-color: transparent;
		border: none;
		padding: 0;
		width: 100%;
		height: 100%;
		border-radius: 50%;
		cursor: pointer;
		transition: all 0.2s ease;
		color: var(--text-color);
		display: flex;
		align-items: center;
		justify-content: center;
		position: relative;
		z-index: 1;
	}

	.calendar-date.is-other-month {
		color: var(--text-secondary);
		opacity: 0.5;
		cursor: default;
		pointer-events: none;
	}

	.calendar-date:not(.is-other-month):hover {
		background-color: var(--primary-hover);
		color: white !important;
		transform: scale(1.1);
	}

	.calendar-date.is-selected {
		background-color: var(--primary-color) !important;
		color: white !important;
		box-shadow: 0 0 0 2px var(--surface-color), 0 0 0 4px var(--primary-color);
	}

	.calendar-date.is-selected:hover {
		transform: none;
	}

	.calendar-date[data-level="1"] {
		color: rgba(var(--primary-color-rgb), 0.6);
	}

	.calendar-date[data-level="2"] {
		color: rgba(var(--primary-color-rgb), 0.8);
	}

	.calendar-date[data-level="3"] {
		color: rgba(var(--primary-color-rgb), 1);
		font-weight: 600;
	}

	.calendar-date[data-level="4"] {
		color: rgba(var(--primary-color-rgb), 1);
		font-weight: 600;
	}

	.calendar-dots-container {
		position: absolute;
		bottom: 2px;
		left: 0;
		right: 0;
		display: flex;
		justify-content: center;
		align-items: center;
		gap: 2px;
		pointer-events: none;
	}

	.calendar-dot {
		width: 3px;
		height: 3px;
		border-radius: 50%;
		background-color: var(--primary-color);
		opacity: 0.4;
		transition: opacity 0.2s ease;
	}

	.calendar-dot:nth-child(odd) {
		opacity: 0.9;
	}

	#calendar-tooltip {
		position: absolute;
		display: none;
		padding: 4px 8px;
		background-color: var(--text-color);
		color: var(--surface-color);
		border-radius: 4px;
		font-size: 0.75rem;
		font-weight: 500;
		white-space: nowrap;
		z-index: 1001;
		pointer-events: none;
		transform: translate(-50%, -120%);
	}

	#app-layout-container.attachments-mode {
		grid-template-columns: 1fr;
	}

	#app-layout-container.attachments-mode #left-sidebar {
		display: none !important;
	}

	#app-layout-container.attachments-mode #main-content-area .container {
		max-width: 1200px;
		width: 90%;
	}

	#attachments-viewer {
		padding: 1rem 0;
	}

	.attachments-header {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 1rem;
	}

	.attachments-header h3 {
		margin: 0;
		font-size: 1.5rem;
	}

	.attachments-tabs {
		display: flex;
		gap: 0.5rem;
		background-color: var(--bg-color);
		padding: 0.25rem;
		border-radius: 8px;
	}

	.tab-btn {
		padding: 0.5rem 1rem;
		font-size: 0.9rem;
		font-weight: 500;
		border: none;
		border-radius: 6px;
		background-color: transparent;
		color: var(--text-secondary);
		cursor: pointer;
		transition: all 0.2s ease;
	}

	.tab-btn:hover {
		background-color: var(--surface-color);
		color: var(--text-color);
	}

	.tab-btn.active {
		background-color: var(--primary-color);
		color: white;
		box-shadow: 0 2px 8px rgba(var(--primary-color-rgb), 0.3);
	}

	#attachments-content.loading-state {
		display: flex;
		justify-content: center;
		padding: 4rem 0;
	}

	.attachment-month-group {
		margin-bottom: 2.5rem;
	}

	.month-header {
		font-size: 1.2rem;
		font-weight: 600;
		margin-bottom: 1rem;
		margin-top: 1rem;
		padding-bottom: 0.5rem;
		border-bottom: 1px solid var(--border-color);
		color: var(--primary-color);
	}

	.attachments-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
		gap: 1rem;
	}

	.attachment-item {
		text-decoration: none;
		position: relative;
		border-radius: 8px;
		overflow: hidden;
		background-color: var(--surface-color);
		border: 1px solid var(--border-color);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
		transition: transform 0.2s ease, box-shadow 0.2s ease;
		display: flex;
		flex-direction: column;
	}

	.attachment-item:hover .share-file-btn {
		opacity: 1;
		visibility: visible;
		transform: scale(1);
	}

	.attachment-item:hover {
		transform: translateY(-4px);
		box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
	}

	.attachment-item-image .preview {
		width: 100%;
		aspect-ratio: 4 / 3;
		object-fit: cover;
		background-color: var(--bg-color);
	}

	.attachment-item-file {
		padding: 1rem;
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
		align-items: center;
		text-align: center;
	}

	.file-icon {
		font-size: 2.5rem;
	}

	.file-info .name {
		font-weight: 500;
		color: var(--text-color);
		word-break: break-all;
	}

	.file-info .size {
		font-size: 0.8rem;
		color: var(--text-secondary);
	}

	.more-actions-container {
		position: relative;
	}

	.more-menu-popover {
		display: none;
		position: absolute;
		top: calc(100% + 8px);
		right: 0;
		z-index: 101;
		width: 150px;
		background-color: var(--surface-color);
		border: 1px solid var(--border-color);
		border-radius: 8px;
		box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
		padding: 0.3125rem;
		display: flex;
		flex-direction: column;
		gap: 0.25rem;
		opacity: 0;
		visibility: hidden;
		transform: translateY(-10px);
		transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
	}

	.more-menu-popover.visible {
		display: flex;
		opacity: 1;
		visibility: visible;
		transform: translateY(0);
	}

	.more-menu-item {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		width: 100%;
		background-color: transparent;
		border: none;
		text-align: left;
		font-size: 0.9rem;
		font-weight: 500;
		color: var(--text-color);
		cursor: pointer;
		border-radius: 4px;
		transition: background-color 0.2s ease;
		white-space: nowrap;
	}

	.more-menu-item:hover {
		background-color: var(--border-color);
	}

	.more-menu-item svg {
		width: 20px;
		height: 20px;
		flex-shrink: 0;
		fill: currentColor;
	}

	#theme-toggle-btn.more-menu-item {
		justify-content: flex-start;
		width: 100%;
		height: auto;
		border-radius: 4px;
	}

	#theme-toggle-btn {
		width: 100%;
		height: auto;
		border-radius: 4px;
		justify-content: flex-start;
	}

	#notes-section.date-grouping-enabled .date-group {
		margin-bottom: 1.5rem;
	}

	#notes-section.date-grouping-enabled .date-group-header {
		display: flex;
		align-items: center;
		cursor: pointer;
		margin-bottom: 1rem;
		position: sticky;
		top: -1px;
		z-index: 1;
	}

	#notes-section.date-grouping-enabled .date-group-header .date-divider {
		flex-grow: 1;
		display: flex;
		align-items: center;
		overflow: hidden;
		justify-content: center;
	}

	#notes-section.date-grouping-enabled .date-group-header .line {
		height: 1px;
		width: 100%;
		background: var(--border-color);
	}

	#notes-section.date-grouping-enabled .date-group-header .line:first-child {
		background: linear-gradient(to right, transparent, var(--border-color));
	}

	#notes-section.date-grouping-enabled .date-group-header .line:last-child {
		background: linear-gradient(to left, transparent, var(--border-color));
	}

	#notes-section.date-grouping-enabled .date-group-header .date-label {
		flex-shrink: 0;
		font-weight: 600;
		color: var(--text-secondary);
	}

	#notes-section.date-grouping-enabled .date-group-header .toggle-icon {
		font-size: 1.2em;
		width: 1em;
		height: 1em;
		color: var(--text-secondary);
		transition: transform 0.2s ease-in-out;
		flex-shrink: 0;
		margin-right: 0.25rem;
		transform-origin: center;
		will-change: transform;
	}

	#notes-section.date-grouping-enabled .date-group-header .toggle-icon.expanded {
		transform: rotate(0deg);
	}

	#notes-section.date-grouping-enabled .date-group-header .toggle-icon:not(.expanded) {
		transform: rotate(-90deg);
	}

	#notes-section.date-grouping-enabled .date-group.collapsed .date-group-content {
		display: none;
	}

	.note-content img,
	.note-content video {
		max-height: 450px;
		max-width: 100%;
		width: auto;
		object-fit: contain;
		display: block;
		margin: 0.5em auto;
		background-color: var(--bg-color);
		border-radius: var(--border-radius-base);
	}

	.pinned-notes-container {
		margin-bottom: 1rem;
	}

	.pinned-section-header {
		font-size: 0.9rem;
		text-align: center;
		font-weight: 600;
		color: var(--text-secondary);
		text-transform: uppercase;
		letter-spacing: 0.05em;
		margin-bottom: 1rem;
	}

	.attachment-img,
	.attachment-link {
		/* 涓哄唴閮ㄧ粷瀵瑰畾浣嶇殑鎸夐挳鎻愪緵鍙傜収鐗?*/
		position: relative;
	}

	.share-file-btn {
		position: absolute;
		bottom: 4px;
		right: 4px;
		z-index: 2;
		background-color: rgba(0, 0, 0, 0.4);
		color: white;
		opacity: 0;
		/* 榛樿隐藏 */
		visibility: hidden;
		transform: scale(0.8);
		transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
	}

	.share-file-btn:hover {
		background-color: rgba(0, 0, 0, 0.6);
	}

	/* 褰撻紶鏍囨偓鍋滃湪鐖跺鍣ㄤ笂鏃舵樉绀烘寜閽?*/
	.attachment-img:hover .share-file-btn,
	.attachment-link:hover .share-file-btn {
		opacity: 1;
		visibility: visible;
		transform: scale(1);
	}

	.share-file-btn.copied {
		background-color: var(--accent-color);
	}

	.timestamp-toggle-label {
		display: flex;
		align-items: center;
		gap: 0.35rem;
		font-size: 0.8rem;
		color: var(--text-secondary);
		cursor: pointer;
		padding: 4px 8px;
		border-radius: 4px;
		transition: background-color 0.2s ease;
		margin-right: auto;
	}

	.timestamp-toggle-label:hover {
		background-color: var(--border-color);
	}

	.timestamp-toggle-label input {
		margin: 0;
	}
</style>

<body class='loading' data-theme='dark'>
	<div id='initial-loader'>
		<div class='spinner'></div>
	</div>
	<!-- Login Screen -->
	<div id='auth-container'>
		<form id='login-form' class='auth-form'>
			<h3>Fly Notes</h3>
			<div id='login-error'></div>
			<input type='text' id='username' placeholder='Username' required>
			<input type='password' id='password' placeholder='Password' required>
			<button type='submit' id='login-btn'>Login</button>
		</form>
	</div>
	<!-- 涓€涓寘瑁逛笁鏍忕殑瀹瑰櫒 -->
	<div id='app-layout-container'>

		<!-- 宸︿晶鏍?-->
		<aside id='left-sidebar'>
			<!-- --- 鍏ㄥ眬鎼滅储妗?--- -->
			<div class='sidebar-search-container'>
				<svg class='search-icon' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'>
					<path
						d='M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'>
					</path>
				</svg>
				<input type='search' id='global-search-input' placeholder='Search...'>
				<button id='clear-search-btn' class='icon-btn' style='display: none;' title='Clear'>
					<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'>
						<path
							d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'>
						</path>
					</svg>
				</button>
			</div>

			<!-- --- 缁熻鍗＄墖 --- -->
			<div id='stats-card' class='sidebar-content'>
				<div class='stat-item'>
					<span id='stats-days' class='stat-value'>--</span>
					<span class='stat-label'>Days</span>
				</div>
				<div class='stat-item'>
					<span id='stats-memos' class='stat-value'>--</span>
					<span class='stat-label'>Memos</span>
				</div>
				<div class='stat-item'>
					<span id='stats-tags' class='stat-value'>--</span>
					<span class='stat-label'>Tags</span>
				</div>
			</div>

			<div id='calendar-wrapper' class='sidebar-content'>
			</div>
			<div id='heatmap-container-wrapper' class='sidebar-content'>
				<div class='spinner'></div>
			</div>

			<div class='sidebar-content' id='tags-section-wrapper'>
				<h4>
					<span>Tags</span>
					<div class='sidebar-header-actions'>
						<button id='clear-tags-filter-btn' class='icon-btn' title='Clear tag filter'></button>
						<button class='sidebar-toggle-btn' data-target='tags-container'>
							<svg class='toggle-icon' xmlns='http://www.w3.org/2000/svg' height='24px'
								viewBox='0 0 24 24' width='24px' fill='currentColor'>
								<path d='M0 0h24v24H0V0z' fill='none' />
								<path d='M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z' />
							</svg>
						</button>
					</div>
				</h4>
				<div id='tags-container' class='sidebar-collapsible-content'>
					<div class='spinner'></div>
				</div>
			</div>

			<div class='sidebar-content' id='timeline-section-wrapper'>
				<h4>
					<span>Timeline</span>
					<div class='sidebar-header-actions'>
						<button id='clear-filter-btn' class='icon-btn' title='Show All Notes'></button>
						<button class='sidebar-toggle-btn' data-target='timeline-container'>
							<svg class='toggle-icon' xmlns='http://www.w3.org/2000/svg' height='24px'
								viewBox='0 0 24 24' width='24px' fill='currentColor'>
								<path d='M0 0h24v24H0V0z' fill='none' />
								<path d='M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z' />
							</svg>
						</button>
					</div>
				</h4>
				<div id='timeline-container' class='sidebar-collapsible-content'>
					<div class='spinner'></div>
				</div>
			</div>
		</aside>

		<!-- 涓棿涓诲唴瀹瑰尯 -->
		<main id='main-content-area'>
			<div class='container'>
				<div id='app-container'>
					<header class='app-header'>
						<h3 id='header-title'>Flying ...</h3>
						<div class='header-actions'>
							<button type='button' id='refresh-btn' class='icon-btn' title='Refresh'>
								<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'>
									<path
										d='M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z'>
									</path>
								</svg>
							</button>
							<button id='waterfall-toggle-btn' class='icon-btn' title='Toggle waterfall mode'>
								<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px'
									fill='currentColor'>
									<path d='M0 0h24v24H0V0z' fill='none' />
									<path d='M10 18h5V5h-5v13zm-6 0h5V5H4v13zM16 5v13h5V5h-5z' />
								</svg>
							</button>
							<button id='wide-mode-toggle-btn' class='icon-btn' title='Toggle wide mode'>
								<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'>
									<path
										d='M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z'>
									</path>
								</svg>
							</button>

							<div id='more-actions-container' class='more-actions-container'>
								<button id='more-actions-btn' class='icon-btn' title='More options'>
									<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24'
										width='24px' fill='currentColor'>
										<path d='M0 0h24v24H0V0z' fill='none' />
										<path
											d='M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z' />
									</svg>
								</button>

								<div id='more-menu-popover' class='more-menu-popover'>
									<button id='settings-btn' class='more-menu-item'>
										<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24'
											width='24px' fill='currentColor'>
											<path d='M0 0h24v24H0V0z' fill='none' />
											<path
												d='M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.09-.7-1.71-.98L14.82 2.8c-.05-.23-.26-.4-.5-.4h-4c-.25 0-.46.17-.5.4L9.19 5.3c-.62.27-1.19.58-1.71.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.09.7 1.71.98l.37 2.66c.05.23.26.4.5.4h4c.25 0 .46-.17-.5-.4l.37-2.66c.62-.28 1.19-.58 1.71-.98l2.49 1c.22.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z' />
										</svg>
										<span>Settings</span>
									</button>
									<button id='theme-toggle-btn' class='more-menu-item'></button>

									<button id='theme-color-btn' class='more-menu-item'>
										<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24'
											width='24px' fill='currentColor'>
											<path d='M0 0h24v24H0V0z' fill='none' />
											<path
												d='M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z' />
										</svg>
										<span>Theme Color</span>
									</button>
									<button id='logout-btn' class='more-menu-item'>
										<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'>
											<path
												d='M16 17v-3H9v-2h7V9l4 4-4 4zm-5-3h-1v-2h1v2zm-2 3h-1v-2h1v2zm-7-11v16h14v-2H4V4h10V2H2v16z'>
											</path>
										</svg>
										<span>Logout</span>
									</button>
								</div>
							</div>
						</div>
					</header>

					<form id='note-form'>
						<div id='main-editor-container'>
							<textarea id='note-input' placeholder='Write in Markdown...' rows='3'></textarea>
							<div id='main-edit-preview' class='edit-preview note-content'></div>
						</div>

						<div class='form-actions'>
							<!-- 宸︿晶宸ュ叿缁?-->
							<div class='toolbar-group-left'>
								<button type='button' id='insert-tag-btn' class='icon-btn' title='Insert tag (#)'>
									<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'
										fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round'
										stroke-linejoin='round' class='lucide lucide-hash size-5'
										data-darkreader-inline-stroke=''
										style='--darkreader-inline-stroke: currentColor;'>
										<line x1='4' x2='20' y1='9' y2='9'></line>
										<line x1='4' x2='20' y1='15' y2='15'></line>
										<line x1='10' x2='8' y1='3' y2='21'></line>
										<line x1='16' x2='14' y1='3' y2='21'></line>
									</svg>
								</button>
								<div id='tag-dropdown' class='tag-dropdown-container'>
									<input type='text' id='tag-search-input' placeholder='Search or select tag...'>
									<ul id='tag-dropdown-list'></ul>
								</div>
								<button type='button' id='insert-image-btn' class='icon-btn' title='Insert image'>
									<svg xmlns='http://www.w3.org/2000/svg' height='20px' viewBox='0 0 24 24'
										width='20px' fill='currentColor'>
										<path d='M0 0h24v24H0V0z' fill='none' />
										<path
											d='M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z' />
									</svg>
								</button>
								<!--							<button type='button' id='insert-code-btn' class='icon-btn' title='Insert code'>-->
								<!--								<svg xmlns='http://www.w3.org/2000/svg' height='20px' viewBox='0 0 24 24' width='20px'-->
								<!--										 fill='currentColor'>-->
								<!--									<path d='M0 0h24v24H0V0z' fill='none' />-->
								<!--									<path-->
								<!--										d='M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z' />-->
								<!--								</svg>-->
								<!--							</button>-->
								<button type='button' id='select-files-btn' class='icon-btn' title='Select files'>
									<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'>
										<path
											d='M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z'>
										</path>
									</svg>
								</button>
								<input type='file' id='note-file' multiple style='display:none;'>

							</div>
							<!-- 鍙充晶宸ュ叿缁?-->
							<div class='toolbar-group-right'>
								<button type='button' id='clear-editor-btn' class='icon-btn' title='Clear Editor'>
									<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24"
										width="24px" fill="currentColor">
										<path d="M0 0h24v24H0V0z" fill="none" />
										<path
											d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" />
									</svg>
								</button>
								<button type='button' id='enter-fullscreen-btn' class='icon-btn'
									title='Fullscreen Editor'>
									<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'>
										<path
											d='M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z'>
										</path>
									</svg>
								</button>
								<button type='button' id='main-preview-toggle-btn' class='icon-btn'
									title='Toggle Preview'>
									<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'
										stroke-width='2' stroke='currentColor' fill='none' stroke-linecap='round'
										stroke-linejoin='round'>
										<path stroke='none' d='M0 0h24v24H0z' fill='none' />
										<circle cx='12' cy='12' r='2' />
										<path
											d='M22 12c-2.667 4.667 -6 7 -10 7s-7.333 -2.333 -10 -7c2.667 -4.667 6 -7 10 -7s7.333 2.333 10 7' />
									</svg>
								</button>
								<button type='button' id='main-split-toggle-btn' class='icon-btn'
									title='Toggle Split View'>
									<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24'
										width='24px' fill='currentColor'>
										<path d='M0 0h24v24H0V0z' fill='none' />
										<path
											d='M3 15h8v-2H3v2zm0 4h8v-2H3v2zm0-8h8V9H3v2zm0-6v2h8V5H3zm10 0h8v14h-8V5z' />
									</svg>
								</button>
								<button type='submit' id='submit-btn' style='margin-left: 8px'>Save</button>
							</div>
						</div>
						<div id='file-list-display' class='file-list-display'></div>
					</form>

					<div id='notes-section'>
						<div id='refresh-loader' class='loading-indicator' style='display: none;'>
							<div class='spinner'></div>
						</div>
						<div id='notes-container'></div>
					</div>
					<div id='scroll-loader' class='loading-indicator' style='display: none;'>Loading more...</div>
				</div>

				<!-- 闄勪欢娴忚椤甸潰瀹瑰櫒 -->
				<div id="attachments-viewer" style="display: none;">
					<header class="attachments-header">
						<h3>Files</h3>
						<div class="attachments-tabs">
							<button class="tab-btn active" data-filter="all">✓ All</button>
							<button class="tab-btn" data-filter="image">🖼️ Images</button>
							<button class="tab-btn" data-filter="video">🎬 Videos</button>
							<button class="tab-btn" data-filter="file">📎 Files</button>
						</div>
					</header>
					<div id="attachments-content" class="loading-state">
						<div class="spinner"></div>
					</div>
					<div id="attachments-pagination"
						style="display: none; justify-content: center; align-items: center; gap: 1rem; padding: 2rem 1rem; border-top: 1px solid var(--border-color); width: 100%; clear: both;">
					</div>
				</div>

			</div>
		</main>

		<aside id='right-sidebar'>
			<div class='sidebar-buttons-group'>
				<button id='home-tab-btn' class='sidebar-tab-btn active' data-tab-name='home' title='Home'>
					<svg xmlns='http://www.w3.org/2000/svg' height='28px' viewBox='0 0 24 24' width='28px'
						fill='currentColor'>
						<path d='M0 0h24v24H0V0z' fill='none' />
						<path d='M12 5.69l5 4.5V18h-2v-6H9v6H7v-7.81l5-4.5M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z' />
					</svg>
					<span>Home</span>
				</button>
				<button id='favorites-tab-btn' class='sidebar-tab-btn' data-tab-name='favorites' title='Favorites'>
					<svg xmlns='http://www.w3.org/2000/svg' height='28px' viewBox='0 0 24 24' width='28px'
						fill='currentColor'>
						<path d='M0 0h24v24H0V0z' fill='none' />
						<path
							d='M12 17.27l4.15 2.51c.76.46 1.69-.22 1.49-1.08l-1.1-4.72 3.67-3.18c.67-.58.31-1.68-.57-1.75l-4.83-.41-1.89-4.46c-.34-.81-1.5-.81-1.84 0L9.19 8.63l-4.83.41c-.88.07-1.24 1.17-.57 1.75l3.67 3.18-1.1 4.72c-.2.86.73 1.54 1.49 1.08l4.15-2.51z' />
					</svg>
					<span>Favorites</span>
				</button>
				<button id="archive-tab-btn" class="sidebar-tab-btn" data-tab-name="archive" title="Archive">
					<svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px"
						fill="currentColor">
						<path d="M0 0h24v24H0V0z" fill="none" />
						<path
							d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM6.24 5h11.52l.83 1H5.41l.83-1zM5 19V8h14v11H5zm11-5.5l-4 4-4-4 1.41-1.41L11 13.67V10h2v3.67l1.59-1.58L16 13.5z" />
					</svg>
					<span>Archive</span>
				</button>
				<button id="attachments-tab-btn" class="sidebar-tab-btn" data-tab-name="attachments"
					title="Attachments">
					<svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 0 24 24" width="28px"
						fill="currentColor">
						<path d="M0 0h24v24H0V0z" fill="none" />
						<path
							d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z" />
					</svg>
					<span>Files</span>
				</button>

			</div>
		</aside>

	</div>

	<div id='theme-color-popover' class='theme-popover'>
		<div class='color-palette'>
		</div>
		<div class='custom-color-separator'></div>
		<div class='custom-color-picker'>
			<label for='color-picker-input' class='color-picker-label' id='color-picker-label'>
				<div id='color-picker-preview' class='color-picker-preview'></div>
				<span>Custom</span>
			</label>
			<input type='color' id='color-picker-input' class='hidden-color-input'>

			<div class='hex-input-wrapper'>
				<input type='text' id='hex-color-input' class='hex-color-input' maxlength='7' placeholder='#367cff'>
			</div>
		</div>
	</div>

	<div id='note-popover-menu' class='popover-menu'>
		<button class='icon-btn' data-action='favorite' title='Favorite'>
			<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='currentColor'>
				<path d='M0 0h24v24H0V0z' fill='none' />
				<path
					d='M12 17.27l4.15 2.51c.76.46 1.69-.22 1.49-1.08l-1.1-4.72 3.67-3.18c.67-.58.31-1.68-.57-1.75l-4.83-.41-1.89-4.46c-.34-.81-1.5-.81-1.84 0L9.19 8.63l-4.83.41c-.88.07-1.24 1.17-.57 1.75l3.67 3.18-1.1 4.72c-.2.86.73 1.54 1.49 1.08l4.15-2.51z' />
			</svg>
		</button>
		<button class='icon-btn' data-action='pin' title='Pin'>
			<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' stroke-width='2'
				stroke='currentColor' fill='none' stroke-linecap='round' stroke-linejoin='round'>
				<path stroke='none' d='M0 0h24v24H0z' fill='none'></path>
				<path d='M9 4v6l-2 4v2h10v-2l-2 -4v-6'></path>
				<line x1='12' y1='16' x2='12' y2='21'></line>
				<line x1='8' y1='4' x2='16' y2='4'></line>
			</svg>
		</button>
		<button class='icon-btn' data-action='archive' title='Archive'>
			<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor">
				<path d="M0 0h24v24H0V0z" fill="none" />
				<path
					d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5L8 13.5l1.41-1.41L11 13.67V10h2v3.67l1.59-1.58L16 13.5l-4 4zM5.12 5l.83-1h12.1l.83 1H5.12z" />
			</svg>
		</button>
		<button class='icon-btn' data-action='collapse' title='Collapse'>
			<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor">
				<path d="M0 0h24v24H0V0z" fill="none" />
				<path
					d="M4 8h3V5H5v1H4v2zm0 4h2V9H4v3zm0-8h3c0-1.1-.9-2-2-2H4v2zm2 12H5v-1H4v2h2c1.1 0 2-.9 2-2h-2v1zm12-12h2v2h-2V4zm0 4h2v3h-2V8zm-8 12v-8h6v8H8zm8 0c1.1 0 2-.9 2-2h-2v2zm-8-16h6v2H8V4zM4 20c0 1.1.9 2 2 2v-2H4z" />
			</svg>
		</button>
		<button class='icon-btn' data-action='share' title='Share'>
			<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor">
				<path d="M0 0h24v24H0V0z" fill="none" />
				<path
					d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z" />
			</svg>
		</button>
		<button class='icon-btn btn-danger' data-action='delete' title='Delete Note'>
			<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='currentColor'>
				<path d='M0 0h24v24H0V0z' fill='none' />
				<path
					d='M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z' />
			</svg>
		</button>
	</div>

	<div id='custom-modal-overlay' class='custom-modal-overlay alert-modal'>
		<!-- Alert Box -->
		<div id='custom-alert-box' class='custom-modal-box'>
			<p id='custom-alert-message'></p>
			<button id='custom-alert-ok-btn' class='btn'>OK</button>
		</div>

		<!-- Confirm Box -->
		<div id='custom-confirm-box' class='custom-modal-box'>
			<p id='custom-confirm-message'></p>
			<div class='custom-modal-actions'>
				<button id='custom-confirm-cancel-btn' class='btn btn-secondary'>Cancel</button>
				<button id='custom-confirm-ok-btn' class='btn btn-danger'>Delete</button>
			</div>
		</div>
	</div>
	<!-- 鍥剧墖棰勮妯℃€佹 -->
	<div id='image-preview-modal' class='image-preview-modal'>
		<span class='image-preview-close'>&times;</span>
		<img class='image-preview-content' id='modal-image'>
		<div id='image-preview-caption'></div>
	</div>
	<div id='video-preview-modal' class='image-preview-modal'>
		<span class='video-preview-close'>&times;</span>
		<video class='image-preview-content' id='modal-video' controls autoplay muted></video>
		<div id='video-preview-caption'></div>
	</div>

	<!-- 鍏ㄥ睆缂栬緫妯℃€佹 -->
	<div id='fullscreen-editor-overlay' class='custom-modal-overlay'>
		<div id='fullscreen-editor-box' class='custom-modal-box'>
			<header id='editor-toolbar'>
				<div class='toolbar-left'>
					<select id='fs-fontsize-selector' class='toolbar-selector toolbar-btn' title='Font Size'>
						<option value=''>Size</option>
						<option style='font-size: 12px;' value='12px'>12</option>
						<option style='font-size: 14px;' value='14px'>14</option>
						<option style='font-size: 16px;' value='16px'>16</option>
						<option style='font-size: 18px;' value='18px'>18</option>
						<option style='font-size: 20px;' value='20px'>20</option>
						<option style='font-size: 24px;' value='24px'>24</option>
						<option style='font-size: 28px;' value='28px'>28</option>
						<option style='font-size: 36px;' value='36px'>36</option>
					</select>

					<div id='fs-color-picker-wrapper' style='position: relative;'>
						<button id='fs-fontcolor-btn' class='toolbar-btn' title='Font Color'>
							<span
								style='display: inline-block; width: 1em; height: 1em; border: 1px solid transparent; background-color: var(--fs-editor-color, #333); border-radius: 3px; vertical-align: middle;'></span>
						</button>
						<div id='fs-color-popover' class='theme-popover'>
							<div class='color-palette fscolor-palette'>
							</div>
						</div>
					</div>
					<button class='toolbar-btn' data-md='bold' title='Bold (Ctrl+B)'><b>B</b></button>
					<button class="toolbar-btn" data-md="underline" title="Underline"><u>U</u></button>
					<button class='toolbar-btn' data-md='italic' title='Italic (Ctrl+I)'><i>I</i></button>
					<button class='toolbar-btn' data-md='strike' title='Strikethrough'><s>S</s></button>
					<button class='toolbar-btn' data-md='link' title='Insert Link (Ctrl+K)'>Link</button>
					<button class='toolbar-btn' data-md='image' title='Insert Image'>Img</button>
					<button class='toolbar-btn' data-md='blockquote' title='Blockquote'>>_</button>
					<button class='toolbar-btn' data-md='code' title='Insert Code Block'>Code</button>
				</div>
				<div class='toolbar-right'>
					<button id='view-mode-split-btn' class='icon-btn' title='Split View'>
						<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px'
							fill='currentColor'>
							<path d='M0 0h24v24H0V0z' fill='none' />
							<path d='M3 15h8v-2H3v2zm0 4h8v-2H3v2zm0-8h8V9H3v2zm0-6v2h8V5H3zm10 0h8v14h-8V5z' />
						</svg>
					</button>
					<button id='view-mode-preview-btn' class='icon-btn' title='Preview'>
						<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'
							stroke-width='2' stroke='currentColor' fill='none' stroke-linecap='round'
							stroke-linejoin='round'>
							<path stroke='none' d='M0 0h24v24H0z' fill='none' />
							<circle cx='12' cy='12' r='2' />
							<path
								d='M22 12c-2.667 4.667 -6 7 -10 7s-7.333 -2.333 -10 -7c2.667 -4.667 6 -7 10 -7s7.333 2.333 10 7' />
						</svg>
					</button>
					<button id='fs-save-btn' class='btn btn-primary'>Save</button>
					<button id='fs-cancel-btn' class='btn btn-secondary'>Cancel</button>
				</div>
			</header>
			<div id='editor-content-area'>
				<textarea id='fs-editor-textarea'></textarea>
				<!-- --- 鍙嫋鎷界殑鍒嗗壊鏉?--- -->
				<div id='fs-editor-divider'></div>
				<div id='fs-preview-pane' class='note-content'></div>
			</div>
		</div>
	</div>

	<!-- 杩斿洖椤堕儴 -->
	<button id='back-to-top-btn' title='Back to top'>
		<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='#FFFFFF'>
			<path d='M0 0h24v24H0V0z' fill='none' />
			<path d='M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z' />
		</svg>
	</button>


	<div id='settings-modal-overlay' class='custom-modal-overlay'>
		<div id='settings-modal-box' class='custom-modal-box'>
			<header class='settings-header'>
				<h3>Settings</h3>
				<button id='close-settings-btn' class='icon-btn'>&times;</button>
			</header>
			<div class='settings-content'>
				<div class='setting-group'>
					<h4>Interface Visibility</h4>
					<div class='setting-item'>
						<label for='toggle-search-bar'>Show Search</label>
						<input type='checkbox' id='toggle-search-bar' class='toggle-switch'>
					</div>
					<div class='setting-item'>
						<label for='toggle-stats-card'>Show Stats</label>
						<input type='checkbox' id='toggle-stats-card' class='toggle-switch'>
					</div>
					<div class='setting-item'>
						<label for='toggle-calendar'>Show Calendar</label>
						<input type='checkbox' id='toggle-calendar' class='toggle-switch'>
					</div>
					<div class='setting-item'>
						<label for='toggle-heatmap'>Show Heatmap</label>
						<input type='checkbox' id='toggle-heatmap' class='toggle-switch'>
					</div>
					<div class='setting-item'>
						<label for='toggle-tags'>Show Tags</label>
						<input type='checkbox' id='toggle-tags' class='toggle-switch'>
					</div>
					<div class='setting-item'>
						<label for='toggle-timeline'>Show Timeline</label>
						<input type='checkbox' id='toggle-timeline' class='toggle-switch'>
					</div>
					<div class='setting-item'>
						<label for='toggle-right-sidebar'>Show Right Sidebar</label>
						<input type='checkbox' id='toggle-right-sidebar' class='toggle-switch'>
					</div>
					<div class='setting-item'>
						<label for='toggle-date-grouping'>Enable Date Grouping</label>
						<input type='checkbox' id='toggle-date-grouping' class='toggle-switch'>
					</div>
				</div>

				<div class='setting-group'>
					<h4>Tags Management</h4>
					<div class='setting-item' style='display: block;'>
						<div id='settings-tags-list-container'
							style='max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 5px;'>
							<ul id='settings-tags-list' style='list-style: none; padding: 0; margin: 0;'>
								<!-- Tags will be loaded here -->
							</ul>
						</div>
					</div>
				</div>

				<div class='setting-group'>
					<h4>Data & Storage</h4>
					<div class='setting-item'> <label for='bg-image-url'>Image URL</label>
						<input type='text' id='bg-image-url' placeholder='Enter image URL...'>
					</div>
					<div class='setting-item'>
						<label for='bg-image-upload'>Or Upload</label>
						<input type='file' id='bg-image-upload' accept='image/*'>
					</div>
					<div class='setting-item'>
						<label for='bg-blur-slider'>Glass Effect</label>
						<input type='range' id='bg-blur-slider' min='0' max='20' value='0'>
					</div>
					<div class='setting-item'>
						<label for='bg-opacity-slider'>Background Opacity</label>
						<input type='range' id='bg-opacity-slider' min='0' max='1' step='0.05' value='1'>
					</div>
					<div class='setting-item'>
						<label></label>
						<div class='setting-buttons-group'>
							<button id='restore-bg-btn' class='btn btn-secondary btn-sm'>Restore</button>
							<button id='clear-bg-btn' class='btn btn-secondary btn-sm'>Clear</button>
						</div>
					</div>
				</div>

				<div class='setting-group'>
					<h4>Surface</h4>
					<div class='setting-item'>
						<label for='surface-color-picker-input'>Base Color</label>
						<div style="display: flex; align-items: center; gap: 0.75rem; position: relative;">
							<label for='surface-color-picker-input' class='color-picker-label'
								id='surface-color-picker-label' title="Click to open color picker"
								style="cursor: pointer;">
								<div id='surface-color-picker-preview' class='color-picker-preview'></div>
							</label>
							<input type='color' id='surface-color-picker-input' class='hidden-color-input'>
							<div class='hex-input-wrapper'>
								<input type='text' id='surface-hex-color-input' class='hex-color-input' maxlength='7'
									placeholder='#151f31'>
							</div>
						</div>
					</div>
					<div class='setting-item'>
						<label for='surface-opacity-slider'>Opacity</label>
						<input type='range' id='surface-opacity-slider' min='0' max='1' step='0.05' value='1'>
					</div>
					<div class='setting-item'>
						<label></label>
						<div class='setting-buttons-group'>
							<button id='restore-surface-defaults-btn' class='btn btn-secondary btn-sm'>Restore
								Defaults</button>
						</div>
					</div>
				</div>

				<div class='setting-group'>
					<h4>Image Paste Upload</h4>
					<div id='image-upload-options'>
						<div class='setting-item'>
							<label for='upload-dest-local'>
								<input type='radio' id='upload-dest-local' name='upload-destination' value='local'
									checked>
								Local (via Worker & R2)
							</label>
						</div>
						<div class='setting-item'>
							<label for='upload-dest-imgur'>
								<input type='radio' id='upload-dest-imgur' name='upload-destination' value='imgur'>
								Imgur (Requires Client ID)
							</label>
						</div>
					</div>
					<div class='setting-item' id='imgur-client-id-wrapper' style='display: flex;'>
						<label for='imgur-client-id'>Imgur Client ID</label>
						<input type='text' id='imgur-client-id' placeholder='Enter your Imgur Client ID...'>
					</div>
				</div>
				<div class='setting-group'>
					<h4>Telegram Proxy</h4>
					<div class='setting-item'>
						<label for='toggle-telegram-proxy'>Enable Video&File Proxy</label>
						<input type='checkbox' id='toggle-telegram-proxy' class='toggle-switch'>
					</div>
				</div>

				<div class='setting-group'>
					<h4>Waterfall Mode</h4>
					<div class='setting-item'>
						<label for='toggle-editor-in-waterfall'>Hide Editor in Waterfall Mode</label>
						<input type='checkbox' id='toggle-editor-in-waterfall' class='toggle-switch'>
					</div>
					<div class='setting-item'>
						<label for='waterfall-width-slider'>Card Width (px)</label>
						<input type='range' id='waterfall-width-slider' min='200' max='600' step='10' value='320'>
						<span id='waterfall-width-value'>320px</span>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id='waterfall-popover-menu' class='popover-menu'>
		<button class='icon-btn' data-action='view' title='View Note'>
			<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='currentColor'>
				<path d='M0 0h24v24H0V0z' fill='none' />
				<path
					d='M12 6.5c3.79 0 7.17 2.13 8.82 5.5-1.65 3.37-5.02 5.5-8.82 5.5S4.83 15.37 3.18 12C4.83 8.63 8.21 6.5 12 6.5m0-2C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 5c1.38 0 2.5 1.12 2.5 2.5s-1.12 2.5-2.5 2.5-2.5-1.12-2.5-2.5 1.12-2.5 2.5-2.5m0-2c-2.48 0-4.5 2.02-4.5 4.5s2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5-2.02-4.5-4.5-4.5z' />
			</svg>
		</button>
		<button class='icon-btn btn-danger' data-action='delete' title='Delete Note'>
			<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='currentColor'>
				<path d='M0 0h24v24H0V0z' fill='none' />
				<path
					d='M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z' />
			</svg>
		</button>
	</div>

	<div id='heatmap-tooltip'></div>
	<div id='calendar-tooltip'></div>

	<!--	<script src="/script.js" defer></script>-->
</body>

</html>

<script>
	// --- 閰嶇疆 marked.js ---
	const renderer = new marked.Renderer();
	const originalTableRenderer = renderer.table.bind(renderer);
	const originalLinkRenderer = renderer.link.bind(renderer);
	renderer.table = (header, body) => {
		const tableHtml = originalTableRenderer(header, body);
		return `<div class='table-wrapper'>${tableHtml}</div>`;
	};
	renderer.code = function (token) {
		const code = token.text;
		const lang = token.lang;
		let result;
		if (lang && hljs.getLanguage(lang)) {
			result = hljs.highlight(code, { language: lang, ignoreIllegals: true });
		} else {
			result = hljs.highlightAuto(code);
		}
		const languageName = result.language || 'plaintext';
		const highlightedCode = result.value;
		const escapeHtml = (str) => {
			return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
		};

		const copyButtonHtml = `
							<button class='copy-code-btn' data-code='${escapeHtml(code)}' title='Copy code'>
									<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect x='9' y='9' width='13' height='13' rx='2' ry='2'></rect><path d='M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1'></path></svg>
							</button>
					`;

		const finalHtml = `
							<div class='code-block-wrapper'>
									${copyButtonHtml}
									<pre><code class='hljs language-${languageName}'>${highlightedCode}</code></pre>
							</div>
					`;
		return finalHtml;
	};
	renderer.link = function (token) {
		const { href, title, text } = token;
		let linkHtml = originalLinkRenderer.call(this, token);

		if (linkHtml.startsWith('<a ')) {
			linkHtml = linkHtml.replace('<a ', '<a target="_blank" rel="noopener noreferrer" ');
		}
		return linkHtml;
	};
	const originalImageRenderer = renderer.image.bind(renderer);
	renderer.image = function (href, title, text) {
		let imageHtml = originalImageRenderer(href, title, text);
		imageHtml = imageHtml.replace(
			'<img ',
			'<img class="note-image-attachment" style="cursor: zoom-in;" '
		);

		return imageHtml;
	};
	marked.setOptions({
		renderer: renderer,
		breaks: true, // 灏嗘崲琛岀娓叉煋涓?<br>
		gfm: true,    // 鍚敤 GitHub Flavored Markdown
		tables: true
	});

	const calendarWrapper = document.getElementById('calendar-wrapper');
	const calendarTooltip = document.getElementById('calendar-tooltip'); // 銆愭柊澧炪€?
	let notesDataByDate = new Map();
	let calendarInstance = null;

	class Calendar {
		constructor(container, dataProvider) {
			this.container = container;
			this.dataProvider = dataProvider;
			this.currentDate = new Date();
			this.today = new Date();
			this.today.setHours(0, 0, 0, 0);
			this.selectedDate = null;
			this.render();
		}

		render() {
			this.container.innerHTML = '';
			const month = this.currentDate.getMonth();
			const year = this.currentDate.getFullYear();
			const header = document.createElement('div');
			header.className = 'calendar-header';
			header.innerHTML = `
                <button id='calendar-prev' class='calendar-nav-btn' title='Previous month'>◀</button>
                <span id='calendar-month-year'>${this.currentDate.toLocaleString('en-US', {
				month: 'long',
				year: 'numeric'
			})}</span>
                <button id='calendar-next' class='calendar-nav-btn' title='Next month'>▶/button>
            `;
			this.container.appendChild(header);
			const nextMonthBtn = document.getElementById('calendar-next');
			const firstDayOfNextMonth = new Date(year, month + 1, 1);
			if (firstDayOfNextMonth > this.today) {
				nextMonthBtn.disabled = true;
			}

			const grid = document.createElement('div');
			grid.className = 'calendar-grid';
			const dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
			dayNames.forEach(name => {
				const dayNameEl = document.createElement('div');
				dayNameEl.className = 'calendar-day-name';
				dayNameEl.textContent = name;
				grid.appendChild(dayNameEl);
			});

			const firstDayOfMonth = new Date(year, month, 1);
			const lastDayOfMonth = new Date(year, month + 1, 0);
			const firstDayOfWeek = firstDayOfMonth.getDay();
			for (let i = 0; i < firstDayOfWeek; i++) {
				grid.appendChild(document.createElement('div'));
			}
			for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
				const dateWrapper = document.createElement('div');
				dateWrapper.className = 'calendar-date-wrapper';
				const dateButton = document.createElement('button');
				dateButton.className = 'calendar-date';
				dateButton.textContent = day;
				const thisDate = new Date(year, month, day);
				const dateString = this.formatDateString(thisDate);
				dateButton.dataset.date = dateString;

				const count = this.dataProvider.get(dateString) || 0;
				if (count > 0) {
					let level = 0;
					if (count >= 1 && count <= 2) level = 1;
					else if (count >= 3 && count <= 5) level = 2;
					else if (count > 5) level = 3;
					if (level > 0) dateButton.dataset.level = level;

					const dotsContainer = document.createElement('div');
					dotsContainer.className = 'calendar-dots-container';
					const dotCount = Math.min(level, 3);
					for (let i = 0; i < dotCount; i++) {
						const dot = document.createElement('div');
						dot.className = 'calendar-dot';
						dotsContainer.appendChild(dot);
					}
					dateWrapper.appendChild(dotsContainer);
				}

				if (this.selectedDate && this.formatDateString(this.selectedDate) === dateString) {
					dateButton.classList.add('is-selected');
				}
				dateWrapper.insertBefore(dateButton, dateWrapper.firstChild);
				grid.appendChild(dateWrapper);
			}
			this.container.appendChild(grid);
			this.addEventListeners();
		}

		addEventListeners() {
			document.getElementById('calendar-prev').addEventListener('click', () => this.changeMonth(-1));
			const nextBtn = document.getElementById('calendar-next');
			if (nextBtn && !nextBtn.disabled) {
				nextBtn.addEventListener('click', () => this.changeMonth(1));
			}

			this.container.querySelectorAll('.calendar-date').forEach(button => {
				button.addEventListener('click', (e) => this.selectDate(e.target));
				button.addEventListener('mouseover', (e) => {
					const target = e.currentTarget;
					const dateStr = target.dataset.date;
					const count = this.dataProvider.get(dateStr) || 0;
					if (count > 0) {
						const countText = count === 1 ? '1 note' : `${count} notes`;
						calendarTooltip.textContent = `${countText} on ${dateStr}`;
						calendarTooltip.style.display = 'block';
					}
				});

				button.addEventListener('mousemove', (e) => {
					if (calendarTooltip.style.display === 'block') {
						calendarTooltip.style.left = `${e.pageX}px`;
						calendarTooltip.style.top = `${e.pageY}px`;
					}
				});

				button.addEventListener('mouseout', () => {
					calendarTooltip.style.display = 'none';
				});
			});
		}

		changeMonth(direction) {
			this.currentDate.setMonth(this.currentDate.getMonth() + direction);
			this.render();
		}

		selectDate(dateElement) {
			const dateString = dateElement.dataset.date;
			if (this.selectedDate && this.formatDateString(this.selectedDate) === dateString) {
				this.selectedDate = null;
				appState.filters.date = null;
				clearFilterBtn.classList.remove('visible');
			} else {
				const [year, month, day] = dateString.split('-').map(Number);
				this.selectedDate = new Date(year, month - 1, day);
				const startOfDay = new Date(year, month - 1, day);
				const endOfDay = new Date(year, month - 1, day + 1);
				appState.filters.date = {
					startTimestamp: startOfDay.getTime(),
					endTimestamp: endOfDay.getTime()
				};
				clearFilterBtn.classList.add('visible');
			}
			this.render();
			reloadNotes();
		}

		formatDateString(date) {
			const year = date.getFullYear();
			const month = (date.getMonth() + 1).toString().padStart(2, '0');
			const day = date.getDate().toString().padStart(2, '0');
			return `${year}-${month}-${day}`;
		}
	}

	async function handleStandaloneImageUpload(request, env) {
		try {
			const formData = await request.formData();
			const file = formData.get('file');

			if (!file || !file.name || file.size === 0) {
				return jsonResponse({ error: 'A file is required for upload.' }, 400);
			}

			const imageId = crypto.randomUUID();
			const r2Key = `uploads/${imageId}`;
			await env.NOTES_R2_BUCKET.put(r2Key, file.stream(), {
				httpMetadata: { contentType: file.type }
			});
			const imageUrl = `/api/images/${imageId}`;
			return jsonResponse({ success: true, url: imageUrl });
		} catch (e) {
			console.error('Standalone Image Upload Error:', e.message);
			return jsonResponse({ error: 'Upload failed', message: e.message }, 500);
		}
	}

	async function handleServeStandaloneImage(imageId, env) {
		const r2Key = `uploads/${imageId}`;
		const object = await env.NOTES_R2_BUCKET.get(r2Key);
		if (object === null) {
			return new Response('File not found', { status: 404 });
		}
		const headers = new Headers();
		object.writeHttpMetadata(headers);
		headers.set('etag', object.httpEtag);
		headers.set('Cache-Control', 'public, max-age=31536000, immutable');
		return new Response(object.body, { headers });
	}

	async function uploadToLocalWorker(file) {
		const formData = new FormData();
		formData.append('file', file);
		const response = await fetch('/api/upload/image', {
			method: 'POST',
			body: formData
		});
		if (!response.ok) {
			throw new Error(`Local upload failed: ${await response.text()}`);
		}
		const result = await response.json();
		return result.url;
	}

	async function uploadToImgur(file) {
		const clientId = settings.imgurClientId;
		if (!clientId) {
			throw new Error('Imgur Client ID is not set in settings.');
		}
		const formData = new FormData();
		formData.append('file', file);
		formData.append('clientId', clientId);
		const response = await fetch('/api/proxy/upload/imgur', {
			method: 'POST',
			body: formData
		});
		if (!response.ok) {
			const errorResult = await response.json();
			throw new Error(`Imgur proxy failed: ${errorResult.message || 'Unknown error'}`);
		}
		const result = await response.json();
		return result.url;
	}

	function postProcessMarkdownHtml(html) {
		if (!html || html.indexOf('#') === -1) {
			return html;
		}
		const tempDiv = document.createElement('div');
		tempDiv.innerHTML = html;

		// 1. Gather all text nodes
		const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT);
		const allTextNodes = [];
		let node;
		while (node = walker.nextNode()) {
			allTextNodes.push(node);
		}

		// 2. Find the last non-empty text node
		let lastTextNode = null;
		for (let i = allTextNodes.length - 1; i >= 0; i--) {
			if (allTextNodes[i].nodeValue.trim() !== '') {
				lastTextNode = allTextNodes[i];
				break;
			}
		}

		// If no text or only whitespace, nothing to highlight
		if (!lastTextNode) return html;

		// 3. Identify the "last line" context
		// Find the closest block-level ancestor of the last text node
		const blockTags = new Set(['P', 'DIV', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'UL', 'OL', 'LI', 'BLOCKQUOTE', 'PRE', 'HR', 'TABLE', 'SECTION', 'ARTICLE', 'ASIDE', 'MAIN', 'FOOTER', 'HEADER', 'NAV', 'ADDRESS', 'DD', 'DT', 'FIELDSET', 'FIGCAPTION', 'FIGURE']);
		let blockParent = lastTextNode.parentElement;
		while (blockParent && blockParent !== tempDiv && !blockTags.has(blockParent.tagName)) {
			blockParent = blockParent.parentElement;
		}
		if (!blockParent) blockParent = tempDiv;

		// Check for <br> within this block to find the actual last line start
		const brs = blockParent.getElementsByTagName('br');
		const lastBr = brs.length > 0 ? brs[brs.length - 1] : null;

		// 4. Filter text nodes that belong to this last line
		const nodesToProcess = [];
		for (const textNode of allTextNodes) {
			// Must be within the identified block parent
			if (!blockParent.contains(textNode)) continue;

			// If there is a <br>, the node must follow it
			if (lastBr) {
				const position = lastBr.compareDocumentPosition(textNode);
				if (!(position & Node.DOCUMENT_POSITION_FOLLOWING)) {
					continue;
				}
			}

			// Must not be inside an existing link, and must contain '#'
			if (textNode.parentElement.tagName !== 'A' && textNode.nodeValue.includes('#')) {
				nodesToProcess.push(textNode);
			}
		}

		const tagRegex = /(#[\p{L}\p{N}_-]+)/gu;
		nodesToProcess.forEach(node => {
			const parent = node.parentElement;
			const text = node.nodeValue;
			if (!tagRegex.test(text)) return;
			const fragment = document.createDocumentFragment();
			let lastIndex = 0;
			text.replace(tagRegex, (match, tagName, offset) => {
				if (offset > lastIndex) {
					fragment.appendChild(document.createTextNode(text.substring(lastIndex, offset)));
				}
				const link = document.createElement('a');
				link.href = '#';
				link.className = 'inline-tag';
				link.dataset.tagName = tagName.substring(1).toLowerCase();
				link.textContent = tagName;
				fragment.appendChild(link);
				lastIndex = offset + match.length;
			});
			if (lastIndex < text.length) {
				fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
			}
			parent.replaceChild(fragment, node);
		});
		return tempDiv.innerHTML;
	}

	async function handlePastedImage(imageFile, textarea) {
		const placeholderId = `uploading-${Date.now()}`;
		const placeholderMarkdown = `![Uploading image... ${placeholderId}]()`;
		insertTextAtCursor(textarea, placeholderMarkdown);
		try {
			const destination = settings.imageUploadDestination || 'local';
			let finalUrl;
			switch (destination) {
				case 'imgur':
					finalUrl = await uploadToImgur(imageFile);
					break;
				case 'local':
				default:
					finalUrl = await uploadToLocalWorker(imageFile);
					break;
			}
			const finalMarkdown = `![${imageFile.name || 'pasted-image.png'}](${finalUrl})`;
			textarea.value = textarea.value.replace(placeholderMarkdown, finalMarkdown);
		} catch (error) {
			console.error('Image upload failed:', error);
			const errorMarkdown = `![Upload Failed: ${error.message}]()`;
			textarea.value = textarea.value.replace(placeholderMarkdown, errorMarkdown);
			showCustomAlert(`Image upload failed: ${error.message}`, 'error');
		} finally {
			textarea.dispatchEvent(new Event('input', { bubbles: true }));
		}
	}

	// --- 浣跨敤浜嬩欢濮旀墭涓烘墍鏈夊鍒舵寜閽坊鍔犵偣鍑讳簨浠?---
	document.body.addEventListener('click', async (event) => {
		const copyButton = event.target.closest('.copy-code-btn');
		if (copyButton) {
			const codeToCopy = copyButton.dataset.code;
			const originalIcon = copyButton.innerHTML;
			const successIcon = `<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'><polyline points='20 6 9 17 4 12'></polyline></svg>`;

			try {
				await navigator.clipboard.writeText(codeToCopy);
				copyButton.innerHTML = successIcon;
				copyButton.classList.add('copied');
				copyButton.title = 'Copied!';
				setTimeout(() => {
					copyButton.innerHTML = originalIcon;
					copyButton.classList.remove('copied');
					copyButton.title = 'Copy code';
				}, 2000);
			} catch (err) {
				console.error('Failed to copy text: ', err);
				copyButton.title = 'Copy failed!';
			}
		}
	});
	// --- 鍏ㄥ眬设置绠＄悊 ---
	const defaultSettings = {
		showSearchBar: true, showStatsCard: true, showCalendar: true, showTags: true,
		showTimeline: true, showRightSidebar: true, hideEditorInWaterfall: false,
		showHeatmap: true, imageUploadDestination: 'local', imgurClientId: '',
		surfaceColor: '#ffffff', surfaceColorDark: '#151f31', surfaceOpacity: 1,
		backgroundOpacity: 1, backgroundImage: '/bg.jpg', backgroundBlur: 0,
		waterfallCardWidth: 320, enableDateGrouping: false, telegramProxy: false
	}
	let settings = defaultSettings;

	async function loadSettings() {
		try {
			const response = await fetch('/api/settings');
			if (!response.ok) throw new Error('Failed to fetch settings from server');
			settings = await response.json();
		} catch (error) {
			console.error("Could not load settings:", error);
			// showCustomAlert(`Error loading settings: ${error.message}. Using local defaults.`, 'error');
		}
	}
	loadSettings();

	async function saveSettings() {
		try {
			const response = await fetch('/api/settings', {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(settings)
			});
			if (!response.ok) throw new Error('Failed to save settings to server');
		} catch (error) {
			console.error("Could not save settings:", error);
			showCustomAlert(`Error saving settings: ${error.message}`, 'error');
		}
	}
	// --- 鍏ㄥ眬搴旂敤鐘舵€?---
	const appState = {
		baseMode: 'home',
		isWaterfall: false,
		isWide: false,
		filters: {
			query: '',
			tag: null,
			date: null
		},
		pagination: {
			currentPage: 1,
			isLoading: false,
			hasMore: true
		},
		attachments: {
			currentPage: 1,
			isLoading: false,
			hasMore: true,
			currentFilter: 'all' // 'all', 'image', 'video', 'file'
		}
	};

	// --- DOM Elements ---
	const authContainer = document.getElementById('auth-container');
	const appContainer = document.getElementById('app-container');
	const loginForm = document.getElementById('login-form');
	const logoutBtn = document.getElementById('logout-btn');
	const noteForm = document.getElementById('note-form');
	const noteInput = document.getElementById('note-input');
	const noteFile = document.getElementById('note-file');
	const fileListDisplay = document.getElementById('file-list-display');
	const notesContainer = document.getElementById('notes-container');
	const refreshLoader = document.getElementById('refresh-loader');
	const scrollLoader = document.getElementById('scroll-loader');
	const refreshBtn = document.getElementById('refresh-btn');
	const themeToggleBtn = document.getElementById('theme-toggle-btn');
	const customModalOverlay = document.getElementById('custom-modal-overlay');
	// Alert elements
	const customAlertBox = document.getElementById('custom-alert-box');
	const customAlertMessage = document.getElementById('custom-alert-message');
	const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');
	// Confirm elements
	const customConfirmBox = document.getElementById('custom-confirm-box');
	const customConfirmMessage = document.getElementById('custom-confirm-message');
	const customConfirmOkBtn = document.getElementById('custom-confirm-ok-btn');
	const customConfirmCancelBtn = document.getElementById('custom-confirm-cancel-btn');
	const selectFilesBtn = document.getElementById('select-files-btn');
	const mainPreviewToggleBtn = document.getElementById('main-preview-toggle-btn');
	const mainSplitToggleBtn = document.getElementById('main-split-toggle-btn');

	const mainEditPreview = document.getElementById('main-edit-preview');
	const container = document.querySelector('.container');
	const appLayoutContainer = document.getElementById('app-layout-container');
	const fullscreenEditorOverlay = document.getElementById('fullscreen-editor-overlay');
	const fullscreenEditorBox = document.getElementById('fullscreen-editor-box');
	const fsEditorTextarea = document.getElementById('fs-editor-textarea');
	const fsPreviewPane = document.getElementById('fs-preview-pane');
	const editorContentArea = document.getElementById('editor-content-area');
	const editorToolbar = document.getElementById('editor-toolbar');
	const viewModeSplitBtn = document.getElementById('view-mode-split-btn');
	const viewModePreviewBtn = document.getElementById('view-mode-preview-btn');
	const fsSaveBtn = document.getElementById('fs-save-btn');
	const fsCancelBtn = document.getElementById('fs-cancel-btn');
	const enterFullscreenBtn = document.getElementById('enter-fullscreen-btn');
	const backToTopBtn = document.getElementById('back-to-top-btn');
	const fsEditorDivider = document.getElementById('fs-editor-divider');
	const insertTagBtn = document.getElementById('insert-tag-btn');
	const tagDropdown = document.getElementById('tag-dropdown');
	const tagSearchInput = document.getElementById('tag-search-input');
	const tagDropdownList = document.getElementById('tag-dropdown-list');
	const globalSearchInput = document.getElementById('global-search-input');
	const clearSearchBtn = document.getElementById('clear-search-btn');
	const themeColorBtn = document.getElementById('theme-color-btn');
	const themeColorPopover = document.getElementById('theme-color-popover');
	const colorPalette = themeColorPopover.querySelector('.color-palette');
	const colorPickerLabel = document.getElementById('color-picker-label');
	const colorPickerPreview = document.getElementById('color-picker-preview');
	const colorPickerInput = document.getElementById('color-picker-input');
	const hexColorInput = document.getElementById('hex-color-input');
	const statsDays = document.getElementById('stats-days');
	const statsMemos = document.getElementById('stats-memos');
	const statsTags = document.getElementById('stats-tags');
	const insertImageBtn = document.getElementById('insert-image-btn');
	const insertCodeBtn = document.getElementById('insert-code-btn');
	const rightSidebar = document.getElementById('right-sidebar');
	const homeTabBtn = document.getElementById('home-tab-btn');
	const favoritesTabBtn = document.getElementById('favorites-tab-btn');
	const archiveTabBtn = document.getElementById('archive-tab-btn');
	const waterfallTabBtn = document.getElementById('waterfall-tab-btn');
	const waterfallPopoverMenu = document.getElementById('waterfall-popover-menu');
	const toggleDateGrouping = document.getElementById('toggle-date-grouping');

	const toggleRightSidebar = document.getElementById('toggle-right-sidebar');
	const toggleCalendar = document.getElementById('toggle-calendar');
	const toggleEditorInWaterfall = document.getElementById('toggle-editor-in-waterfall');

	// 设置寮规鐩稿叧鍏冪礌
	const settingsModalOverlay = document.getElementById('settings-modal-overlay');
	const closeSettingsBtn = document.getElementById('close-settings-btn');
	// 鍙鎬у紑鍏?
	const toggleSearchBar = document.getElementById('toggle-search-bar');
	const toggleStatsCard = document.getElementById('toggle-stats-card');
	const toggleTags = document.getElementById('toggle-tags');
	const toggleTimeline = document.getElementById('toggle-timeline');
	// 鑳屾櫙设置
	const bgImageUrl = document.getElementById('bg-image-url');
	const bgImageUpload = document.getElementById('bg-image-upload');
	const bgBlurSlider = document.getElementById('bg-blur-slider');
	const clearBgBtn = document.getElementById('clear-bg-btn');
	const restoreBgBtn = document.getElementById('restore-bg-btn');
	const toggleHeatmap = document.getElementById('toggle-heatmap');
	const bgOpacitySlider = document.getElementById('bg-opacity-slider');
	const surfaceColorPickerInput = document.getElementById('surface-color-picker-input');
	const surfaceHexColorInput = document.getElementById('surface-hex-color-input');
	const surfaceOpacitySlider = document.getElementById('surface-opacity-slider');
	const restoreSurfaceBtn = document.getElementById('restore-surface-defaults-btn');
	// 鐎戝竷娴佽缃?
	const waterfallWidthSlider = document.getElementById('waterfall-width-slider');
	const waterfallWidthValue = document.getElementById('waterfall-width-value');
	const toggleTelegramProxy = document.getElementById('toggle-telegram-proxy');

	// 闇€瑕佽鎺у埗鏄鹃殣鐨勫乏渚ф爮鍗＄墖
	const searchStatsContainer = document.querySelector('.sidebar-search-container');
	const statsCard = document.getElementById('stats-card');
	const tagsSectionWrapper = document.getElementById('tags-section-wrapper');
	const timelineSectionWrapper = document.getElementById('timeline-section-wrapper');

	// --- 瀵屾枃鏈紪杈戠浉鍏冲厓绱?---
	const fsFontsizeSelector = document.getElementById('fs-fontsize-selector');
	const fsFontcolorBtn = document.getElementById('fs-fontcolor-btn');
	const fsColorPickerWrapper = document.getElementById('fs-color-picker-wrapper');
	const fsColorPopover = document.getElementById('fs-color-popover');
	const fsColorPalette = fsColorPopover.querySelector('.color-palette.fscolor-palette');

	const waterfallToggleBtn = document.getElementById('waterfall-toggle-btn');
	const wideModeToggleBtn = document.getElementById('wide-mode-toggle-btn');
	const notesSection = document.getElementById('notes-section');

	const heatmapContainerWrapper = document.getElementById('heatmap-container-wrapper');
	const heatmapTooltip = document.getElementById('heatmap-tooltip');
	const imgurClientIdWrapper = document.getElementById('imgur-client-id-wrapper');
	const imgurClientIdInput = document.getElementById('imgur-client-id');
	const uploadDestinationRadios = document.querySelectorAll('input[name="upload-destination"]');
	const attachmentsTabBtn = document.getElementById('attachments-tab-btn');
	const attachmentsViewer = document.getElementById('attachments-viewer');
	const attachmentsContent = document.getElementById('attachments-content');
	const attachmentsTabs = document.querySelector('.attachments-tabs');

	const moreActionsContainer = document.getElementById('more-actions-container');
	const moreActionsBtn = document.getElementById('more-actions-btn');
	const moreMenuPopover = document.getElementById('more-menu-popover');
	const notePopoverMenu = document.getElementById('note-popover-menu');
	let popoverHoverTimer = null;
	let waterfallPopoverHideTimer = null;
	let activePopoverNoteId = null;

	// --- 显示绗旇鎿嶄綔鑿滃崟 ---
	function showNotePopover(targetButton, noteId) {
		clearTimeout(popoverHoverTimer); // 娓呴櫎鍙兘瀛樺湪鐨勯殣钘忚鏃跺櫒
		// 濡傛灉鑿滃崟宸茬粡涓哄悓涓€涓寜閽樉绀猴紝鍒欎笉鎵ц浠讳綍鎿嶄綔
		if (notePopoverMenu.classList.contains('visible') && activePopoverNoteId === noteId) {
			return;
		}
		activePopoverNoteId = noteId;
		notePopoverMenu.dataset.noteId = noteId;
		const noteData = allNotesCache.find(n => n.id === parseInt(noteId, 10));
		const favoriteBtn = notePopoverMenu.querySelector('[data-action="favorite"]');
		const pinBtn = notePopoverMenu.querySelector('[data-action="pin"]');
		const archiveBtn = notePopoverMenu.querySelector('[data-action="archive"], [data-action="unarchive"]');
		const collapseBtn = notePopoverMenu.querySelector('[data-action="collapse"]');

		if (appState.baseMode === 'archive') {
			archiveBtn.classList.add('unarchive-mode');
			archiveBtn.title = 'Unarchive';
			archiveBtn.dataset.action = 'unarchive';
			favoriteBtn.style.display = 'none';
			pinBtn.style.display = 'none';
		} else {
			archiveBtn.classList.remove('unarchive-mode');
			archiveBtn.title = 'Archive';
			archiveBtn.dataset.action = 'archive';
			favoriteBtn.style.display = '';
			pinBtn.style.display = '';

			const noteData = allNotesCache.find(n => n.id === parseInt(noteId, 10));
			if (noteData) {
				favoriteBtn.classList.toggle('favorited', noteData.is_favorited);
				favoriteBtn.title = noteData.is_favorited ? 'Unfavorite' : 'Favorite';

				pinBtn.classList.toggle('pinned', noteData.is_pinned);
				pinBtn.title = noteData.is_pinned ? 'Unpin' : 'Pin';
			}
		}

		// Update collapse button state
		if (noteData && collapseBtn) {
			const isCollapsed = noteData.is_collapsed;
			collapseBtn.classList.toggle('collapsed', isCollapsed);
			collapseBtn.title = isCollapsed ? 'Expand' : 'Collapse';
		}

		const btnRect = targetButton.getBoundingClientRect();
		notePopoverMenu.style.top = `${btnRect.bottom + 5}px`;
		notePopoverMenu.style.left = `${btnRect.right - notePopoverMenu.offsetWidth}px`;
		notePopoverMenu.classList.add('visible');
	}

	// --- 隐藏绗旇鎿嶄綔鑿滃崟 ---
	function hideNotePopover() {
		popoverHoverTimer = setTimeout(() => {
			notePopoverMenu.classList.remove('visible');
			activePopoverNoteId = null;
		}, 200); // 寤惰繜200姣隐藏锛岄槻姝㈤紶鏍囨剰澶栫Щ鍑?
	}

	// --- 涓鸿彍鍗曟湰韬坊鍔犳偓鍋滈€昏緫锛岄槻姝㈤紶鏍囩Щ鍏ヨ彍鍗曟椂瀹冩秷澶?---
	notePopoverMenu.addEventListener('mouseenter', () => {
		clearTimeout(popoverHoverTimer);
	});

	notePopoverMenu.addEventListener('mouseleave', () => {
		hideNotePopover();
	});

	// --- 处理鑿滃崟椤圭殑点击浜嬩欢 ---
	notePopoverMenu.addEventListener('click', async (e) => {
		const actionButton = e.target.closest('.icon-btn');
		if (!actionButton) return;

		const action = actionButton.dataset.action;
		const noteId = notePopoverMenu.dataset.noteId;
		if (!noteId) return;
		notePopoverMenu.classList.remove('visible');
		activePopoverNoteId = null;
		const noteElement = notesContainer.querySelector(`.note[data-id="${noteId}"]`);

		switch (action) {
			case 'favorite': {
				const isCurrentlyFavorited = actionButton.classList.contains('favorited');
				const newFavoriteState = !isCurrentlyFavorited;
				actionButton.disabled = true;
				const formData = new FormData();
				formData.append('isFavorited', newFavoriteState.toString());
				try {
					const res = await fetch(`/api/notes/${noteId}`, { method: 'PUT', body: formData });
					if (!res.ok) throw new Error('Failed to update favorite status.');
					actionButton.classList.toggle('favorited', newFavoriteState);
					actionButton.title = newFavoriteState ? 'Unfavorite' : 'Favorite';
					const noteInCache = allNotesCache.find(n => n.id === parseInt(noteId));
					if (noteInCache) noteInCache.is_favorited = newFavoriteState;
				} catch (error) {
					showCustomAlert(error.message, 'error');
				} finally {
					actionButton.disabled = false;
				}
				break;
			}
			case 'pin': {
				const isCurrentlyPinned = actionButton.classList.contains('pinned');
				const newPinState = !isCurrentlyPinned;
				actionButton.disabled = true;
				const formData = new FormData();
				formData.append('isPinned', newPinState.toString());
				try {
					const res = await fetch(`/api/notes/${noteId}`, { method: 'PUT', body: formData });
					if (!res.ok) throw new Error('Failed to update pin status.');
					actionButton.classList.toggle('pinned', newPinState);
					actionButton.title = newPinState ? 'Unpin' : 'Pin';
					const noteInCache = allNotesCache.find(n => n.id === parseInt(noteId));
					if (noteInCache) noteInCache.is_pinned = newPinState;
					await refreshNotes();
				} catch (error) {
					showCustomAlert(error.message, 'error');
				} finally {
					actionButton.disabled = false;
				}
				break;
			}
			case 'archive':
			case 'unarchive': {
				const isArchiving = action === 'archive';
				actionButton.disabled = true;
				const formData = new FormData();
				formData.append('is_archived', isArchiving.toString());

				try {
					const res = await fetch(`/api/notes/${noteId}`, { method: 'PUT', body: formData });
					if (!res.ok) throw new Error(`Failed to ${action} note.`);

					// 鎿嶄綔鎴愬姛鍚庯紝鐩存帴浠庡綋鍓嶈鍥剧Щ闄ゅ崱鐗?
					if (noteElement) {
						noteElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
						noteElement.style.opacity = '0';
						noteElement.style.transform = 'scale(0.95)';
						setTimeout(() => noteElement.remove(), 300);
					}

					// 更新缂撳瓨
					const noteInCache = allNotesCache.find(n => n.id === parseInt(noteId));
					if (noteInCache) noteInCache.is_archived = isArchiving;

				} catch (error) {
					showCustomAlert(error.message, 'error');
				} finally {
					actionButton.disabled = false;
				}
				break;
			}
			case 'collapse': {
				if (!noteElement) return;
				const isCurrentlyCollapsed = actionButton.classList.contains('collapsed');
				const newCollapseState = !isCurrentlyCollapsed;
				actionButton.disabled = true;
				const formData = new FormData();
				formData.append('isCollapsed', newCollapseState.toString());
				try {
					const res = await fetch(`/api/notes/${noteId}`, { method: 'PUT', body: formData });
					if (!res.ok) throw new Error('Failed to update collapse status.');

					// Update UI
					noteElement.classList.toggle('collapsed', newCollapseState);
					actionButton.classList.toggle('collapsed', newCollapseState);
					actionButton.title = newCollapseState ? 'Expand' : 'Collapse';

					// Update cache
					const noteInCache = allNotesCache.find(n => n.id === parseInt(noteId));
					if (noteInCache) noteInCache.is_collapsed = newCollapseState;
				} catch (error) {
					showCustomAlert(error.message, 'error');
				} finally {
					actionButton.disabled = false;
				}
				break;
			}
			case 'share': {
				openShareDialog(noteId);
				break;
			}
			case 'delete': {
				if (!noteElement) return;
				const confirmed = await showCustomConfirm('Are you sure you want to delete this note?');
				if (!confirmed) return;
				waterfallObserver.unobserve(noteElement);
				try {
					await fetch(`/api/notes/${noteId}`, { method: 'DELETE' });
					noteElement.remove();
					loadAndRenderTags();
					loadAndRenderTimeline();
					loadAndRenderStats();
				} catch (error) {
					showCustomAlert(error.message, 'error');
				}
				break;
			}
		}
	});

	let isMenuPinned = false;
	let hideMenuTimeout;
	function showColorPopover() {
		const moreMenuRect = moreMenuPopover.getBoundingClientRect();
		themeColorPopover.style.top = `${moreMenuRect.bottom + 8}px`;
		themeColorPopover.style.right = `${window.innerWidth - moreMenuRect.right}px`;
		themeColorPopover.style.left = 'auto';
		themeColorPopover.classList.add('visible');
	}

	function hideColorPopover() {
		themeColorPopover.classList.remove('visible');
	}

	// 点击鈥滄洿澶氣€濇寜閽?
	moreActionsBtn.addEventListener('click', () => {
		isMenuPinned = !isMenuPinned;
		moreMenuPopover.classList.toggle('visible', isMenuPinned);
		if (!isMenuPinned) {
			hideColorPopover();
		}
	});

	// 鎮仠显示
	moreActionsContainer.addEventListener('mouseenter', () => {
		clearTimeout(hideMenuTimeout);
		if (!moreMenuPopover.classList.contains('visible')) {
			moreMenuPopover.classList.add('visible');
		}
	});

	// 绂诲紑隐藏
	moreActionsContainer.addEventListener('mouseleave', () => {
		if (!isMenuPinned) {
			hideMenuTimeout = setTimeout(() => {
				// 濡傛灉棰滆壊閫夋嫨鍣ㄤ篃寮€鐫€锛屽垯涓嶈嚜鍔ㄩ殣钘忥紝璁╃敤鎴峰彲浠ユ搷浣?
				if (!themeColorPopover.classList.contains('visible')) {
					moreMenuPopover.classList.remove('visible');
				}
			}, 300);
		}
	});

	// 点击鑿滃崟鍐呯殑鈥滀富棰橀鑹测€濇寜閽?
	themeColorBtn.addEventListener('click', (e) => {
		e.stopPropagation();
		if (themeColorPopover.classList.contains('visible')) {
			hideColorPopover();
		} else {
			showColorPopover();
		}
	});

	// 鍏ㄥ眬点击浜嬩欢锛岀敤浜庡叧闂墍鏈夊脊绐?
	document.addEventListener('click', (e) => {
		if (!moreActionsContainer.contains(e.target)) {
			if (isMenuPinned) {
				isMenuPinned = false;
				moreMenuPopover.classList.remove('visible');
				hideColorPopover();
			}
		}
		if (!themeColorPopover.contains(e.target) && e.target.closest('#theme-color-btn') === null) {
			hideColorPopover();
		}
		if (isTagDropdownOpen && !tagDropdown.contains(e.target) && e.target !== insertTagBtn) {
			closeTagDropdown();
		}
		if (
			waterfallPopoverMenu.classList.contains('visible') &&
			!waterfallPopoverMenu.contains(e.target) &&
			!e.target.closest('.waterfall-more-btn')
		) {
			hideWaterfallPopover();
		}
	});

	// 绐楀彛澶у皬鏀瑰彉鎴栨粴鍔ㄦ椂锛岄殣钘忔诞鍔ㄧ獥鍙ｏ紝避免閿欎綅
	window.addEventListener('resize', () => {
		hideColorPopover();
		if (isMenuPinned) {
			isMenuPinned = false;
			moreMenuPopover.classList.remove('visible');
		}
	});
	window.addEventListener('scroll', hideColorPopover, { passive: true });

	const attachmentsState = {
		allData: [],
		currentFilter: 'all',
		isLoaded: false, // 杩欎釜鐜板湪琛ㄧず鏄惁宸插姞杞借繃绗竴椤?
		isLoading: false,
		currentPage: 1,
		hasMore: true,
	};
	/**
	 * @param {boolean} isInitialLoad - 鏄惁鏄娆″姞杞芥垨切换绛涢€夊櫒
	 */
	async function fetchAllAttachments(isInitialLoad = false) {
		if (attachmentsState.isLoading || (!attachmentsState.hasMore && !isInitialLoad)) return;

		attachmentsState.isLoading = true;
		const loader = document.createElement('div');
		loader.className = 'loading-indicator';
		loader.textContent = 'Loading...';
		attachmentsContent.appendChild(loader);

		if (isInitialLoad) {
			attachmentsState.currentPage = 1;
			attachmentsState.hasMore = true;
			attachmentsState.allData = [];
			attachmentsContent.innerHTML = '';
			attachmentsContent.appendChild(loader);
		}

		try {
			const response = await fetch(`/api/attachments?page=${attachmentsState.currentPage}`);
			if (!response.ok) throw new Error('Failed to fetch attachments');
			const data = await response.json();
			// 杩藉姞鏂版暟鎹?
			attachmentsState.allData.push(...data.attachments);
			attachmentsState.hasMore = data.hasMore;
			attachmentsState.isLoaded = true;
			// 娓叉煋鏂拌幏鍙栫殑鏁版嵁
			renderAttachments(data.attachments, isInitialLoad);
			attachmentsState.currentPage++;
		} catch (error) {
			console.error(error);
			attachmentsContent.innerHTML = '<p>Failed to load attachments.</p>';
		} finally {
			attachmentsState.isLoading = false;
			const existingLoader = attachmentsContent.querySelector('.loading-indicator');
			if (existingLoader) {
				existingLoader.remove();
			}
		}
	}

	function renderAttachments(attachmentsToRender, isInitialLoad) {
		if (isInitialLoad) {
			attachmentsContent.classList.remove('loading-state');
			attachmentsContent.innerHTML = '';
		}

		const filteredData = attachmentsToRender.filter(item => {
			if (attachmentsState.currentFilter === 'all') return true;
			return item.type === attachmentsState.currentFilter;
		});

		if (isInitialLoad && filteredData.length === 0 && !attachmentsState.hasMore) {
			attachmentsContent.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No items to display.</p>';
			return;
		}

		const groupedByMonth = attachmentsState.allData.reduce((acc, item) => {
			const date = new Date(item.timestamp);
			const monthKey = date.toLocaleString('en-US', { year: 'numeric', month: 'long' });
			if (!acc[monthKey]) acc[monthKey] = [];
			acc[monthKey].push(item);
			return acc;
		}, {});

		for (const monthKey in groupedByMonth) {
			let monthGroupEl = document.getElementById(`month-${monthKey.replace(/\s/g, '-')}`);
			if (!monthGroupEl) {
				monthGroupEl = document.createElement('div');
				monthGroupEl.className = 'attachment-month-group';
				monthGroupEl.id = `month-${monthKey.replace(/\s/g, '-')}`;
				monthGroupEl.innerHTML = `<h4 class="month-header">${monthKey}</h4><div class="attachments-grid"></div>`;
				attachmentsContent.appendChild(monthGroupEl);
			}
		}

		// 鍙皢鏂拌幏鍙栫殑鏁版嵁椤规坊鍔犲埌瀵瑰簲鐨勭綉鏍间腑
		filteredData.forEach(item => {
			const date = new Date(item.timestamp);
			const monthKey = date.toLocaleString('en-US', { year: 'numeric', month: 'long' });
			const gridEl = document.getElementById(`month-${monthKey.replace(/\s/g, '-')}`).querySelector('.attachments-grid');
			const itemLink = document.createElement('a');
			itemLink.dataset.noteId = item.noteId;
			let shareButtonHTML = '';
			if (item.type === 'file' && item.id) {
				shareButtonHTML = `
                <button class="share-file-btn icon-btn" title="Get public link" data-note-id="${item.noteId}" data-file-id="${item.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg>
                </button>
            `;
			}
			if (item.type === 'image') {
				itemLink.href = item.url;
				itemLink.className = 'attachment-item attachment-item-image';
				itemLink.dataset.previewable = true;
				itemLink.innerHTML = `<img src="${item.url}" loading="lazy" class="preview" alt="Image from note ${item.noteId}">`;
				gridEl.appendChild(itemLink);
			} else if (item.type === 'video') {
				const itemContainer = document.createElement('div');
				itemContainer.dataset.noteId = item.noteId;
				itemContainer.className = 'attachment-item attachment-item-image';
				itemContainer.dataset.videoPreviewable = true;
				itemContainer.dataset.url = item.url;
				itemContainer.style.cursor = 'pointer';
				itemContainer.innerHTML = `
        <video src="${item.url}" class="preview" preload="metadata" muted style="object-fit: contain; background: #000; pointer-events: none;"></video>
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; color: rgba(255,255,255,0.7); pointer-events: none;">▶/div>
    `;
				gridEl.appendChild(itemContainer);
			} else { // type === 'file'
				itemLink.href = `/api/files/${item.noteId}/${item.id}`;
				itemLink.className = 'attachment-item attachment-item-file';
				itemLink.download = item.name;
				itemLink.innerHTML = `
                    <div class="file-icon">📎</div>
                    <div class="file-info">
                        <div class="name">${item.name}</div>
                        <div class="size">${formatBytes(item.size)}</div>
                    </div>
                ${shareButtonHTML}
                `;
				gridEl.appendChild(itemLink);
			}
		});
	}

	async function showAttachmentsViewer() {
		appState.baseMode = 'attachments';
		updateSidebarTabsUI();
		appContainer.style.display = 'none';
		attachmentsViewer.style.display = 'block';
		appLayoutContainer.classList.add('attachments-mode');
		await fetchAllAttachments(true);
	}

	// --- 闄勪欢椤甸潰鐨勫瓙閫夐」鍗′簨浠剁洃鍚櫒 ---
	attachmentsTabs.addEventListener('click', (e) => {
		const tabBtn = e.target.closest('.tab-btn');
		if (!tabBtn || tabBtn.classList.contains('active')) return;

		attachmentsTabs.querySelector('.active').classList.remove('active');
		tabBtn.classList.add('active');

		attachmentsState.currentFilter = tabBtn.dataset.filter;
		fetchAllAttachments(true);
	});

	// --- 涓洪檮浠跺唴瀹瑰尯添加鏃犻檺婊氬姩鍜屽浘鐗囬瑙堢殑浜嬩欢濮旀墭 ---


	attachmentsContent.addEventListener('click', async e => {
		const imageLink = e.target.closest('a[data-previewable="true"]');
		const videoContainer = e.target.closest('div[data-video-previewable="true"]');
		if (imageLink) {
			e.preventDefault();
			const imgElement = imageLink.querySelector('img');
			openImagePreview(imgElement.src, imgElement.alt);
		} else if (videoContainer) {
			const videoUrl = videoContainer.dataset.url;
			const noteId = videoContainer.dataset.noteId;
			openVideoPreview(videoUrl, `Video from note ${noteId}`);
		}

		const shareBtn = e.target.closest('.share-file-btn');
		if (shareBtn) {
			e.preventDefault();
			e.stopPropagation();

			const noteId = shareBtn.dataset.noteId;
			const fileId = shareBtn.dataset.fileId;
			const originalIcon = shareBtn.innerHTML;
			const successIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;

			shareBtn.disabled = true;
			shareBtn.innerHTML = '...';

			try {
				const response = await fetch(`/api/notes/${noteId}/files/${fileId}/share`, { method: 'POST' });
				if (!response.ok) {
					const errorData = await response.json();
					throw new Error(errorData.error || 'Failed to generate link.');
				}
				const { url } = await response.json();

				await navigator.clipboard.writeText(url);

				shareBtn.innerHTML = successIcon;
				shareBtn.classList.add('copied');
				shareBtn.title = 'Copied!';

				setTimeout(() => {
					shareBtn.innerHTML = originalIcon;
					shareBtn.classList.remove('copied');
					shareBtn.title = 'Get public link';
					shareBtn.disabled = false;
				}, 2000);

			} catch (error) {
				showCustomAlert(`Error: ${error.message}`, 'error');
				shareBtn.innerHTML = originalIcon;
				shareBtn.disabled = false;
			}
		}
	});

	// 处理鍙抽敭棰勮鏂囨湰鏂囦欢鐨勪簨浠?
	attachmentsContent.addEventListener('contextmenu', e => {
		// 杩欓噷鐨勭洰鏍囨槸鏁翠釜鍙笅杞界殑鏂囦欢鍗＄墖
		const link = e.target.closest('.attachment-item-file');
		if (!link || !link.download) return;

		// 澶嶇敤宸叉湁鐨勫叏灞€鍙橀噺 textFileExtensions
		if (textFileExtensions.includes(link.download.split('.').pop().toLowerCase())) {
			e.preventDefault();
			window.open(`${link.href}?preview=true`, '_blank');
		}
	});
	/**
	 * 浠庨檮浠惰鍥惧垏鎹㈠洖涓婚〉瑙嗗浘
	 */
	function hideAttachmentsViewer() {
		attachmentsViewer.style.display = 'none';
		appContainer.style.display = 'block';
		appLayoutContainer.classList.remove('attachments-mode');
	}

	// --- 鍙充晶鏍忔寜閽殑点击浜嬩欢 ---
	homeTabBtn.addEventListener('click', () => {
		if (appState.baseMode === 'home') return;
		hideAttachmentsViewer(); // 浠庨檮浠堕〉杩斿洖
		appState.baseMode = 'home';
		updateSidebarTabsUI();
		updateEditorVisibility();
		reloadNotes();
	});

	favoritesTabBtn.addEventListener('click', () => {
		if (appState.baseMode === 'favorites') return;
		hideAttachmentsViewer(); // 浠庨檮浠堕〉杩斿洖
		appState.baseMode = 'favorites';
		updateSidebarTabsUI();
		updateEditorVisibility();
		reloadNotes();
	});

	archiveTabBtn.addEventListener('click', () => {
		if (appState.baseMode === 'archive') return;
		hideAttachmentsViewer();
		appState.baseMode = 'archive';
		updateSidebarTabsUI();
		updateEditorVisibility(); // 缂栬緫鍣ㄥ湪褰掓。椤典笉显示
		reloadNotes();
	});

	attachmentsTabBtn.addEventListener('click', () => {
		if (appState.baseMode === 'attachments') return;
		showAttachmentsViewer();
	});

	// --- 涓洪檮浠堕〉闈㈢殑瀛愰€夐」鍗℃坊鍔犱簨浠跺鎵?---
	attachmentsTabs.addEventListener('click', (e) => {
		const tabBtn = e.target.closest('.tab-btn');
		if (!tabBtn || tabBtn.classList.contains('active')) return;
		attachmentsTabs.querySelector('.active').classList.remove('active');
		tabBtn.classList.add('active');
		attachmentsState.currentFilter = tabBtn.dataset.filter;
		renderAttachments();
	});

	async function handleImageUploadAndInsert(files, textarea) {
		if (!files || files.length === 0) return;
		const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
		if (imageFiles.length === 0) return;
		for (const imageFile of imageFiles) {
			await handlePastedImage(imageFile, textarea);
		}
	}

	// --- START: 鍏ㄥ睆缂栬緫鍣ㄥ悓姝ユ粴鍔ㄩ€昏緫 ---

	/**
	 * 处理缂栬緫鍣ㄥ拰棰勮鍖轰箣闂寸殑鍚屾婊氬姩銆?
	 * @param {HTMLElement} source - 瑙﹀彂婊氬姩鐨勫厓绱?(textarea 鎴?preview div)銆?
	 * @param {HTMLElement} target - 闇€瑕佽鍚屾婊氬姩鐨勫厓绱犮€?
	 */
	function handleSyncScroll(source, target) {
		// 濡傛灉鐩爣鍏冪礌姝ｅ湪琚▼搴忓寲鍚屾婊氬姩锛屽垯閲嶇疆鏍囧織骞剁珛鍗宠繑鍥烇紝浠ラ槻姝㈡棤闄愬惊鐜€?
		if (source._isSyncingScroll) {
			source._isSyncingScroll = false; // 閲嶇疆鏍囧織
			return;
		}

		// 璁＄畻婧愬厓绱犲彲婊氬姩鐨勬€婚珮搴︺€?
		const sourceScrollableHeight = source.scrollHeight - source.clientHeight;
		// 濡傛灉婧愬厓绱犱笉鍙粴鍔紙渚嬪鍐呭寰堢煭锛夛紝鍒欐棤闇€鍚屾銆?
		if (sourceScrollableHeight <= 0) {
			return;
		}

		// 璁＄畻褰撳墠婊氬姩鐨勭櫨鍒嗘瘮銆?
		const scrollPercentage = source.scrollTop / sourceScrollableHeight;

		// 璁＄畻鐩爣鍏冪礌鍙粴鍔ㄧ殑鎬婚珮搴︺€?
		const targetScrollableHeight = target.scrollHeight - target.clientHeight;

		// 鍦ㄨ缃洰鏍囧厓绱犵殑 scrollTop 涔嬪墠锛屽厛鍦ㄥ叾涓婅缃竴涓爣蹇椼€?
		// 杩欐牱锛屽綋鐩爣鍏冪礌鐨?'scroll' 浜嬩欢琚Е鍙戞椂锛屾垜浠彲浠ヨ瘑鍒嚭杩欐槸鐢辩▼搴忔帶鍒剁殑锛岃€屼笉鏄敤鎴锋搷浣溿€?
		target._isSyncingScroll = true;

		// 鏍规嵁鐧惧垎姣旇缃洰鏍囧厓绱犵殑婊氬姩浣嶇疆銆?
		target.scrollTop = scrollPercentage * targetScrollableHeight;
	}

	// 涓哄叏灞忕紪杈戝櫒鐨勬枃鏈尯添加婊氬姩浜嬩欢鐩戝惉
	fsEditorTextarea.addEventListener('scroll', () => {
		// 纭繚鍙湪鍒嗘爮锛坰plit锛夋ā寮忎笅鍚屾婊氬姩
		if (editorContentArea.dataset.viewMode === 'split') {
			handleSyncScroll(fsEditorTextarea, fsPreviewPane);
		}
	});

	// 涓哄叏灞忕紪杈戝櫒鐨勯瑙堝尯添加婊氬姩浜嬩欢鐩戝惉
	fsPreviewPane.addEventListener('scroll', () => {
		// 纭繚鍙湪鍒嗘爮锛坰plit锛夋ā寮忎笅鍚屾婊氬姩
		if (editorContentArea.dataset.viewMode === 'split') {
			handleSyncScroll(fsPreviewPane, fsEditorTextarea);
		}
	});

	// --- END: 鍏ㄥ睆缂栬緫鍣ㄥ悓姝ユ粴鍔ㄩ€昏緫 ---

	/**
	 * 搴旂敤鍚姩鍣?
	 * 妫€鏌ョ敤鎴风櫥褰曠姸鎬侊紝骞舵牴鎹粨鏋滄樉绀哄悎閫傜殑鐣岄潰
	 */
	async function initializeApp() {
		try {
			const response = await fetch('/api/notes?page=1');
			if (response.ok) {
				const data = await response.json();
				// 显示搴旂敤涓荤晫闈?
				showAppScreen();
				allNotesCache = data.notes;
				renderNotes(data.notes);
				appState.pagination.hasMore = data.hasMore;
				appState.pagination.currentPage = 1;

				// 处理加载鏇村鐨刄I
				if (!data.hasMore) {
					if (allNotesCache.length > 0) {
						scrollLoader.textContent = 'No more notes.';
						scrollLoader.style.display = 'block';
					} else {
						notesContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 1rem 0;">Nothing here yet.</div>';
						scrollLoader.style.display = 'none';
					}
				}
			} else if (response.status === 401) {
				// 濡傛灉 session 鏃犳晥鎴栦笉瀛樺湪锛屾樉绀虹櫥褰曠晫闈?
				showLoginScreen();
			} else {
				// 处理鍏朵粬缃戠粶鎴栨湇鍔″櫒閿欒
				throw new Error(`Server check failed with status: ${response.status}`);
			}
		} catch (error) {
			console.error('Initialization failed:', error);
			document.body.innerHTML = 'Failed to initialize the application. Please check your connection and try again.';
		}
	}

	function syncMainEditorLayout() {
		const noteForm = document.getElementById('note-form');
		const textarea = document.getElementById('note-input');
		const preview = document.getElementById('main-edit-preview');

		// 濡傛灉褰撳墠涓嶆槸鍒嗘爮妯″紡锛屽彧闇€纭繚 textarea 楂樺害鑷€傚簲鍗冲彲
		if (!noteForm.classList.contains('split-mode')) {
			autoResizeTextarea(textarea);
			preview.style.minHeight = ''; // 绉婚櫎鍙兘瀛樺湪鐨勬渶灏忛珮搴?
			return;
		}
		autoResizeTextarea(textarea);
		const previewHeight = preview.offsetHeight;
		const textareaHeight = textarea.offsetHeight;
		if (previewHeight > textareaHeight) {
			textarea.style.height = `${previewHeight}px`;
		} else if (textareaHeight > previewHeight) {
			// 杩欐槸涓轰簡闃叉鍦ㄥ垹闄ゅぇ閲忔枃鏈椂锛屽彸渚ч瑙堝尯绐佺劧鍙樼煭瀵艰嚧甯冨眬璺冲姩
			preview.style.minHeight = `${textareaHeight}px`;
		}
	}

	// --- 鍞竴鐨勭瑪璁扮紪杈戝尯甯冨眬绠＄悊鍑芥暟 ---
	function syncNoteEditorLayout(noteElement) {
		if (!noteElement || !noteElement.classList.contains('editing')) return;

		const previewBtn = noteElement.querySelector('.md-preview-toggle-btn');
		const splitBtn = noteElement.querySelector('.md-split-toggle-btn');
		const textarea = noteElement.querySelector('.edit-textarea');
		const preview = noteElement.querySelector('.edit-preview');

		if (!previewBtn || !splitBtn || !textarea || !preview) return;

		const editorWidth = noteElement.offsetWidth;
		const isWide = editorWidth > 1000;
		previewBtn.style.display = isWide ? 'none' : 'inline-flex';
		splitBtn.style.display = isWide ? 'inline-flex' : 'none';

		if (!isWide && noteElement.classList.contains('split-mode')) {
			noteElement.classList.remove('split-mode');
			splitBtn.classList.remove('active');
		}
		if (isWide && noteElement.classList.contains('preview-mode')) {
			noteElement.classList.remove('preview-mode');
			previewBtn.classList.remove('active');
		}

		// 濡傛灉澶勪簬鍒嗘爮妯″紡
		if (noteElement.classList.contains('split-mode')) {
			// 寮哄埗 textarea 閲嶆柊璁＄畻鍏惰嚜閫傚簲楂樺害
			autoResizeTextarea(textarea);

			const previewHeight = preview.offsetHeight;
			const textareaHeight = textarea.offsetHeight;

			if (previewHeight > textareaHeight) {
				textarea.style.height = `${previewHeight}px`;
			}
		}
	}

	const noteEditorResizeObserver = new ResizeObserver(entries => {
		for (const entry of entries) {
			syncNoteEditorLayout(entry.target);
		}
	});

	function scrollToHeatmapEnd() {
		// requestAnimationFrame 纭繚鍦ㄦ祻瑙堝櫒涓嬩竴娆＄粯鍒跺墠鎵ц锛屾鏃?DOM 鍏冪礌灏哄宸茶绠楀畬姣?
		requestAnimationFrame(() => {
			const scrollContainer = document.getElementById('heatmap-scroll-container');
			if (scrollContainer) {
				scrollContainer.scrollLeft = scrollContainer.scrollWidth;
			}
		});
	}

	function applyViewModes() {
		// 鐎戝竷娴佹ā寮?
		if (appState.isWaterfall) {
			notesSection.classList.add('waterfall-mode');
			waterfallToggleBtn.classList.add('active'); // 鎸夐挳鍙樹寒
			// 閲嶆柊璁＄畻甯冨眬
			document.querySelectorAll('#notes-container .note').forEach(note => {
				waterfallObserver.observe(note);
			});
		} else {
			notesSection.classList.remove('waterfall-mode');
			waterfallToggleBtn.classList.remove('active');
			waterfallObserver.disconnect();
		}

		// 瀹藉睆妯″紡
		if (appState.isWide) {
			appLayoutContainer.classList.add('full-width-mode');
			wideModeToggleBtn.classList.add('active');
		} else {
			appLayoutContainer.classList.remove('full-width-mode');
			wideModeToggleBtn.classList.remove('active');
		}
		scrollToHeatmapEnd();
	}

	waterfallToggleBtn.addEventListener('click', () => {
		appState.isWaterfall = !appState.isWaterfall;
		localStorage.setItem('memos-waterfall-mode', appState.isWaterfall);
		applyViewModes();
		reRenderCachedNotes();
		updateEditorVisibility();
	});

	wideModeToggleBtn.addEventListener('click', () => {
		appState.isWide = !appState.isWide;
		localStorage.setItem('memos-wide-mode', appState.isWide);
		applyViewModes();
	});

	// --- 棰勫畾涔夌殑涓婚鑹?---
	const themeColors = [
		{ name: 'Blue', color: '#367cff', hover: '#2a63cc' },
		{ name: 'Green', color: '#42c251', hover: '#42c251' },
		{ name: 'Purple', color: '#805ad5', hover: '#6b46c1' },
		{ name: 'Orange', color: '#dd6b20', hover: '#c05621' },
		{ name: 'Pink', color: '#d53f8c', hover: '#b83280' },
		{ name: 'Red', color: '#e53e3e', hover: '#c53030' },
		{ name: 'Teal', color: '#3ad3ba', hover: '#287a78' },
		{ name: 'Yellow', color: '#d69e2e', hover: '#b7791f' }
	];

	// 鍔ㄦ€佸～鍏呴璁鹃鑹?
	fsColorPalette.innerHTML = themeColors.map(theme =>
		`<button class='color-swatch' data-color='${theme.color}' title='${theme.name}' style='background-color: ${theme.color};'></button>`
	).join('');

	// 点击棰滆壊鎸夐挳锛屾樉绀?隐藏闈㈡澘
	fsFontcolorBtn.addEventListener('click', (e) => {
		e.stopPropagation();
		fsColorPopover.classList.toggle('visible');
	});

	// 点击棰勮棰滆壊
	fsColorPalette.addEventListener('click', (e) => {
		const swatch = e.target.closest('.color-swatch');
		if (swatch) {
			const color = swatch.dataset.color;
			applyRichTextCommand('foreColor', color);
			// 更新鎸夐挳涓婄殑棰滆壊棰勮
			fsFontcolorBtn.querySelector('span').style.backgroundColor = color;
			fsColorPopover.classList.remove('visible');
		}
	});

	/**
	 * 涓€涓€氱敤鐨勩€佸彲鎾ら攢鐨勫瘜鏂囨湰鍛戒护鎵ц鍣?
	 */
	function applyRichTextCommand(command, value) {
		const textarea = fsEditorTextarea;
		// Markdown 璇硶涓嶆敮鎸佸瘜鏂囨湰锛屾墍浠ユ垜浠敤 HTML 鏍囩鍖呰９
		// 娉ㄦ剰锛氳繖浼氳浣犵殑绗旇鍐呭鍙樻垚 HTML 鍜?Markdown 鐨勬贩鍚堜綋
		let prefix, suffix;
		let selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
		if (!selectedText) return;
		if (command === 'foreColor') {
			selectedText = selectedText.replace(
				/<span style="color: .*?;">(.*?)<\/span>/g,
				'$1'
			);
			prefix = `<span style='color: ${value};'>`;
			suffix = `</span>`;
		} else if (command === 'fontSize') {
			prefix = `<span style='font-size: ${value};'>`;
			suffix = `</span>`;
		} else {
			return; // 涓嶆敮鎸佺殑鍛戒护
		}

		const start = textarea.selectionStart;
		const textToInsert = prefix + selectedText + suffix;

		document.execCommand('insertText', false, textToInsert);
		textarea.dispatchEvent(new Event('input', { bubbles: true }));
		const newCursorPosition = start + prefix.length + selectedText.length;
		textarea.selectionStart = newCursorPosition;
		textarea.selectionEnd = newCursorPosition;
		textarea.focus();
	}

	function setFullscreenViewMode(mode) {
		editorContentArea.dataset.viewMode = mode;
		viewModeSplitBtn.classList.toggle('active', mode === 'split');
		viewModePreviewBtn.classList.toggle('active', mode === 'preview');

		if (mode === 'source') {
			fsEditorTextarea.style.flexBasis = '100%';
		} else if (mode === 'preview') {
			fsPreviewPane.style.flexBasis = '100%';
		} else if (mode === 'split') {
			fsPreviewPane.style.flexBasis = '50%';
			fsEditorTextarea.style.flexBasis = '50%';
		}
	}

	// --- 閫氱敤鐨勫厓绱犳嫋鎷藉嚱鏁?---
	function makeDraggable(element, handle) {
		let currentX;
		let currentY;
		let initialX;
		let initialY;
		let xOffset = 0;
		let yOffset = 0;

		handle.onmousedown = dragMouseDown;

		function dragMouseDown(e) {
			e.preventDefault();
			// 获取榧犳爣鎸変笅鏃剁殑鍒濆浣嶇疆
			initialX = e.clientX - xOffset;
			initialY = e.clientY - yOffset;

			// 缁戝畾榧犳爣绉诲姩鍜屾澗寮€浜嬩欢
			document.onmouseup = closeDragElement;
			document.onmousemove = elementDrag;
		}

		function elementDrag(e) {
			e.preventDefault();
			currentX = e.clientX - initialX;
			currentY = e.clientY - initialY;
			xOffset = currentX;
			yOffset = currentY;
			element.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
		}

		function closeDragElement() {
			document.onmouseup = null;
			document.onmousemove = null;
		}
	}

	/**
	 * Settings: Tag Management
	 */
	async function loadSettingsTags() {
		const listContainer = document.getElementById('settings-tags-list');
		if (!listContainer) return;
		listContainer.innerHTML = '<li style="padding: 10px; text-align: center;">Loading tags...</li>';

		try {
			const response = await fetch('/api/tags');
			if (!response.ok) throw new Error('Failed to fetch tags');
			const tags = await response.json();

			listContainer.innerHTML = '';
			if (tags.length === 0) {
				listContainer.innerHTML = '<li style="padding: 10px; text-align: center; color: var(--text-secondary);">No tags found.</li>';
				return;
			}

			tags.forEach(tag => {
				const li = document.createElement('li');
				li.style.display = 'flex';
				li.style.justifyContent = 'space-between';
				li.style.alignItems = 'center';
				li.style.padding = '8px';
				li.style.borderBottom = '1px solid var(--border-color)';

				const nameSpan = document.createElement('span');
				nameSpan.textContent = `#${tag.name} (${tag.count})`;
				nameSpan.style.color = 'var(--text-primary)';

				const renameBtn = document.createElement('button');
				renameBtn.innerHTML = `
					<svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor">
						<path d="M0 0h24v24H0V0z" fill="none"/>
						<path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
					</svg>
				`;
				renameBtn.className = 'icon-btn';
				renameBtn.title = 'Rename Tag';
				renameBtn.onclick = () => handleRenameTagClick(tag.name);

				const actionsDiv = document.createElement('div');
				actionsDiv.appendChild(renameBtn);

				if (tag.count === 0) {
					const deleteBtn = document.createElement('button');
					deleteBtn.innerHTML = `
						<svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor">
							<path d="M0 0h24v24H0V0z" fill="none"/>
							<path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
						</svg>
					`;
					deleteBtn.className = 'icon-btn';
					deleteBtn.title = 'Delete Tag';
					deleteBtn.style.color = 'var(--error-color, #ff4444)';
					deleteBtn.onclick = () => handleDeleteTagClick(tag.name);
					actionsDiv.appendChild(deleteBtn);
				}

				li.appendChild(nameSpan);
				li.appendChild(actionsDiv);
				listContainer.appendChild(li);
			});
		} catch (error) {
			console.error('Error loading tags for settings:', error);
			listContainer.innerHTML = '<li style="padding: 10px; text-align: center; color: red;">Error loading tags.</li>';
		}
	}

	async function handleDeleteTagClick(tagName) {
		if (!confirm(`Are you sure you want to delete tag #${tagName}? This cannot be undone.`)) {
			return;
		}

		try {
			const response = await fetch(`/api/tags/${encodeURIComponent(tagName)}`, {
				method: 'DELETE'
			});

			if (!response.ok) {
				const err = await response.json();
				throw new Error(err.error || 'Failed to delete tag');
			}

			await loadSettingsTags();
			loadAndRenderTags(); // Update sidebar
			alert('Tag deleted successfully.');
		} catch (error) {
			alert(`Error: ${error.message}`);
		}
	}

	async function handleRenameTagClick(oldName) {
		const newName = prompt(`Rename tag #${oldName} to:`, oldName);
		if (!newName || newName === oldName || newName.trim() === '') return;

		const cleanNewName = newName.trim().replace(/^#/, '');
		if (!/^[\p{L}\p{N}_-]+$/u.test(cleanNewName)) {
			alert('Invalid tag name. Only letters, numbers, underscores, and hyphens are allowed.');
			return;
		}

		if (!confirm(`Are you sure you want to rename #${oldName} to #${cleanNewName}? This will update all matching notes.`)) {
			return;
		}

		try {
			const response = await fetch('/api/tags/rename', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ oldName, newName: cleanNewName })
			});

			if (!response.ok) {
				const err = await response.json();
				throw new Error(err.error || 'Failed to rename tag');
			}

			await loadSettingsTags();
			loadAndRenderTags();
			loadAndRenderTimeline();
			alert('Tag renamed successfully.');
		} catch (error) {
			alert(`Error: ${error.message}`);
		}
	}

	/**
	 * 鏍规嵁褰撳墠加载鐨勮缃紝搴旂敤鎵€鏈塙I鏁堟灉
	 */
	async function applySettings() {
		const isDarkMode = document.body.dataset.theme === 'dark';
		const baseSurfaceColor = isDarkMode ? settings.surfaceColorDark : settings.surfaceColor;
		const surfaceOpacity = settings.surfaceOpacity;
		let r = 255, g = 255, b = 255; // 榛樿鐧借壊
		if (/^#([A-Fa-f0-9]{3}){1,2}$/.test(baseSurfaceColor)) {
			let hex = baseSurfaceColor.substring(1).split('');
			if (hex.length === 3) {
				hex = [hex[0], hex[0], hex[1], hex[1], hex[2], hex[2]];
			}
			hex = '0x' + hex.join('');
			r = (hex >> 16) & 255;
			g = (hex >> 8) & 255;
			b = hex & 255;
		}
		const finalSurfaceColor = `rgba(${r}, ${g}, ${b}, ${surfaceOpacity})`;
		document.documentElement.style.setProperty('--surface-color', finalSurfaceColor);
		if (isDarkMode) {
			// 鍦ㄦ繁鑹叉ā寮忎笅锛屽皢 R, G, B 鍚勫鍔?24 (浣垮叾鍙樹寒)锛屼絾涓嶈秴杩?255
			const r_light = Math.min(255, r + 24);
			const g_light = Math.min(255, g + 24);
			const b_light = Math.min(255, b + 24);
			const finalInputBg = `rgb(${r_light}, ${g_light}, ${b_light})`;
			document.documentElement.style.setProperty('--surface-input-bg', finalInputBg);
		} else {
			// 鍦ㄦ祬鑹叉ā寮忎笅锛屼娇鐢ㄩ粯璁ょ殑鑳屾櫙鑹?
			document.documentElement.style.setProperty('--surface-input-bg', 'var(--bg-color)');
		}

		searchStatsContainer.style.display = settings.showSearchBar ? '' : 'none';
		statsCard.style.display = settings.showStatsCard ? '' : 'none';
		calendarWrapper.style.display = settings.showCalendar ? '' : 'none';
		tagsSectionWrapper.style.display = settings.showTags ? '' : 'none';
		timelineSectionWrapper.style.display = settings.showTimeline ? '' : 'none';
		rightSidebar.style.display = settings.showRightSidebar ? '' : 'none';
		heatmapContainerWrapper.style.display = settings.showHeatmap ? '' : 'none';
		notesSection.classList.toggle('date-grouping-enabled', settings.enableDateGrouping);

		const areAllSidebarsHidden = !settings.showSearchBar && !settings.showStatsCard && !settings.showCalendar && !settings.showTags && !settings.showTimeline;
		const currentDest = settings.imageUploadDestination || 'local';
		const radioToCheck = document.getElementById(`upload-dest-${currentDest}`);
		if (radioToCheck) {
			radioToCheck.checked = true;
		}
		imgurClientIdInput.value = settings.imgurClientId || '';

		if (areAllSidebarsHidden) {
			// 濡傛灉閮介殣钘忎簡锛屽氨缁欎富瀹瑰櫒添加 .no-sidebars 绫?
			appLayoutContainer.classList.add('no-sidebars');
		} else {
			// 鍚﹀垯锛岀‘淇濈Щ闄よ繖涓被锛屾仮澶嶅埌姝ｅ父鐨勪笁鏍忔垨瀹藉睆妯″紡
			appLayoutContainer.classList.remove('no-sidebars');
		}
		if (!settings.showRightSidebar) {
			appLayoutContainer.classList.add('no-right-sidebar');
		} else {
			appLayoutContainer.classList.remove('no-right-sidebar');
		}

		const isDefaultBg = settings.backgroundImage === defaultSettings.backgroundImage;
		const isLightMode = document.body.dataset.theme === 'light';

		// 鏉′欢锛氬彧鏈夊湪 (涓嶆槸娴呰壊妯″紡) OR (涓嶆槸榛樿鑳屾櫙) 鐨勬儏鍐典笅鎵嶅簲鐢ㄨ儗鏅?
		if (settings.backgroundImage && (!isLightMode || !isDefaultBg)) {
			// document.body.style.backgroundImage = `url(${settings.backgroundImage})`;
			document.documentElement.style.setProperty('--bg-image-url', `url(${settings.backgroundImage})`);

			document.body.classList.add('custom-background');
			appLayoutContainer.classList.add('glass-effect');
			const authForm = document.querySelector('.auth-form');
			if (authForm) authForm.classList.add('glass-effect');
		} else {
			// 鍚﹀垯锛岀Щ闄よ儗鏅?
			document.body.style.backgroundImage = '';
			document.body.classList.remove('custom-background');
			appLayoutContainer.classList.remove('glass-effect');
			const authForm = document.querySelector('.auth-form');
			if (authForm) authForm.classList.remove('glass-effect');
		}
		document.documentElement.style.setProperty('--bg-blur', `${settings.backgroundBlur}px`);
		document.documentElement.style.setProperty('--bg-opacity', settings.backgroundOpacity);
		scrollToHeatmapEnd();

		document.documentElement.style.setProperty('--waterfall-card-width', `${settings.waterfallCardWidth}px`);
	}

	/**
	 * 灏嗗綋鍓嶅姞杞界殑设置鍊硷紝鍚屾鍒拌缃脊妗嗙殑鎺т欢涓?
	 */
	async function updateSettingsModalControls() {
		const isDarkMode = document.body.dataset.theme === 'dark';
		const currentSurfaceColor = isDarkMode ? settings.surfaceColorDark : settings.surfaceColor;
		document.getElementById('surface-opacity-slider').value = settings.surfaceOpacity;
		document.getElementById('surface-color-picker-preview').style.backgroundColor = currentSurfaceColor;
		document.getElementById('surface-hex-color-input').value = currentSurfaceColor;
		document.getElementById('surface-color-picker-input').value = currentSurfaceColor;
		toggleSearchBar.checked = settings.showSearchBar;
		toggleStatsCard.checked = settings.showStatsCard;
		toggleCalendar.checked = settings.showCalendar;
		toggleTags.checked = settings.showTags;
		toggleTimeline.checked = settings.showTimeline;
		toggleRightSidebar.checked = settings.showRightSidebar;
		toggleEditorInWaterfall.checked = settings.hideEditorInWaterfall;
		toggleHeatmap.checked = settings.showHeatmap;
		bgOpacitySlider.value = settings.backgroundOpacity;
		bgImageUrl.value = settings.backgroundImage.startsWith('data:') ? '' : settings.backgroundImage; // 涓嶆樉绀篵ase64
		bgBlurSlider.value = settings.backgroundBlur;
		waterfallWidthSlider.value = settings.waterfallCardWidth;
		waterfallWidthValue.textContent = `${settings.waterfallCardWidth}px`;
		toggleDateGrouping.checked = settings.enableDateGrouping;
		toggleTelegramProxy.checked = settings.telegramProxy;
	}

	function initializeSettings() {
		surfaceOpacitySlider.addEventListener('input', (e) => {
			settings.surfaceOpacity = e.target.value
			applySettings();
		});
		restoreSurfaceBtn.addEventListener('click', () => {
			settings.surfaceOpacity = defaultSettings.surfaceOpacity;  // 更新褰撳墠鍊?
			settings.surfaceColor = defaultSettings.surfaceColor;
			settings.surfaceColorDark = defaultSettings.surfaceColorDark;
			applySettings();
			updateSettingsModalControls();
		});
		const handleSurfaceColorChange = (color) => {
			const isDarkMode = document.body.dataset.theme === 'dark';
			if (isDarkMode) {
				settings.surfaceColorDark = color;
			} else {
				settings.surfaceColor = color;
			}
			applySettings();
			updateSettingsModalControls();
		};

		surfaceColorPickerInput.addEventListener('input', (e) => {
			handleSurfaceColorChange(e.target.value);
		});

		surfaceHexColorInput.addEventListener('input', (e) => {
			const rawValue = e.target.value;
			if (/^#[0-9a-f]{6}$/i.test(rawValue)) {
				handleSurfaceColorChange(rawValue);
			}
		});
		toggleSearchBar.addEventListener('change', (e) => {
			settings.showSearchBar = e.target.checked;
			applySettings();
		});
		toggleStatsCard.addEventListener('change', (e) => {
			settings.showStatsCard = e.target.checked;
			applySettings();
		});
		toggleCalendar.addEventListener('change', (e) => {
			settings.showCalendar = e.target.checked;
			applySettings();
		});
		toggleTags.addEventListener('change', (e) => {
			settings.showTags = e.target.checked;
			applySettings();
		});
		toggleTimeline.addEventListener('change', (e) => {
			settings.showTimeline = e.target.checked;
			applySettings();
		});
		toggleRightSidebar.addEventListener('change', (e) => {
			settings.showRightSidebar = e.target.checked;
			applySettings();
		});
		toggleHeatmap.addEventListener('change', (e) => {
			settings.showHeatmap = e.target.checked;
			applySettings();
		});
		uploadDestinationRadios.forEach(radio => {
			radio.addEventListener('change', (e) => {
				const destination = e.target.value;
				settings.imageUploadDestination = destination;
			});
		});
		toggleDateGrouping.addEventListener('change', (e) => {
			const isEnabled = e.target.checked;
			settings.enableDateGrouping = isEnabled;
			if (!isEnabled) {
				notesContainer.innerHTML = '';
			}
			applySettings();
			reloadNotes();
		});
		imgurClientIdInput.addEventListener('input', (e) => {
			settings.imgurClientId = e.target.value.trim();
		});
		bgOpacitySlider.addEventListener('input', (e) => {
			settings.backgroundOpacity = e.target.value;
			applySettings();
		});
		toggleEditorInWaterfall.addEventListener('change', (e) => {
			settings.hideEditorInWaterfall = e.target.checked;
			updateEditorVisibility();
		});
		bgImageUrl.addEventListener('input', (e) => {
			settings.backgroundImage = e.target.value;
			applySettings();
		});

		bgImageUpload.addEventListener('change', (e) => {
			const file = e.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = (event) => {
					settings.backgroundImage = event.target.result;
					applySettings();
				};
				reader.readAsDataURL(file);
			}
		});

		bgBlurSlider.addEventListener('input', (e) => {
			settings.backgroundBlur = e.target.value;
			applySettings();
		});

		clearBgBtn.addEventListener('click', () => {
			bgImageUrl.value = '';
			bgImageUpload.value = '';
			bgBlurSlider.value = defaultSettings.backgroundBlur;
			bgOpacitySlider.value = defaultSettings.backgroundOpacity;
			settings.backgroundImage = '';
			settings.backgroundBlur = defaultSettings.backgroundBlur;
			settings.backgroundOpacity = defaultSettings.backgroundOpacity;
			applySettings();
		});
		restoreBgBtn.addEventListener('click', () => {
			const defaultBg = defaultSettings.backgroundImage;
			const defaultBlur = defaultSettings.backgroundBlur;
			const defaultOpacity = defaultSettings.backgroundOpacity;

			bgImageUrl.value = defaultBg.startsWith('data:') ? '' : defaultBg;
			bgImageUpload.value = '';
			bgBlurSlider.value = defaultBlur;
			bgOpacitySlider.value = defaultOpacity;
			settings.backgroundImage = defaultBg;
			settings.backgroundBlur = defaultBlur;
			settings.backgroundOpacity = defaultOpacity;
			applySettings();
		});
		waterfallWidthSlider.addEventListener('input', (e) => {
			const width = e.target.value;
			waterfallWidthValue.textContent = `${width}px`;
			settings.waterfallCardWidth = width;
			applySettings();
		});
		toggleTelegramProxy.addEventListener('change', (e) => {
			settings.telegramProxy = e.target.checked;
		});
		const settingsBtn = document.getElementById('settings-btn');
		if (settingsBtn) {
			settingsBtn.addEventListener('click', () => {
				updateSettingsModalControls();
				loadSettingsTags(); // Load tags
				settingsModalOverlay.classList.add('visible');
				settingsModalOverlay.querySelector('.custom-modal-box').classList.add('active');
			});
		}

		const closeSettingsModal = () => {
			saveSettings();
			settingsModalOverlay.classList.remove('visible');
			settingsModalOverlay.querySelector('.custom-modal-box').classList.remove('active');
		};

		closeSettingsBtn.addEventListener('click', closeSettingsModal);

		// --- 点击閬僵灞傦紙澶栭儴锛夊叧闂脊妗?---
		settingsModalOverlay.addEventListener('click', (e) => {
			// 妫€鏌ョ偣鍑荤殑鏄惁鏄伄缃╁眰鏈韩锛岃€屼笉鏄脊妗嗗唴瀹?
			if (e.target === settingsModalOverlay) {
				closeSettingsModal();
			}
		});
		makeDraggable(document.getElementById('settings-modal-box'), document.querySelector('.settings-header'));
		applySettings();
	}


	// --- 涓虹€戝竷娴佽彍鍗曠殑鎸夐挳添加浜嬩欢濮旀墭 ---
	waterfallPopoverMenu.addEventListener('click', async (e) => {
		const actionButton = e.target.closest('.icon-btn');
		if (!actionButton) return;
		const action = actionButton.dataset.action;
		const noteId = waterfallPopoverMenu.dataset.noteId;
		if (!noteId) return;
		// 鍏堥殣钘忚彍鍗曪紝鎻愪緵鍗虫椂鍙嶉
		hideWaterfallPopover();

		const noteElement = notesContainer.querySelector(`.note[data-id="${noteId}"]`);

		switch (action) {
			case 'view': {
				const noteData = allNotesCache.find(n => n.id === parseInt(noteId, 10));
				if (noteData) {
					// 璋冪敤鍏ㄥ睆缂栬緫鍣紝骞跺畾鍒跺叾琛屼负
					openFullscreenEditor(noteData.content, noteId, {
						defaultViewMode: 'split'
					});
				}
				break;
			}

			case 'delete': {
				if (!noteElement) return;
				const confirmed = await showCustomConfirm('Are you sure you want to delete this note?');
				if (!confirmed) return;

				// 澶嶇敤鐜版湁鐨勫垹闄ら€昏緫
				waterfallObserver.unobserve(noteElement);
				try {
					await fetch(`/api/notes/${noteId}`, { method: 'DELETE' });
					noteElement.remove();
				} catch (error) {
					waterfallObserver.observe(noteElement);
					showCustomAlert(error.message, 'error');
				}
				break;
			}
		}
	});
	waterfallPopoverMenu.addEventListener('mouseenter', () => {
		clearTimeout(waterfallPopoverHideTimer);
	});

	waterfallPopoverMenu.addEventListener('mouseleave', () => {
		hideWaterfallPopover();
	});
	function showWaterfallPopover(targetButton, noteId) {
		clearTimeout(waterfallPopoverHideTimer);
		if (waterfallPopoverMenu.classList.contains('visible') && activePopoverNoteId === noteId) {
			return;
		}
		// 获取鎸夐挳鐨勪綅缃俊鎭紝浠ヤ究瀹氫綅鑿滃崟
		const btnRect = targetButton.getBoundingClientRect();
		// top: 鎸夐挳搴曢儴 + 椤甸潰婊氬姩璺濈 + 涓€鐐归棿璺?
		// left: 鎸夐挳宸︿晶 - 鑿滃崟瀹藉害 + 鎸夐挳瀹藉害 (浣垮叾鍙冲榻?
		waterfallPopoverMenu.style.top = `${btnRect.bottom + 5}px`;
		waterfallPopoverMenu.style.left = `${btnRect.right - waterfallPopoverMenu.offsetWidth}px`;
		// 瀛樺偍褰撳墠绗旇ID锛屽苟显示鑿滃崟
		activePopoverNoteId = noteId;
		waterfallPopoverMenu.dataset.noteId = noteId; // 灏咺D瀛樺埌鑿滃崟涓婏紝鏂逛究鍚庣画鎿嶄綔
		waterfallPopoverMenu.classList.add('visible');
	}

	/**
	 * 隐藏鈥滄洿澶氣€濇搷浣滆彍鍗?
	 */
	function hideWaterfallPopover() {
		clearTimeout(waterfallPopoverHideTimer);
		waterfallPopoverHideTimer = setTimeout(() => {
			waterfallPopoverMenu.classList.remove('visible');
			activePopoverNoteId = null;
		}, 200);
	}

	// --- 鍙充晶鏍廡ab鎸夐挳鐨勪氦浜掗€昏緫 ---
	function updateSidebarTabsUI() {
		document.querySelectorAll('.sidebar-tab-btn').forEach(btn => {
			btn.classList.toggle('active', btn.dataset.tabName === appState.baseMode);
		});
	}

	homeTabBtn.addEventListener('click', () => {
		if (appState.baseMode === 'home') return;
		appState.baseMode = 'home';
		updateSidebarTabsUI();
		updateEditorVisibility();
		// Hide attachments viewer and show notes section
		attachmentsViewer.style.display = 'none';
		document.getElementById('notes-section').style.display = 'block';
		reloadNotes();
	});

	favoritesTabBtn.addEventListener('click', () => {
		if (appState.baseMode === 'favorites') return;
		appState.baseMode = 'favorites';
		updateSidebarTabsUI();
		updateEditorVisibility();
		// Hide attachments viewer and show notes section
		attachmentsViewer.style.display = 'none';
		document.getElementById('notes-section').style.display = 'block';
		reloadNotes();
	});

	archiveTabBtn.addEventListener('click', () => {
		if (appState.baseMode === 'archive') return;
		appState.baseMode = 'archive';
		updateSidebarTabsUI();
		updateEditorVisibility();
		// Hide attachments viewer and show notes section
		attachmentsViewer.style.display = 'none';
		document.getElementById('notes-section').style.display = 'block';
		reloadNotes();
	});


	// 鏃х殑閲嶅浜嬩欢鐩戝惉鍣ㄥ凡删除 - 鐜板湪浣跨敤绗?002琛岀殑鏂扮増鏈?


	// 鏃х殑 loadAttachments 鍑芥暟宸插垹闄?


	// 鏃х殑 renderAttachments 鍑芥暟宸插垹闄?


	// 鏃х殑 updateAttachmentsPagination 鍑芥暟鍜岄噸澶嶇殑 tab 浜嬩欢鐩戝惉鍣ㄥ凡删除




	/**
	 * 鍒濆鍖栦晶杈规爮鐨勬姌鍙犵姸鎬?
	 * 浠?localStorage 读取鐢ㄦ埛鐨勫亸濂藉苟搴旂敤
	 */
	function initializeCollapsibleSidebars() {
		const sections = ['tags-section-wrapper', 'timeline-section-wrapper'];

		sections.forEach(sectionId => {
			const sectionElement = document.getElementById(sectionId);
			// 读取 localStorage锛屽鏋滃€间负 'true'锛屽垯添加 is-collapsed 绫?
			if (localStorage.getItem(`sidebar-${sectionId}-collapsed`) === 'true') {
				sectionElement.classList.add('is-collapsed');
			}
		});
	}

	// 浣跨敤浜嬩欢濮旀墭锛屼负鎵€鏈夋姌鍙犳寜閽坊鍔犵偣鍑讳簨浠?
	document.getElementById('app-layout-container').addEventListener('click', (e) => {
		const toggleBtn = e.target.closest('.sidebar-toggle-btn');
		if (toggleBtn) {
			const parentContent = toggleBtn.closest('.sidebar-content');
			if (parentContent) {
				parentContent.classList.toggle('is-collapsed');
				const isCollapsed = parentContent.classList.contains('is-collapsed');
				localStorage.setItem(`sidebar-${parentContent.id}-collapsed`, isCollapsed);
			}
		}
	});

	async function loadAndRenderStats() {
		try {
			const response = await fetch('/api/stats');
			if (!response.ok) throw new Error('Failed to fetch stats');
			const stats = await response.json();

			// 璁＄畻澶╂暟
			let days = 0;
			if (stats.oldestNoteTimestamp) {
				const oldestDate = new Date(stats.oldestNoteTimestamp);
				const today = new Date();
				// 设置鏃堕棿涓哄綋澶╃殑寮€濮嬶紝避免鏃跺尯鍜屽皬鏃跺樊寮傚鑷磋绠楅敊璇?
				oldestDate.setHours(0, 0, 0, 0);
				today.setHours(0, 0, 0, 0);

				const diffTime = Math.abs(today - oldestDate);
				const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
				days = diffDays;
			}
			statsDays.textContent = days;
			statsMemos.textContent = stats.memos;
			statsTags.textContent = stats.tags;
		} catch (error) {
			console.error('Error loading stats:', error);
			statsDays.textContent = '0';
			statsMemos.textContent = '0';
			statsTags.textContent = '0';
		}
	}
	async function loadAndRenderHeatmap(timelineData) {
		try {
			const countsByDate = new Map();
			for (const year in timelineData) {
				for (const month in timelineData[year].months) {
					for (const day in timelineData[year].months[month].days) {
						const count = timelineData[year].months[month].days[day].count;
						const monthPadded = month.toString().padStart(2, '0');
						const dayPadded = day.toString().padStart(2, '0');
						const dateString = `${year}-${monthPadded}-${dayPadded}`;
						countsByDate.set(dateString, count);
					}
				}
			}
			notesDataByDate.clear();
			countsByDate.forEach((count, dateString) => {
				notesDataByDate.set(dateString, count);
			});
			calendarInstance = new Calendar(calendarWrapper, notesDataByDate);
			const today = new Date();
			const daysToShow = 180;
			const grid = document.createElement('div');
			grid.id = 'heatmap-grid';

			const firstDateToRender = new Date(today);
			firstDateToRender.setDate(today.getDate() - (daysToShow - 1));
			const startDayOfWeek = (firstDateToRender.getDay() + 6) % 7;
			for (let i = 0; i < startDayOfWeek; i++) {
				const placeholder = document.createElement('div');
				placeholder.className = 'heatmap-day placeholder';
				grid.appendChild(placeholder);
			}
			for (let i = 0; i < daysToShow; i++) {
				const date = new Date(firstDateToRender);
				date.setDate(firstDateToRender.getDate() + i);

				const year = date.getFullYear();
				const month = (date.getMonth() + 1).toString().padStart(2, '0');
				const dayOfMonth = date.getDate().toString().padStart(2, '0');
				const dateString = `${year}-${month}-${dayOfMonth}`;

				const count = countsByDate.get(dateString) || 0;

				let level = 0;
				if (count > 0 && count <= 2) level = 1;
				else if (count > 2 && count <= 5) level = 2;
				else if (count > 5 && count <= 8) level = 3;
				else if (count > 8) level = 4;

				const dayElement = document.createElement('div');
				dayElement.className = 'heatmap-day';
				dayElement.dataset.date = dateString;
				dayElement.dataset.count = count;
				dayElement.dataset.level = level;
				grid.appendChild(dayElement);
			}

			heatmapContainerWrapper.innerHTML = '';
			const scrollContainer = document.createElement('div');
			scrollContainer.id = 'heatmap-scroll-container';
			scrollContainer.appendChild(grid);
			heatmapContainerWrapper.appendChild(scrollContainer);

			scrollToHeatmapEnd();
			initializeHeatmapDragToScroll();

		} catch (error) {
			console.error('Error loading heatmap:', error);
			heatmapContainerWrapper.innerHTML = '<p style="font-size: 0.8rem; color: var(--text-secondary);">Could not load activity data.</p>';
		}
	}

	// --- 鐑姏鍥句氦浜掍簨浠?(浜嬩欢濮旀墭) ---
	heatmapContainerWrapper.addEventListener('mouseover', (e) => {
		const dayElement = e.target.closest('.heatmap-day');
		if (dayElement) {
			const date = dayElement.dataset.date;
			const count = dayElement.dataset.count;
			const countText = count === '1' ? '1 note' : `${count} notes`;

			heatmapTooltip.textContent = `${countText} on ${date}`;
			heatmapTooltip.style.display = 'block';
		}
	});

	heatmapContainerWrapper.addEventListener('mousemove', (e) => {
		// 璁?tooltip 璺熼殢榧犳爣绉诲姩
		heatmapTooltip.style.left = `${e.pageX}px`;
		heatmapTooltip.style.top = `${e.pageY}px`;
	});

	heatmapContainerWrapper.addEventListener('mouseout', () => {
		heatmapTooltip.style.display = 'none';
	});

	heatmapContainerWrapper.addEventListener('click', (e) => {
		const dayElement = e.target.closest('.heatmap-day');
		if (dayElement && dayElement.dataset.count > 0) {
			const dateString = dayElement.dataset.date; // "YYYY-MM-DD"

			// --- 澶嶇敤涔嬪墠鐨勬棩鏈熺瓫閫夐€昏緫 ---
			const [year, month, day] = dateString.split('-').map(Number);
			const monthIndex = month - 1;

			const startOfDay = new Date(year, monthIndex, day);
			const endOfDay = new Date(year, monthIndex, day + 1);

			appState.filters.date = {
				startTimestamp: startOfDay.getTime(),
				endTimestamp: endOfDay.getTime()
			};

			document.querySelectorAll('#timeline-container .timeline-item.active').forEach(i => i.classList.remove('active'));
			clearFilterBtn.classList.add('visible');

			reloadNotes();
		}
	});

	let searchDebounceTimer;
	// 闃叉姈鍑芥暟锛氬欢杩熸墽琛岋紝避免棰戠箒璇锋眰 API
	function debounce(func, delay) {
		return function (...args) {
			clearTimeout(searchDebounceTimer);
			searchDebounceTimer = setTimeout(() => {
				func.apply(this, args);
			}, delay);
		};
	}

	async function performSearch(query) {
		appState.filters.query = query;
		clearSearchBtn.style.display = query ? 'block' : 'none';
		reloadNotes();
	}

	function handleEditorShortcuts(event) {
		const textarea = event.target;
		if (!textarea.matches('textarea')) return;
		// --- Ctrl+X 鍓垏褰撳墠琛?---
		if (event.ctrlKey && event.key.toLowerCase() === 'x') {
			// 浠呭綋娌℃湁鏂囨湰琚€変腑鏃讹紝鎵嶆墽琛屽壀鍒囪閫昏緫
			if (textarea.selectionStart === textarea.selectionEnd) {
				event.preventDefault(); // 闃绘榛樿琛屼负锛屾垜浠皢鎵嬪姩处理

				const cursorPosition = textarea.selectionStart;
				const text = textarea.value;

				// 鎵惧埌褰撳墠琛岀殑璧峰鍜岀粨鏉熶綅缃?
				const lineStart = text.lastIndexOf('\n', cursorPosition - 1) + 1;
				let lineEnd = text.indexOf('\n', cursorPosition);
				if (lineEnd === -1) {
					lineEnd = text.length;
				}

				// 閫変腑鏁磋锛堝寘鎷湯灏剧殑鎹㈣绗︼紝濡傛灉鏈夌殑璇濓級
				textarea.setSelectionRange(lineStart, lineEnd + 1);
				// 杩欐牱鍋氱殑濂藉鏄畠浼氳嚜鍔ㄥ鐞嗗壀璐存澘锛屽苟涓旀搷浣滄槸鍙挙閿€鐨?
				document.execCommand('cut');
			}
		}
	}

	// 鐩戝惉杈撳叆妗嗙殑 'input' 浜嬩欢
	globalSearchInput.addEventListener('input', debounce(e => {
		const query = e.target.value.trim();
		if (query.length === 0 || query.length >= 2) {
			performSearch(query);
		}
	}, 300)); // 寤惰繜300姣鎵ц鎼滅储
	/**
	 * 鐩戝惉鎼滅储妗嗙殑 'keydown' 浜嬩欢锛屼互鎹曡幏鍥炶溅閿?
	 */
	globalSearchInput.addEventListener('keydown', e => {
		if (e.key === 'Enter') {
			e.preventDefault();
			const query = e.target.value.trim();
			if (query.length === 0 || query.length >= 2) {
				clearTimeout(searchDebounceTimer);
				performSearch(query);
			}
		}
	});
	// 娓呴櫎鎸夐挳鐨勭偣鍑讳簨浠?
	clearSearchBtn.addEventListener('click', () => {
		globalSearchInput.value = '';
		performSearch('');
		globalSearchInput.focus();
	});

	let currentEditingNoteId = null;
	let isFullscreenMode = false;
	function openFullscreenEditor(content = '', noteId = null, options = {}) {
		currentEditingNoteId = noteId;
		fsEditorTextarea.value = content;
		fsPreviewPane.innerHTML = postProcessMarkdownHtml(marked.parse(content));

		const defaultView = options.defaultViewMode || 'split'; // 榛樿split
		setFullscreenViewMode(defaultView);
		editorContentArea.dataset.viewMode = defaultView;
		fullscreenEditorOverlay.classList.add('visible');
		fullscreenEditorBox.classList.add('active');
		isFullscreenMode = true;
		fsEditorTextarea.focus();
	}

	// 鍏抽棴缂栬緫鍣?
	function closeFullscreenEditor() {
		fullscreenEditorOverlay.classList.remove('visible');
		fullscreenEditorBox.classList.remove('active');
		isFullscreenMode = false;
		currentEditingNoteId = null;
	}

	viewModeSplitBtn.addEventListener('click', () => {
		// 濡傛灉褰撳墠宸茬粡鏄垎灞忔ā寮忥紝鍐嶆点击鍒欏垏鎹㈠洖婧愮爜妯″紡
		if (editorContentArea.dataset.viewMode === 'split') {
			setFullscreenViewMode('source');
		} else {
			setFullscreenViewMode('split');
		}
	});
	// 点击棰勮鎸夐挳
	viewModePreviewBtn.addEventListener('click', () => {
		// 濡傛灉褰撳墠宸茬粡鏄瑙堟ā寮忥紝鍐嶆点击鍒欏垏鎹㈠洖婧愮爜妯″紡
		if (editorContentArea.dataset.viewMode === 'preview') {
			setFullscreenViewMode('source');
		} else {
			setFullscreenViewMode('preview');
		}
	});

	// 瀹炴椂更新棰勮
	fsEditorTextarea.addEventListener('input', () => {
		fsPreviewPane.innerHTML = postProcessMarkdownHtml(marked.parse(fsEditorTextarea.value));
	});

	// 点击涓诲垱寤哄尯鐨勫叏灞忔寜閽?
	enterFullscreenBtn.addEventListener('click', () => {
		// 灏嗕富杈撳叆妗嗙殑鍐呭甯﹀叆鍏ㄥ睆缂栬緫鍣?
		openFullscreenEditor(noteInput.value, null);
	});
	let isDragging = false;
	fsEditorDivider.addEventListener('mousedown', (e) => {
		e.preventDefault(); // 闃叉鎷栨嫿鏃堕€変腑鏂囧瓧
		isDragging = true;
		document.body.style.cursor = 'col-resize';
		document.body.style.userSelect = 'none';
		window.addEventListener('mousemove', handleDrag);
		window.addEventListener('mouseup', stopDrag);
		window.addEventListener('blur', stopDrag);
	});

	function handleDrag(e) {
		if (!isDragging) return;

		const container = editorContentArea;
		const containerRect = container.getBoundingClientRect();
		const mouseX = e.clientX - containerRect.left;
		let leftPaneWidth = (mouseX / containerRect.width) * 100;
		const minWidthPercent = 15;
		if (leftPaneWidth < minWidthPercent) {
			leftPaneWidth = minWidthPercent;
		}
		if (leftPaneWidth > (100 - minWidthPercent)) {
			leftPaneWidth = 100 - minWidthPercent;
		}
		const rightPaneWidth = 100 - leftPaneWidth;
		// 浣跨敤 flex-basis 鏉ヨ缃搴?
		fsEditorTextarea.style.flexBasis = `${leftPaneWidth}%`;
		fsPreviewPane.style.flexBasis = `${rightPaneWidth}%`;
	}

	function stopDrag() {
		if (!isDragging) return;
		isDragging = false;
		// 移除全局样式
		document.body.style.cursor = '';
		document.body.style.userSelect = '';
		// 解绑事件
		window.removeEventListener('mousemove', handleDrag);
		window.removeEventListener('mouseup', stopDrag);
		window.removeEventListener('blur', stopDrag);
	}

	editorToolbar.addEventListener('click', e => {
		const target = e.target.closest('.toolbar-btn');
		if (!target) return;

		const textarea = fsEditorTextarea;
		const mdType = target.dataset.md;
		const start = textarea.selectionStart;
		const end = textarea.selectionEnd;
		const selectedText = textarea.value.substring(start, end);

		// 璁╂祻瑙堝櫒鎵ц鍘熺敓鐨勩€佸彲鎾ら攢鐨勬彃鍏ュ懡浠?
		const applyMarkdown = (prefix, suffix = prefix) => {
			textarea.focus();
			document.execCommand('insertText', false, prefix + selectedText + suffix);
			const newCursorPosition = start + prefix.length + selectedText.length;
			textarea.selectionStart = newCursorPosition;
			textarea.selectionEnd = newCursorPosition;
			textarea.focus();
		};

		switch (mdType) {
			case 'bold':
				applyMarkdown('**');
				break;
			case 'underline':
				applyMarkdown('<u>', '</u>');
				break;
			case 'italic':
				applyMarkdown('*');
				break;
			case 'strike':
				applyMarkdown('~~');
				break;
			case 'blockquote':
				applyMarkdown('> ', '');
				break;
			case 'link':
				const url = prompt('Enter the URL:', 'https://');
				if (url) applyMarkdown('[', `](${url})`);
				break;
			case 'image':
				const imgUrl = prompt('Enter the image URL:');
				if (imgUrl) applyMarkdown('![', `](${imgUrl})`);
				break;
			case 'code':
				applyMarkdown('\n```\n', '\n```');
				break;
		}
		// 手动触发input事件锛岀‘淇濋瑙堣兘澶熷疄鏃舵洿鏂?
		textarea.dispatchEvent(new Event('input', { bubbles: true }));
	});

	// 瀛椾綋澶у皬閫夋嫨
	fsFontsizeSelector.addEventListener('change', (e) => {
		const size = e.target.value;
		if (size) {
			applyRichTextCommand('fontSize', size);
		}
		e.target.value = ''; // 姣忔閫夋嫨鍚庨噸缃紝浠ヤ究鍙互閲嶅閫夋嫨鐩稿悓澶у皬
	});

	// 涓哄叏灞忕紪杈戝櫒缁戝畾
	// 閿洏蹇嵎閿?
	fsEditorTextarea.addEventListener('keydown', e => {
		handleEditorShortcuts(e);
		handleListAutoInsertion(e);
		handleTabIndentation(e);
		if (e.ctrlKey) {
			let mdType = null;
			if (e.key === 'b') mdType = 'bold';
			if (e.key === 'i') mdType = 'italic';
			if (e.key === 'k') mdType = 'link';

			if (mdType) {
				e.preventDefault();
				// 妯℃嫙点击瀵瑰簲鐨勬寜閽?
				document.querySelector(`.toolbar-btn[data-md="${mdType}"]`).click();
			}
		}
	});


	fsCancelBtn.addEventListener('click', closeFullscreenEditor);
	fsSaveBtn.addEventListener('click', async () => {
		const content = fsEditorTextarea.value;
		fsSaveBtn.disabled = true;
		fsSaveBtn.textContent = 'Saving...';

		try {
			if (currentEditingNoteId === null) {
				const content = fsEditorTextarea.value;
				// 妾㈡煡鍏у鍜屾枃浠舵槸鍚﹂兘鐐虹┖
				if (!content.trim() && noteFile.files.length === 0) {
					showCustomAlert('Content or a file is required.', 'error');
					// 鎭㈠京鎸夐垥鐙€鎱?
					fsSaveBtn.disabled = false;
					fsSaveBtn.textContent = 'Save';
					return; // 鎻愬墠杩斿洖
				}

				const formData = new FormData();
				// 1. 添加寰炲叏灞忕法杓櫒鐛插彇鐨勬柊鏂囨湰鍏у
				formData.append('content', content);
				// 2. 寰炰富鐣岄潰鐨?noteFile 杓稿叆妗嗕腑鐛插彇鏂囦欢涓︽坊鍔犲埌 formData
				Array.from(noteFile.files).forEach(file => {
					formData.append('file', file);
				});

				try {
					const res = await fetch('/api/notes', { method: 'POST', body: formData });
					if (!res.ok) throw new Error(`Save failed: ${await res.text()}`);

					noteForm.reset(); // 浣跨敤 reset() 鍙互鍚屾檪娓呯┖鏂囨湰鍜屾枃浠惰几鍏?
					updateMainFileDisplay(); // 更新涓荤晫闈㈢殑鏂囦欢鍒楄〃椤ず
					closeFullscreenEditor();
					await refreshNotes();

				} catch (error) {
					showCustomAlert(error.message, 'error');
				} finally {
					fsSaveBtn.disabled = false;
					fsSaveBtn.textContent = 'Save';
				}

			} else { // 缂栬緫鐜版湁绗旇
				const noteElement = notesContainer.querySelector(`.note[data-id="${currentEditingNoteId}"]`);
				if (!noteElement) {
					showCustomAlert('Error: Original note element not found.', 'error');
					return;
				}

				fsSaveBtn.disabled = true;
				fsSaveBtn.textContent = 'Saving...';
				const formData = new FormData();
				// 1. 添加浠庡叏灞忕紪杈戝櫒获取鐨勬柊鍐呭
				formData.append('content', content);

				// 2. 浠庡師濮嬬殑 noteElement 涓幏鍙栨枃浠剁姸鎬佸苟添加鍒?formData
				// 获取宸叉爣璁板垹闄ょ殑鏂囦欢
				const filesToDelete = Array.from(noteElement.querySelectorAll('.edit-file-tag[data-deleted="true"]')).map(t => t.dataset.fileId);
				formData.append('filesToDelete', JSON.stringify(filesToDelete));

				// 获取鏂版坊鍔犵殑鏂囦欢 (濡傛灉鐢ㄦ埛鍏堟坊鍔犳枃浠跺啀杩涘叆鍏ㄥ睆)
				if (noteElement.newFiles && noteElement.newFiles.length > 0) {
					Array.from(noteElement.newFiles).forEach(file => formData.append('file', file));
				}

				try {
					// 1. Capture scroll and element position
					const currentScrollY = window.scrollY;
					const oldNoteElement = notesContainer.querySelector(`.note[data-id="${currentEditingNoteId}"]`);
					if (!oldNoteElement) {
						showCustomAlert('Error: Original note element not found for scroll tracking.', 'error');
						return;
					}
					const oldNoteOffsetTop = oldNoteElement.getBoundingClientRect().top + window.scrollY; // Position relative to document

					// 2. Perform save operation
					const res = await fetch(`/api/notes/${currentEditingNoteId}`, { method: 'PUT', body: formData });
					if (!res.ok) throw new Error(`Update failed: ${await res.text()}`);
					const updatedNoteResponse = await res.json();
					const updatedNote = updatedNoteResponse.note;


					if (!updatedNote || typeof updatedNote.id === 'undefined') {
						throw new Error('Server response missing updated note data.');
					}

					// 3. Create a *new* noteElement
					const newNoteElement = createNoteElement(updatedNote);

					// 4. Replace old with new
					if (oldNoteElement.parentNode) {
						oldNoteElement.parentNode.replaceChild(newNoteElement, oldNoteElement);
						if (appState.isWaterfall) {
							waterfallObserver.observe(newNoteElement);
						}
					} else {
						console.warn('Parent node of oldNoteElement not found during replacement.');
					}

					// 5. Restore scroll position
					const newNoteOffsetTop = newNoteElement.getBoundingClientRect().top + window.scrollY; // Position relative to document
					const scrollDelta = newNoteOffsetTop - oldNoteOffsetTop;
					window.scrollTo(0, currentScrollY + scrollDelta);

					// 6. Update allNotesCache
					const indexInCache = allNotesCache.findIndex(n => n.id === updatedNote.id);
					if (indexInCache !== -1) {
						allNotesCache[indexInCache] = updatedNote;
					}

					closeFullscreenEditor(); // Close editor after successful save

				} catch (error) {
					showCustomAlert(error.message, 'error');
				} finally {
					fsSaveBtn.disabled = false;
					fsSaveBtn.textContent = 'Save';
				}
			}
		} catch (error) {
			showCustomAlert(error.message, 'error');
		} finally {
			fsSaveBtn.disabled = false;
			fsSaveBtn.textContent = 'Save';
		}
	});

	selectFilesBtn.addEventListener('click', () => {
		noteFile.click();
	});
	const applyTheme = (theme) => {
		document.body.dataset.theme = theme;
		document.documentElement.dataset.theme = theme;
		localStorage.setItem('theme', theme);
		const sunIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">' +
			'<path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.99 4.58zm12.02 12.02c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.06-1.06zM20 6.01c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06zM7.05 18.01c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06z">' +
			'</path>' +
			'</svg><span>Light Mode</span>';
		const moonIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z">' +
			'</path></svg><span>Dark Mode</span>';
		themeToggleBtn.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
		document.getElementById('hljs-light-theme').disabled = (theme === 'dark');
		document.getElementById('hljs-dark-theme').disabled = (theme !== 'dark');
		applySettings();
	};

	const toggleTheme = () => {
		const currentTheme = document.body.dataset.theme || 'light';
		const newTheme = currentTheme === 'light' ? 'dark' : 'light';
		applyTheme(newTheme);
	};

	const initializeTheme = () => {
		const savedTheme = localStorage.getItem('theme');
		const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
		applyTheme(savedTheme || (systemPrefersDark ? 'dark' : 'light'));
	};

	themeToggleBtn.addEventListener('click', toggleTheme);

	const iconEnterFullWidth = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"></path></svg>';
	const iconExitFullWidth = iconEnterFullWidth;

	function initializeViewMode() {
		appState.isWide = localStorage.getItem('memos-wide-mode') === 'true';
		appState.isWaterfall = localStorage.getItem('memos-waterfall-mode') === 'true';
		applyViewModes();
	}

	function updateEditorVisibility() {
		let shouldShow = false; // 榛樿隐藏
		// 鏉′欢1: 鍩虹妯″紡蹇呴』鏄?'home'
		if (appState.baseMode === 'home') {
			shouldShow = true;
		}
		// 鏉′欢2: 濡傛灉鐎戝竷娴佸紑鍚紝骞朵笖设置浜嗏€滈殣钘忊€濓紝鍒欏己鍒堕殣钘?
		if (appState.isWaterfall && settings.hideEditorInWaterfall) {
			shouldShow = false;
		}
		noteForm.style.display = shouldShow ? 'block' : 'none';
	}

	// --- State ---
	let allNotesCache = [];
	let noteCounter = 1;
	const textFileExtensions = ['txt', 'js', 'json', 'py', 'css', 'html', 'md', 'sh', 'java', 'c', 'cpp', 'go', 'rb', 'xml', 'log', 'yaml', 'toml', 'yml'];

	let currentFilter = {
		type: 'all', // 'all', 'date'
		value: null
	};

	// --- Utility Functions ---
	const formatBytes = (b, d = 2) => {
		if (b === 0) return '0 Bytes';
		const k = 1024, s = ['B', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(b) / Math.log(k));
		return parseFloat((b / Math.pow(k, i)).toFixed(d)) + ' ' + s[i];
	};

	// 1. 鍒涘缓涓€涓嚱鏁版潵璁＄畻骞惰缃崟涓瑪璁扮殑琛岃法搴?
	const setNoteRowSpan = (noteElement) => {
		const notesContainer = document.getElementById('notes-container');
		if (!notesContainer) return;

		// 获取grid鐨勮闂磋窛
		const rowGap = parseFloat(getComputedStyle(notesContainer).getPropertyValue('row-gap'));

		// 获取鍗＄墖鐨勫疄闄呴珮搴?
		const noteHeight = noteElement.getBoundingClientRect().height;

		// 璁＄畻闇€瑕佽法瓒婄殑琛屾暟锛堝熀鍑嗚楂樹负1px锛?
		const rowSpan = Math.ceil((noteHeight + rowGap) / (1 + rowGap));
		noteElement.style.gridRowEnd = `span ${rowSpan}`;
	};

	// 褰撲换浣曡瑙傚療鐨勭瑪璁板崱鐗囧ぇ灏忓彂鐢熷彉鍖栨椂锛屽畠浼氳嚜鍔ㄨ皟鐢ㄦ垜浠殑设置鍑芥暟
	const waterfallObserver = new ResizeObserver(entries => {
		// 浣跨敤 requestAnimationFrame 鏉ョ‘淇濇垜浠湪娴忚鍣ㄤ笅涓€娆＄粯鍒跺墠更新甯冨眬锛岄伩鍏嶆姈鍔?
		window.requestAnimationFrame(() => {
			for (let entry of entries) {
				setNoteRowSpan(entry.target);
			}
		});
	});
	function formatTimestamp(timestamp) {
		if (!timestamp) return { relative: '', absolute: '' };
		const date = new Date(timestamp);
		const year = date.getFullYear();
		const month = (date.getMonth() + 1).toString().padStart(2, '0');
		const day = date.getDate().toString().padStart(2, '0');
		const hours = date.getHours().toString().padStart(2, '0');
		const minutes = date.getMinutes().toString().padStart(2, '0');
		const seconds = date.getSeconds().toString().padStart(2, '0');
		const absoluteTime = `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
		const now = Date.now();
		const diffMs = now - timestamp;
		const TWENTY_FOUR_HOURS_MS = 24 * 60 * 60 * 1000;
		if (diffMs < TWENTY_FOUR_HOURS_MS) {
			const secondsAgo = Math.floor(diffMs / 1000);
			if (secondsAgo < 60) {
				return { relative: 'Just now', absolute: absoluteTime };
			}
			const minutesAgo = Math.floor(secondsAgo / 60);
			if (minutesAgo < 60) {
				const relativeTime = `${minutesAgo} ${minutesAgo === 1 ? 'minute' : 'minutes'} ago`;
				return { relative: relativeTime, absolute: absoluteTime };
			}
			const hoursAgo = Math.floor(minutesAgo / 60);
			const relativeTime = `${hoursAgo} ${hoursAgo === 1 ? 'hour' : 'hours'} ago`;
			return { relative: relativeTime, absolute: absoluteTime };
		}
		return { relative: absoluteTime, absolute: absoluteTime };
	}

	/**
	 * 处理 Textarea 涓殑 Tab 鍜?Shift+Tab 缂╄繘/鍙栨秷缂╄繘鍔熻兘銆?
	 * 姝ょ増鏈娇鐢?document.execCommand 浠ョ‘淇濇墍鏈夋搷浣滈兘鏄彲鎾ら攢鐨?(undoable)銆?
	 * @param {KeyboardEvent} event - keydown 浜嬩欢瀵硅薄銆?
	 */
	function handleTabIndentation(event) {
		if (event.key !== 'Tab') {
			return; // 濡傛灉涓嶆槸Tab閿紝鍒欎笉鎵ц浠讳綍鎿嶄綔
		}

		event.preventDefault(); // 闃绘Tab閿殑榛樿琛屼负锛堝垏鎹㈢劍鐐癸級

		const textarea = event.target;
		const indent = '    '; // 鍥涗釜绌烘牸
		const isShiftPressed = event.shiftKey;

		const start = textarea.selectionStart;
		const end = textarea.selectionEnd;
		const value = textarea.value;

		// 涓轰簡浣跨敤 execCommand锛屾垜浠繀椤荤‘淇?textarea 鏄綋鍓嶆椿鍔ㄧ殑鍏冪礌
		textarea.focus();

		if (start !== end) {
			// --- 鍦烘櫙1: 鏈夋枃鏈閫変腑 (处理澶氳) ---

			// 1. 纭畾闇€瑕佷慨鏀圭殑瀹屾暣琛屽潡鐨勮寖鍥?
			const firstLineStart = value.lastIndexOf('\n', start - 1) + 1;
			const lastLineEnd = value.indexOf('\n', end) === -1 ? value.length : value.indexOf('\n', end);
			const selectedBlock = value.substring(firstLineStart, lastLineEnd);

			let newBlock;
			let changeInLength = 0;

			if (isShiftPressed) {
				// 鍙栨秷缂╄繘
				newBlock = selectedBlock.split('\n').map(line => {
					if (line.startsWith(indent)) {
						changeInLength -= indent.length;
						return line.substring(indent.length);
					} else if (line.startsWith(' ')) {
						const spacesToRemove = line.match(/^ {1,4}/)[0].length;
						changeInLength -= spacesToRemove;
						return line.substring(spacesToRemove);
					}
					return line;
				}).join('\n');
			} else {
				// 澧炲姞缂╄繘
				const lines = selectedBlock.split('\n');
				newBlock = lines.map(line => {
					// 濡傛灉鏈€鍚庝竴琛屾槸绌虹殑锛堝洜涓洪€変腑鍒拌灏撅級锛屽垯涓嶇缉杩?
					if (line.length > 0 || lines.length === 1) {
						changeInLength += indent.length;
						return indent + line;
					}
					return line;
				}).join('\n');
			}

			// 2. 閫変腑闇€瑕佽鏇挎崲鐨勬暣涓枃鏈潡
			textarea.selectionStart = firstLineStart;
			textarea.selectionEnd = lastLineEnd;

			// 3. 鎵ц鍙挙閿€鐨勬彃鍏ュ懡浠わ紝鐢ㄦ柊鍧楁浛鎹㈤€変腑鐨勬棫鍧?
			document.execCommand('insertText', false, newBlock);

			// 4. 鎭㈠鐢ㄦ埛鐨勯€夋嫨鑼冨洿
			textarea.selectionStart = start + (isShiftPressed ? (changeInLength > 0 ? -changeInLength : 0) : indent.length);
			textarea.selectionEnd = end + changeInLength;

		} else {
			// --- 鍦烘櫙2: 娌℃湁鏂囨湰琚€変腑 (处理褰撳墠鍏夋爣琛? ---
			if (isShiftPressed) {
				// 鍙栨秷缂╄繘
				const lineStart = value.lastIndexOf('\n', start - 1) + 1;
				const line = value.substring(lineStart, start);
				const spacesMatch = line.match(/^ {1,4}/);

				if (spacesMatch) {
					const spacesToRemove = spacesMatch[0].length;
					// 閫変腑瑕佸垹闄ょ殑绌烘牸
					textarea.selectionStart = lineStart;
					textarea.selectionEnd = lineStart + spacesToRemove;
					// 鐢ㄧ┖瀛楃涓叉浛鎹㈤€変腑鐨勭┖鏍硷紝杩欐槸涓€涓彲鎾ら攢鐨勫垹闄ゆ搷浣?
					document.execCommand('insertText', false, '');
				}
			} else {
				// 澧炲姞缂╄繘锛氱洿鎺ュ湪鍏夋爣澶勬彃鍏ョ缉杩涚
				document.execCommand('insertText', false, indent);
			}
		}

		// 手动触发input事件锛屼互渚垮疄鏃堕瑙堣兘澶熸洿鏂?
		textarea.dispatchEvent(new Event('input', { bubbles: true }));
	}

	function autoResizeTextarea(textarea) {
		// 保存褰撳墠鐨勬粴鍔ㄤ綅缃?
		const savedWindowScrollY = window.scrollY;
		const savedWindowScrollX = window.scrollX;
		const savedTextareaScrollTop = textarea.scrollTop;

		// 璋冩暣 textarea 楂樺害
		textarea.style.height = 'auto';
		const newHeight = textarea.scrollHeight;
		if (newHeight !== 0) {
			textarea.style.height = `${newHeight + 2}px`;
		}

		// 鎭㈠ textarea 鍐呴儴婊氬姩浣嶇疆
		textarea.scrollTop = savedTextareaScrollTop;

		// 绔嬪嵆鎭㈠绐楀彛婊氬姩浣嶇疆锛屾姷娑?height='auto' 鍙兘瀵艰嚧鐨勯〉闈㈣烦鍔?
		window.scrollTo(savedWindowScrollX, savedWindowScrollY);
	}

	let load = false;
	const showLoginScreen = () => {
		authContainer.style.display = 'block';
		appContainer.style.display = 'none';
		document.body.classList.add('auth-visible');
	};
	const showAppScreen = () => {
		if (load) return;
		load = true;
		authContainer.style.display = 'none';
		appContainer.style.display = 'block';
		document.body.classList.remove('auth-visible');
		document.getElementById('app-layout-container').classList.add('app-visible');
		// 纭繚鍙湁鍦ㄧ櫥褰曟垚鍔熷悗鎵嶆墽琛岃繖浜涙搷浣?
		initializeCollapsibleSidebars(); // 鍒濆鍖栦晶杈规爮鎶樺彔鐘舵€?
		initializeViewMode(); // 鍒濆鍖栧灞忔ā寮?
		updateEditorVisibility();
		loadAndRenderStats();
		loadAndRenderTags();
		loadAndRenderTimeline();
		initializeSettings();
	};

	function showCustomAlert(message, type = 'info') {
		customAlertMessage.textContent = message;
		customAlertBox.dataset.type = type;
		customConfirmBox.classList.remove('active');
		customAlertBox.classList.add('active');
		customModalOverlay.classList.add('visible');
		customAlertOkBtn.focus();
	}

	function showCustomConfirm(message) {
		return new Promise(resolve => {
			customConfirmMessage.textContent = message;
			customAlertBox.classList.remove('active'); // Hide alert box if open
			customConfirmBox.classList.add('active');
			customModalOverlay.classList.add('visible');
			customConfirmCancelBtn.focus();
			// Use { once: true } to automatically remove listeners after they fire
			customConfirmOkBtn.addEventListener('click', () => {
				hideCustomModal();
				resolve(true);
			}, { once: true });
			customConfirmCancelBtn.addEventListener('click', () => {
				hideCustomModal();
				resolve(false);
			}, { once: true });
		});
	}

	function hideCustomModal() {
		customModalOverlay.classList.remove('visible');
		customAlertBox.classList.remove('active');
		customConfirmBox.classList.remove('active');
		setTimeout(() => {
			customAlertMessage.textContent = '';
			customConfirmMessage.textContent = '';
		}, 300);
	}

	customAlertOkBtn.addEventListener('click', hideCustomModal);
	customModalOverlay.addEventListener('click', (e) => {
		if (e.target === customModalOverlay) {
			if (customConfirmBox.classList.contains('active')) {
				customConfirmCancelBtn.click(); // Programmatically click cancel
			} else {
				hideCustomModal();
			}
		}
	});

	// --- Event Handlers ---
	insertImageBtn.addEventListener('click', () => {
		const url = prompt('请输入图片链接(URL):', 'https://');



		// 检查用户是否输入了链接 (没有取消或留空)
		if (url && url.trim() !== 'https://' && url.trim() !== '') {
			const markdownImage = `![](${url})`;
			insertTextAtCursor(noteInput, markdownImage);
		}
	});

	/**
	 * 鎻掑叆浠ｇ爜鍧?
	 */
	/*	insertCodeBtn.addEventListener('click', () => {
			const textarea = noteInput;
			const start = textarea.selectionStart;
			const end = textarea.selectionEnd;
			const selectedText = textarea.value.substring(start, end);

			let code = '```';
		const textBefore = `${code}\n`;
		const textAfter = `\n${code}`;

		// 浣跨敤 setRangeText 鏉ユ彃鍏ユ枃鏈苟鑳芥洿濂藉湴鎺у埗鍏夋爣
		textarea.setRangeText(textBefore + selectedText + textAfter, start, end);

		textarea.focus();
		textarea.selectionStart = start + textBefore.length;
		textarea.selectionEnd = start + textBefore.length + selectedText.length;
		// 鎵嬪姩瑙﹀彂 input 浜嬩欢锛屼互渚垮疄鏃堕瑙堣兘澶熸洿鏂?
		textarea.dispatchEvent(new Event('input', { bubbles: true }));
	});*/

	/**
	 * 搴旂敤涓€涓富棰樿壊锛屽苟更新鎵€鏈夌浉鍏崇殑UI
	 */
	function applyThemeColor(hexColor, isCustom = false) {
		// 绠€鍗曠殑棰滆壊鏍煎紡楠岃瘉
		if (!/^#[0-9a-f]{6}$/i.test(hexColor)) return;

		let primaryColor = hexColor;
		let hoverColor;

		// 灏?HEX 杞崲涓?R, G, B 骞惰缃埌鏂扮殑 CSS 鍙橀噺涓?
		if (/^#[0-9a-f]{6}$/i.test(primaryColor)) {
			let r = parseInt(primaryColor.slice(1, 3), 16);
			let g = parseInt(primaryColor.slice(3, 5), 16);
			let b = parseInt(primaryColor.slice(5, 7), 16);
			document.documentElement.style.setProperty('--primary-color-rgb', `${r}, ${g}, ${b}`);
		}

		// 1. 璁＄畻鎮仠棰滆壊 (濡傛灉棰滆壊鏄璁剧殑锛岀洿鎺ョ敤锛涘鏋滄槸鑷畾涔夌殑锛屾櫤鑳藉湴鍙樻殫)
		const predefinedTheme = themeColors.find(t => t.color === hexColor);
		if (predefinedTheme) {
			hoverColor = predefinedTheme.hover;
		} else {
			// 鏅鸿兘璁＄畻 hover 棰滆壊锛氬皢鍘熻壊鍙樻殫 15%
			// 杩欐槸閫氳繃灏嗛鑹插垎瑙ｄ负R,G,B锛屽垎鍒箻浠?.85锛屽啀鍚堟垚涓哄崄鍏繘鍒跺疄鐜扮殑
			let r = parseInt(hexColor.slice(1, 3), 16);
			let g = parseInt(hexColor.slice(3, 5), 16);
			let b = parseInt(hexColor.slice(5, 7), 16);
			r = Math.floor(r * 0.85).toString(16).padStart(2, '0');
			g = Math.floor(g * 0.85).toString(16).padStart(2, '0');
			b = Math.floor(b * 0.85).toString(16).padStart(2, '0');
			hoverColor = `#${r}${g}${b}`;
		}

		// 2. 搴旂敤 CSS 鍙橀噺
		document.documentElement.style.setProperty('--primary-color', primaryColor);
		document.documentElement.style.setProperty('--primary-hover', hoverColor);

		// 3. 更新 UI 鐘舵€?
		// 濡傛灉鏄璁鹃鑹诧紝楂樹寒瀵瑰簲鐨勫渾褰㈡寜閽紱鍚﹀垯鍙栨秷鎵€鏈夐珮浜?
		colorPalette.querySelectorAll('.color-swatch').forEach(swatch => {
			swatch.classList.toggle('active', swatch.dataset.color === hexColor);
		});

		// 瀹炴椂更新鑷畾涔夐鑹查€夋嫨鍣ㄧ殑棰勮鍜岃緭鍏ユ
		colorPickerPreview.style.backgroundColor = primaryColor;
		// 鍙湁鍦ㄨ緭鍏ユ褰撳墠鍊间笉绛変簬鏂板€兼椂鎵嶆洿鏂帮紝避免鍏夋爣璺冲姩
		if (hexColorInput.value.toLowerCase() !== primaryColor) {
			hexColorInput.value = primaryColor;
		}
		// 鍚屾隐藏鐨?<input type="color">
		colorPickerInput.value = primaryColor;

		// 4. 保存鍒版湰鍦板瓨鍌?
		localStorage.setItem('memos-theme-color', primaryColor);
	}

	function initializeThemeColor() {
		colorPalette.innerHTML = themeColors.map(theme =>
			`<button class='color-swatch' data-color='${theme.color}' title='${theme.name}' style='background-color: ${theme.color};'></button>`
		).join('');
		const savedColor = localStorage.getItem('memos-theme-color') || themeColors[0].color;
		applyThemeColor(savedColor);
	}

	// 浜嬩欢鐩戝惉锛氱偣鍑烩€滆嚜瀹氫箟棰滆壊鈥濇爣绛炬椂锛岃Е鍙戦殣钘忕殑棰滆壊閫夋嫨鍣?
	colorPickerLabel.addEventListener('click', () => {
		colorPickerInput.click();
	});

	// 浜嬩欢鐩戝惉锛氬綋HTML5棰滆壊閫夋嫨鍣ㄧ殑鍊兼敼鍙樻椂 (鐢ㄦ埛鍏抽棴璋冭壊鏉垮悗)
	colorPickerInput.addEventListener('input', (e) => {
		applyThemeColor(e.target.value, true);
	});

	// 浜嬩欢鐩戝惉锛氬綋鎵嬪姩杈撳叆鍗佸叚杩涘埗棰滆壊鏃?
	hexColorInput.addEventListener('input', (e) => {
		const rawValue = e.target.value;
		if (/^#[0-9a-f]{6}$/i.test(rawValue)) {
			applyThemeColor(rawValue, true);
		}
	});

	// 浜嬩欢鐩戝惉锛氬湪棰滆壊闈㈡澘鍐呯偣鍑讳竴涓鑹?
	colorPalette.addEventListener('click', (e) => {
		const swatch = e.target.closest('.color-swatch');
		if (swatch) {
			const color = swatch.dataset.color;
			applyThemeColor(color);
		}
	});

	// 浜嬩欢鐩戝惉锛氱偣鍑婚〉闈㈠叾浠栦换浣曞湴鏂癸紝鍏抽棴闈㈡澘
	document.addEventListener('click', (e) => {
		if (fsColorPopover.classList.contains('visible') && !fsColorPickerWrapper.contains(e.target)) {
			fsColorPopover.classList.remove('visible');
		}
		if (!moreActionsContainer.contains(e.target)) {
			// 骞朵笖鑿滃崟褰撳墠鏄浐瀹氱殑
			if (isMenuPinned) {
				isMenuPinned = false; // 鍙栨秷鍥哄畾
				moreMenuPopover.classList.remove('visible'); // 鍏抽棴鑿滃崟
			}
		}
		if (isTagDropdownOpen && !tagDropdown.contains(e.target) && e.target !== insertTagBtn) {
			closeTagDropdown();
		}
		if (!themeColorPopover.contains(e.target) && !themeColorBtn.contains(e.target)) {
			themeColorPopover.classList.remove('visible');
		}
		// 妫€鏌ヨ彍鍗曟槸鍚﹀彲瑙侊紝浠ュ強点击鐨勭洰鏍囨槸鍚﹀湪鑿滃崟鍐呴儴鎴栨槸鍚︽槸鈥滄洿澶氣€濇寜閽?
		if (
			waterfallPopoverMenu.classList.contains('visible') &&
			!waterfallPopoverMenu.contains(e.target) &&
			!e.target.closest('.waterfall-more-btn')
		) {
			hideWaterfallPopover();
		}
	});

	// --- 杩斿洖椤堕儴 ---
	const scrollThreshold = 300;
	// 鐩戝惉绐楀彛婊氬姩浜嬩欢
	window.addEventListener('scroll', () => {
		if (window.scrollY > scrollThreshold) {
			backToTopBtn.classList.add('visible');
		} else {
			backToTopBtn.classList.remove('visible');
		}
	});

	backToTopBtn.addEventListener('click', () => {
		window.scrollTo({
			top: 0,
			behavior: 'smooth'
		});
	});

	let allTagsCache = [];
	let isTagDropdownOpen = false;
	// 娓叉煋鏍囩鍒楄〃鍒颁笅鎷夋
	function renderTagList(filter = '') {
		const lowerCaseFilter = filter.toLowerCase();
		const filteredTags = allTagsCache.filter(tag => tag.name.toLowerCase().includes(lowerCaseFilter));

		tagDropdownList.innerHTML = '';

		if (filteredTags.length === 0) {
			const li = document.createElement('li');
			li.className = 'no-results';
			li.textContent = filter ? 'No tags found' : 'No tags yet';
			tagDropdownList.appendChild(li);
			return;
		}

		filteredTags.forEach(tag => {
			const li = document.createElement('li');
			li.textContent = `#${tag.name}`;
			li.dataset.tagName = tag.name;
			tagDropdownList.appendChild(li);
		});
	}

	// 鎵撳紑涓嬫媺妗嗗苟获取鏍囩
	async function openTagDropdown() {
		if (isTagDropdownOpen) return;

		tagDropdown.style.display = 'block';
		isTagDropdownOpen = true;
		tagSearchInput.focus();
		if (allTagsCache.length === 0) {
			try {
				const response = await fetch('/api/tags');
				if (!response.ok) throw new Error('Failed to fetch tags');
				allTagsCache = await response.json();
			} catch (error) {
				console.error(error);
				allTagsCache = []; // 鍑洪敊鏃舵竻绌?
			}
		}

		renderTagList();

		// 为移动端设备添加遮罩层
		if (window.innerWidth <= 768) {
			const overlay = document.createElement('div');
			overlay.className = 'dropdown-overlay';
			document.body.appendChild(overlay);

			// 使用 setTimeout 确保 DOM 更新后添加类
			setTimeout(() => overlay.classList.add('visible'), 10);

			// 点击遮罩层关闭下拉菜单
			overlay.addEventListener('click', closeTagDropdown);
		}
	}

	function closeTagDropdown() {
		if (!isTagDropdownOpen) return;
		tagDropdown.style.display = 'none';
		isTagDropdownOpen = false;
		tagSearchInput.value = ''; // 娓呯┖鎼滅储妗?

		// 绉婚櫎绉诲姩绔伄缃╁眰
		const overlay = document.querySelector('.dropdown-overlay');
		if (overlay) {
			overlay.classList.remove('visible');
			setTimeout(() => overlay.remove(), 300); // 绛夊緟鍔ㄧ敾瀹屾垚鍚庡垹闄?
		}
	}

	// 鎸夐挳点击浜嬩欢锛氬垏鎹笅鎷夋鐨勬樉绀?隐藏
	insertTagBtn.addEventListener('click', (e) => {
		e.stopPropagation(); // 闃绘浜嬩欢鍐掓场鍒?document
		if (isTagDropdownOpen) {
			closeTagDropdown();
		} else {
			openTagDropdown();
		}
	});

	// 鎼滅储妗嗚緭鍏ヤ簨浠讹細瀹炴椂杩囨护鍒楄〃
	tagSearchInput.addEventListener('input', () => {
		renderTagList(tagSearchInput.value);
	});

	// 鍒楄〃点击浜嬩欢锛氶€夋嫨鏍囩骞舵彃鍏?
	tagDropdownList.addEventListener('click', (e) => {
		if (e.target && e.target.nodeName === 'LI' && e.target.dataset.tagName) {
			const tagName = e.target.dataset.tagName;

			// 1. 获取褰撳墠鏂囨湰鍐呭
			let currentContent = noteInput.value;

			// 2. 妫€鏌ユ湯灏炬槸鍚﹀凡缁忔湁鎹㈣绗?
			// 鎴戜滑甯屾湜鐩爣鏍煎紡鏄? "Content\n\n#tag "

			if (currentContent.length > 0) {
				// 绉婚櫎鏈熬鐨勭┖鐧藉瓧绗︼紙濡傛灉闇€瑕佹洿涓ユ牸鎺у埗锛屽彲浠ュ彧绉婚櫎鎹㈣锛?
				// 浣嗛€氬父杩藉姞鏍囩鏃讹紝鎴戜滑甯屾湜瀹冨湪鈥滄渶鈥濅笅闈紝鎵€浠ュ彲浠ュ厛 trimEnd 涓€涓嬶紝鍐嶈拷鍔犱袱涓崲琛?
				currentContent = currentContent.trimEnd();
				currentContent += '\n\n';
			}

			// 3. 杩藉姞鏍囩
			const tagText = `#${tagName} `;
			noteInput.value = currentContent + tagText;

			// 4. 更新 UI
			noteInput.focus();
			// 灏嗗厜鏍囩Щ鍔ㄥ埌鏈€鍚?
			noteInput.selectionStart = noteInput.selectionEnd = noteInput.value.length;

			// 瑙﹀彂 input 浜嬩欢浠ユ洿鏂伴瑙堝拰楂樺害
			noteInput.dispatchEvent(new Event('input', { bubbles: true }));

			closeTagDropdown();
		}
	});

	// --- 娓呯┖缂栬緫鍣ㄦ寜閽?---
	const clearEditorBtn = document.getElementById('clear-editor-btn');
	if (clearEditorBtn) {
		clearEditorBtn.addEventListener('click', async () => {
			// 绠€鍗曠殑纭锛岄伩鍏嶈瑙?
			// const confirmed = confirm('Clear editor content?');
			// if (!confirmed) return;

			// 娓呯┖鏂囨湰
			noteInput.value = '';
			// 娓呯┖鏂囦欢 (濡傛灉闇€瑕佹竻绌烘枃浠讹紝鍙栨秷涓嬮潰娉ㄩ噴)
			// noteFile.value = '';
			// updateMainFileDisplay();

			// 瑙﹀彂 input 更新 UI (棰勮鍜岄珮搴?
			noteInput.dispatchEvent(new Event('input', { bubbles: true }));
			noteInput.focus();
		});
	}


	loginForm.addEventListener('submit', async e => {
		e.preventDefault();
		const btn = document.getElementById('login-btn');
		const err = document.getElementById('login-error');
		btn.disabled = true;
		btn.textContent = 'Logging in...';
		err.textContent = '';
		try {
			const res = await fetch('/api/login', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ username: username.value, password: password.value })
			});
			if (!res.ok) throw new Error('Invalid username or password.');
			initializeApp();
		} catch (error) {
			err.textContent = error.message;
		} finally {
			btn.disabled = false;
			btn.textContent = 'Login';
		}
	});

	logoutBtn.addEventListener('click', async () => {
		try {
			await fetch('/api/logout', { method: 'POST' });
		} finally {
			window.location.reload();
		}
	});

	async function fetchNotes(page = 1) {
		if (appState.pagination.isLoading) return;
		appState.pagination.isLoading = true;
		const isAppending = page > 1;
		const currentLoader = isAppending ? scrollLoader : refreshLoader;
		if (isAppending) {
			currentLoader.textContent = 'Loading more...';
		}
		currentLoader.style.display = isAppending ? 'block' : 'flex';
		try {
			const url = new URL(window.location.origin + '/api/notes');
			// 1. 添加鍒嗛〉
			url.searchParams.set('page', page);
			// 2. 添加鎵€鏈夊叡瀛樼殑绛涢€夋潯浠?
			if (appState.filters.query) {
				url.pathname = '/api/search'; // 切换鍒版悳绱?API
				url.searchParams.set('q', appState.filters.query);
			}
			if (appState.filters.tag) {
				url.searchParams.set('tag', appState.filters.tag);
			}
			if (appState.filters.date) {
				url.searchParams.set('startTimestamp', appState.filters.date.startTimestamp);
				url.searchParams.set('endTimestamp', appState.filters.date.endTimestamp);
			}
			if (appState.baseMode === 'favorites') {
				url.searchParams.set('favorites', 'true');
			}
			if (appState.baseMode === 'archive') {
				url.searchParams.set('archived', 'true');
			}

			const response = await fetch(url.toString());
			if (response.status === 401) {
				showLoginScreen();
				return;
			}
			if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
			showAppScreen();
			const data = await response.json();
			if (!isAppending) {
				allNotesCache = [];
				notesContainer.innerHTML = '';
			}
			allNotesCache.push(...data.notes);
			renderNotes(data.notes);
			appState.pagination.hasMore = data.hasMore;
			appState.pagination.currentPage = page;

			if (appState.pagination.hasMore) {
				scrollLoader.style.display = 'none';
			} else {
				if (allNotesCache.length > 0) {
					scrollLoader.textContent = 'No more notes.';
					scrollLoader.style.display = 'block';
				} else {
					notesContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 1rem 0;">Nothing here yet.</div>';
					scrollLoader.style.display = 'none';
				}
			}
		} catch (error) {
			currentLoader.textContent = `Failed to load: ${error.message}`;
		} finally {
			appState.pagination.isLoading = false;
			refreshLoader.style.display = 'none';

			const initialLoader = document.getElementById('initial-loader');
			if (initialLoader && initialLoader.style.display !== 'none') {
				initialLoader.style.opacity = '0';
				setTimeout(() => {
					initialLoader.style.display = 'none';
				}, 200);
			}
		}
	}

	// --- 缁熶竴鐨勫叆鍙ｅ嚱鏁帮紝鐢ㄤ簬鍦ㄧ姸鎬佹敼鍙樺悗閲嶆柊加载鏁版嵁 ---
	function reloadNotes(shouldScroll = true) {
		// 浠讳綍绛涢€夋潯浠剁殑鏀瑰彉閮藉簲璇ヤ粠绗竴椤靛紑濮?
		appState.pagination.currentPage = 1;
		appState.pagination.hasMore = true;
		noteCounter = 1;
		if (shouldScroll) {
			window.scrollTo({ top: 0, behavior: 'auto' });
		}
		fetchNotes(1);
	}



	function createNoteElement(note) {
		const noteElement = document.createElement('div');
		noteElement.className = 'note';
		const noteId = note.id;
		noteElement.dataset.id = noteId;
		const time = formatTimestamp(note.updated_at);
		let editedIndicatorHtml = '';
		// if (note.updated_at !== note.created_at) {
		// 	const editedTime = formatTimestamp(note.updated_at);
		// 	editedIndicatorHtml = ` 路&nbsp;<span class="note-edited-indicator" title="Edited at: ${editedTime.absolute}">edited</span>`;
		// }
		const pinnedIconHTML = note.is_pinned ? `
				<button class='unpin-btn icon-btn pinned' title='Unpin'>
						<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' stroke-width='2' stroke='currentColor' fill='currentColor' stroke-linecap='round' stroke-linejoin='round'>
								<path stroke='none' d='M0 0h24v24H0z' fill='none'></path>
								<path d='M9 4v6l-2 4v2h10v-2l-2 -4v-6'></path>
								<line x1='12' y1='16' x2='12' y2='21'></line>
								<line x1='8' y1='4' x2='16' y2='4'></line>
						</svg>
				</button>
		` : '';
		let attachmentsHTML = '';
		if (note.files && note.files.length > 0) {
			attachmentsHTML += '<div class="attachments-grid">';
			note.files.forEach(file => {
				const fileUrl = `/api/files/${noteId}/${file.id}`;
				const shareButtonHTML = `
            <button class="share-file-btn icon-btn" title="Get public link" data-note-id="${noteId}" data-file-id="${file.id}">
                <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg>
            </button>
        `;
				if (file.type?.startsWith('image/')) {
					attachmentsHTML += `<div class='attachment-img'><img class='note-image-attachment' loading='lazy' src='${fileUrl}' alt='${file.name}' style='cursor: zoom-in;'></div>`;
				} else {
					attachmentsHTML += `<a href='${fileUrl}' class='attachment-link' download='${file.name}'><span class='file-name'>${file.name}</span><span class='file-size'>${formatBytes(file.size)}</span>${shareButtonHTML}</a>`;
				}
			});
			attachmentsHTML += '</div>';
		}

		let index = '';
		// if (appState.isWaterfall) {
		// 	index = `#${noteCounter++} 銉籤
		// }
		noteElement.innerHTML = `
									<div class='note-header'>
									<div class='note-meta'> ${index}
										<span title='${time.absolute}'>${time.relative}</span>
										${editedIndicatorHtml}
									</div>
											<div class='note-actions view-mode'>
													${pinnedIconHTML}
													<button class='edit icon-btn' title='Edit'>
															<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'><path d='M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z'></path></svg>
													</button>
													<button class='more-actions-btn icon-btn' title='More actions'>
															 <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
													</button>
											</div>
											<button class='waterfall-more-btn icon-btn' title='More options'>
													<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='currentColor'><path d='M0 0h24v24H0V0z' fill='none'/><path d='M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z'/></svg>
											</button>
											<div class='edit-actions edit-mode'>
													<label class="timestamp-toggle-label" title="If checked, the note's timestamp will not be updated upon saving.">
															<input type="checkbox" class="update-timestamp-toggle" checked>
															<span>Keep Time</span>
													</label>
													<label class='icon-btn' title='Add files'>
															<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'><path d='M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z'></path></svg>
															<input type='file' class='edit-file-input' multiple style='display:none;'>
													</label>
													<button class='md-preview-toggle-btn icon-btn' title='Toggle Preview'>
															<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' stroke-width='2' stroke='currentColor' fill='none' stroke-linecap='round' stroke-linejoin='round'><path stroke='none' d='M0 0h24v24H0z' fill='none'/><circle cx='12' cy='12' r='2' /><path d='M22 12c-2.667 4.667 -6 7 -10 7s-7.333 -2.333 -10 -7c2.667 -4.667 6 -7 10 -7s7.333 2.333 10 7' /></svg>
													</button>
													<button class='md-split-toggle-btn icon-btn' title='Toggle Split View' style='display: none;'>
															<svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='currentColor'><path d='M0 0h24v24H0V0z' fill='none'></path><path d='M3 15h8v-2H3v2zm0 4h8v-2H3v2zm0-8h8V9H3v2zm0-6v2h8V5H3zm10 0h8v14h-8V5z'></path></svg>
													</button>
													<button class='fullscreen-edit icon-btn' title='Fullscreen Edit'>
															<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'><path d='M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z'></path></svg>
													</button>
													<button class='save-edit icon-btn btn-accent' title='Save'>
															<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'><path d='M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z'></path></svg>
													</button>
													<button class='cancel-edit icon-btn' title='Cancel'>
															<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'><path d='M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z'></path></svg>
													</button>
											</div>
									</div>
									<div class='note-content view-mode'></div>
									${attachmentsHTML}
									<div class='edit-area edit-mode'>
											<textarea class='edit-textarea' placeholder='Memos here...'></textarea>
											<div class='edit-preview note-content'></div>
									</div>

									<div class='edit-files-container'></div>
							`;
		noteElement.querySelector('.note-content').innerHTML = postProcessMarkdownHtml(marked.parse(note.content));

		noteElement.querySelector('.edit-textarea').value = note.content;
		// Add collapsed class if note is collapsed
		if (note.is_collapsed) {
			noteElement.classList.add('collapsed');
		}
		// Add expand button after note-content
		const noteContentDiv = noteElement.querySelector('.note-content.view-mode');
		if (noteContentDiv) {
			const expandBtn = document.createElement('button');
			expandBtn.className = 'expand-note-btn';
			expandBtn.textContent = 'Show more...';
			expandBtn.dataset.noteId = noteId;
			noteContentDiv.parentNode.insertBefore(expandBtn, noteContentDiv.nextSibling);
		}
		return noteElement;
	}



	function renderNotes(notes) {
		const fragment = document.createDocumentFragment();
		if (!settings.enableDateGrouping || appState.isWaterfall) {
			notes.forEach(note => {
				const noteElement = createNoteElement(note);
				fragment.appendChild(noteElement);
				if (appState.isWaterfall) {
					waterfallObserver.observe(noteElement);
				}
			});
		} else {
			const pinnedNotes = notes.filter(note => note.is_pinned);
			const regularNotes = notes.filter(note => !note.is_pinned);

			// 濡傛灉瀛樺湪缃《绗旇锛屽垯鍒涘缓骞舵覆鏌撶疆椤跺尯鍩?
			if (pinnedNotes.length > 0) {
				const pinnedContainer = document.createElement('div');
				pinnedContainer.className = 'pinned-notes-container';

				// 涓虹疆椤跺尯鍩熸坊鍔犱竴涓爣棰?鍒嗛殧绗?
				const pinnedHeader = document.createElement('div');
				pinnedHeader.className = 'pinned-section-header';
				pinnedHeader.textContent = 'Pinned';
				pinnedContainer.appendChild(pinnedHeader);

				// 寰幆娓叉煋鎵€鏈夌疆椤剁瑪璁?
				pinnedNotes.forEach(note => {
					const noteElement = createNoteElement(note);
					pinnedContainer.appendChild(noteElement);
				});

				// 灏嗘暣涓疆椤跺尯鍩熸坊鍔犲埌涓绘枃妗ｇ墖娈典腑
				fragment.appendChild(pinnedContainer);
			}

			const dateFormatter = new Intl.DateTimeFormat('en-CA', {
				year: 'numeric',
				month: '2-digit',
				day: '2-digit',
			});

			const notesByDate = new Map();
			regularNotes.forEach(note => {
				const dateKey = dateFormatter.format(new Date(note.updated_at));
				if (!notesByDate.has(dateKey)) {
					notesByDate.set(dateKey, []);
				}
				notesByDate.get(dateKey).push(note);
			});

			const sortedDates = Array.from(notesByDate.keys()).sort((a, b) => new Date(b) - new Date(a));

			sortedDates.forEach(dateKey => {
				const dateNotes = notesByDate.get(dateKey);

				const groupEl = document.createElement('div');
				groupEl.className = 'date-group';

				const headerEl = document.createElement('div');
				headerEl.className = 'date-group-header';
				headerEl.innerHTML = `
            <div class="date-divider">
                <span class="line"></span>
                <svg class="toggle-icon expanded" width="24" height="24" viewBox='0 0 1024 1024' xmlns="http://www.w3.org/2000/svg" p-id="4990">
                        <path d="M832 288l-320 448-320-448z" fill="currentColor" p-id="4991" />
                </svg>
                <span class="date-label">${dateKey}</span>
                <span class="line"></span>
            </div>
        `;

				const contentEl = document.createElement('div');
				contentEl.className = 'date-group-content';

				dateNotes.forEach(note => {
					const noteElement = createNoteElement(note);
					contentEl.appendChild(noteElement);
				});

				groupEl.appendChild(headerEl);
				groupEl.appendChild(contentEl);
				fragment.appendChild(groupEl);
			});
		}
		notesContainer.appendChild(fragment);
	}

	function reRenderCachedNotes() {
		notesContainer.innerHTML = '';
		noteCounter = 1;
		renderNotes(allNotesCache);
	}

	// --- Main Form and File Handling ---
	const updateMainFileDisplay = () => {
		fileListDisplay.innerHTML = '';
		Array.from(noteFile.files).filter(file => !file.type.startsWith('image/')).forEach(file => {
			const fileTag = document.createElement('div');
			fileTag.className = 'file-tag-item';
			fileTag.textContent = file.name;
			// 灏嗘枃浠跺悕瀛樺偍鍦?data 灞炴€т腑锛屼互渚夸箣鍚庤瘑鍒?
			fileTag.dataset.filename = file.name;

			const removeBtn = document.createElement('button');
			removeBtn.type = 'button'; // 闃叉瑙﹀彂琛ㄥ崟鎻愪氦
			removeBtn.className = 'remove-file-main-btn';
			removeBtn.innerHTML = '&times;';

			fileTag.appendChild(removeBtn);
			fileListDisplay.appendChild(fileTag);
		});
	};
	noteFile.addEventListener('change', async () => {
		// 1. 涓婁紶鍥剧墖骞舵彃鍏?Markdown
		await handleImageUploadAndInsert(noteFile.files, noteInput);
		// 2. 更新闄勪欢鍒楄〃锛堝彧显示闈炲浘鐗囨枃浠讹級
		updateMainFileDisplay();
	});

	fileListDisplay.addEventListener('click', e => {
		// 浠呭綋点击鐨勬槸绉婚櫎鎸夐挳鏃舵墽琛?
		if (e.target.classList.contains('remove-file-main-btn')) {
			const fileTag = e.target.closest('.file-tag-item');
			const fileNameToRemove = fileTag.dataset.filename;

			// FileList 鏄笉鍙彉鐨勶紝闇€瑕佺敤 DataTransfer 鏉ュ垱寤轰竴涓柊鐨?FileList
			const dt = new DataTransfer();
			const currentFiles = Array.from(noteFile.files);

			// 閬嶅巻褰撳墠鏂囦欢锛屽彧添加閭ｄ簺鎴戜滑涓嶆兂绉婚櫎鐨勬枃浠?
			for (const file of currentFiles) {
				if (file.name !== fileNameToRemove) {
					dt.items.add(file);
				}
			}
			// 灏嗘洿鏂板悗鐨勬枃浠跺垪琛ㄨ祴鍊煎洖 input 鍏冪礌
			noteFile.files = dt.files;
			// 閲嶆柊娓叉煋鏂囦欢鍒楄〃显示
			updateMainFileDisplay();
		}
	});
	['dragover', 'dragleave', 'drop'].forEach(ev => noteForm.addEventListener(ev, e => {
		e.preventDefault();
		e.stopPropagation();
	}));
	noteForm.addEventListener('dragover', () => noteForm.classList.add('dragover'));
	noteForm.addEventListener('dragleave', () => noteForm.classList.remove('dragover'));
	noteForm.addEventListener('drop', async e => {
		noteForm.classList.remove('dragover');
		if (e.dataTransfer.files.length > 0) {
			await handleImageUploadAndInsert(e.dataTransfer.files, noteInput);

			noteFile.files = e.dataTransfer.files;
			updateMainFileDisplay();
		}
	});

	// 瀹炴椂更新涓婚瑙堝尯鍐呭
	noteInput.addEventListener('input', e => {
		mainEditPreview.innerHTML = postProcessMarkdownHtml(marked.parse(noteInput.value || ''));
		// autoResizeTextarea(noteInput);
		syncMainEditorLayout();
	});

	// 点击鎸夐挳切换妯″紡
	mainPreviewToggleBtn.addEventListener('click', () => {
		noteForm.classList.toggle('preview-mode');
		const isPreview = noteForm.classList.contains('preview-mode');
		mainPreviewToggleBtn.classList.toggle('active', isPreview);

		if (isPreview) {
			// 鍦ㄥ垏鎹㈠埌棰勮鏃讹紝纭繚鍐呭鏄渶鏂扮殑
			mainEditPreview.innerHTML = postProcessMarkdownHtml(marked.parse(noteInput.value || ''));
		} else {
			noteInput.focus();
		}
	});

	mainSplitToggleBtn.addEventListener('click', () => {
		const isExitingSplitMode = noteForm.classList.contains('split-mode');
		noteForm.classList.toggle('split-mode');
		mainSplitToggleBtn.classList.toggle('active');
		if (isExitingSplitMode) {
			noteInput.style.transition = 'none';
			syncMainEditorLayout();
			setTimeout(() => {
				noteInput.style.transition = '';
			}, 0);
		} else {
			syncMainEditorLayout();
		}
	});

	function handleEditorLayout() {
		const editorWidth = noteForm.offsetWidth;
		const isWide = editorWidth > 1000;

		if (isWide) {
			mainPreviewToggleBtn.style.display = 'none';
			mainSplitToggleBtn.style.display = 'inline-flex'; // 鎴栬€?'block'
		} else {
			mainPreviewToggleBtn.style.display = 'inline-flex';
			mainSplitToggleBtn.style.display = 'none';
		}

		// 濡傛灉绐楀彛浠庡鍙樼獎锛屼絾涔嬪墠澶勪簬鍒嗘爮妯″紡锛屽垯蹇呴』寮哄埗閫€鍑?
		if (!isWide && noteForm.classList.contains('split-mode')) {
			noteForm.classList.remove('split-mode');
			mainSplitToggleBtn.classList.remove('active');
		}
		// 濡傛灉绐楀彛浠庣獎鍙樺锛屼絾涔嬪墠澶勪簬棰勮妯″紡锛屽垯寮哄埗閫€鍑?
		if (isWide && noteForm.classList.contains('preview-mode')) {
			noteForm.classList.remove('preview-mode');
			mainPreviewToggleBtn.classList.remove('active');
		}
	}


	// 鎵嬪姩鍦?textarea 涓彃鍏ユ枃鏈?
	function insertTextAtCursor(textarea, text) {
		textarea.focus(); // 纭繚鍛戒护鍦ㄦ纭殑鍏冪礌涓婃墽琛?
		document.execCommand('insertText', false, text);
		// execCommand 浼氳嚜鍔ㄥ鐞嗗厜鏍囦綅缃?
		// 鎵嬪姩瑙﹀彂 input 浜嬩欢锛屼互渚垮疄鏃堕瑙堢瓑渚濊禆 input 浜嬩欢鐨勯€昏緫鑳藉更新
		textarea.dispatchEvent(new Event('input', { bubbles: true }));
	}

	function convertTableRowElementToMarkdown(tableRowEl, rowNumber) {
		const cells = [];
		const cellEls = tableRowEl.children;
		// 浣跨敤 Array.from 杩涜鏇寸幇浠ｇ殑閬嶅巻
		Array.from(cellEls).forEach(cell => {
			// 娓呯悊鍗曞厓鏍煎唴瀹瑰苟处理閾炬帴
			let cellContent = cell.innerText.trim();
			const link = cell.querySelector('a');
			if (link) {
				cellContent = `[${cellContent}](${link.href})`;
			}
			cells.push(cellContent);
		});

		let row = `| ${cells.join(' | ')} |`;

		if (rowNumber === 0) {
			row += '\n' + createMarkdownDividerRow(cellEls.length);
		}

		return row;
	}

	function createMarkdownDividerRow(cellCount) {
		const dividerCells = Array(cellCount).fill('---');
		return `| ${dividerCells.join(' | ')} |`;
	}

	// --- 鏍稿績浠ｇ爜缁撴潫 ---
	// --- 鏅鸿兘绮樿创閫昏緫 (浣跨敤 Turndown.js) ---
	// 1. 鍦ㄥ叏灞€浣滅敤鍩熷垵濮嬪寲 Turndown 鏈嶅姟锛屽苟杩涜涓€浜涙帹鑽愰厤缃?
	//    检查TurndownService 鏄惁瀛樺湪锛屼互闃?CDN 加载澶辫触
	const turndownService = typeof TurndownService === 'function'
		? new TurndownService({
			headingStyle: 'atx',      // 鏍囬鏍峰紡浣跨敤 '#' (e.g., ## My Heading)
			codeBlockStyle: 'fenced',
			bulletListMarker: '-',    // 鏃犲簭鍒楄〃浣跨敤 '-'
			emDelimiter: '*',         // 鏂滀綋浣跨敤 '*'
			strongDelimiter: '**'     // 鍔犵矖浣跨敤 '**'
		})
		: null;
	if (turndownService) {
		// 浣跨敤 .addRule() 鏉ユ暀 Turndown 濡備綍处理 <table> 鏍囩
		turndownService.addRule('customTableRule', {
			// 杩囨护鍣細鍛婅瘔 Turndown 杩欐潯瑙勫垯鍙簲鐢ㄤ簬 'table' 鏍囩
			filter: 'table',
			// 鏇挎崲鍑芥暟锛氬綋閬囧埌 <table> 鏃讹紝璋冪敤杩欎釜鍑芥暟鏉ョ敓鎴?Markdown
			replacement: function (content, node) {
				const rows = [];
				// node 鍙傛暟灏辨槸褰撳墠鐨?<table> DOM 鍏冪礌
				const trEls = Array.from(node.querySelectorAll('tr'));

				for (let i = 0; i < trEls.length; i++) {
					const markdownRow = convertTableRowElementToMarkdown(trEls[i], i);
					rows.push(markdownRow);
				}
				// 鍦ㄧ敓鎴愮殑琛ㄦ牸鍓嶅悗添加鎹㈣绗︼紝纭繚瀹冧笌鍏朵粬 Markdown 鍐呭姝ｇ‘鍒嗛殧
				return '\n\n' + rows.join('\n') + '\n\n';
			}
		});
		turndownService.addRule('lineBreakRule', {
			filter: ['div', 'p'],
			replacement: function (content, node) {
				// 濡傛灉鍦ㄩ摼鎺ュ唴閮紝涓嶈添加棰濆鐨勬崲琛岀锛屼絾瑕佷繚鐣欏唴瀹瑰苟鍔犱竴涓┖鏍间互闃茬矘杩?
				if (node.closest('a')) {
					return content + ' ';
				}
				// 濡傛灉鍐呭涓嶄负绌猴紝鍒欏湪鍐呭鍚庢坊鍔犱竴涓崲琛岀銆?
				// 杩欏皢淇濈暀娈佃惤缁撴瀯锛屼絾涓嶄細浜х敓棰濆鐨勭┖琛屻€?
				return content.trim() ? content + '\n' : '';
			}
		});

		// 鏂板锛氭樉寮忓鐞?<br> 鏍囩锛岀‘淇濇帹鏂囦腑鐨勬崲琛岃淇濈暀
		turndownService.addRule('brRule', {
			filter: 'br',
			replacement: function () {
				// 浣跨敤 '  \n' 琛ㄧず Markdown 纭崲琛?(Hard Break)锛?
				// 杩欐牱铏界劧鎹㈣浜嗭紝浣嗕笉浼氫骇鐢熸钀介棿璺?(鍗充笉浼氭湁绌鸿)銆?
				return '  \n';
			}
		});

		// 鏂板锛氬鐞嗛€氳繃CSS font-weight瀹炵幇鐨勫姞绮楁枃鏈紙濡俆witter/X锛?
		turndownService.addRule('cssBoldRule', {
			filter: function (node) {
				// 璺宠繃宸茬粡鏄痵trong/b鏍囩鐨勫厓绱狅紝避免閲嶅处理
				if (node.nodeName === 'STRONG' || node.nodeName === 'B') {
					return false;
				}
				// 妫€鏌ユ槸鍚︿负鍏冪礌鑺傜偣
				if (node.nodeType === Node.ELEMENT_NODE) {
					// 妫€鏌ュ唴鑱旀牱寮忎腑鐨刦ont-weight锛堢矘璐寸殑HTML閫氬父淇濈暀鍐呰仈鏍峰紡锛?
					const inlineFontWeight = node.style.fontWeight;
					if (inlineFontWeight) {
						const weight = parseInt(inlineFontWeight);
						// font-weight >= 600 鎴?'bold' 琚涓烘槸鍔犵矖
						if (weight >= 600 || inlineFontWeight === 'bold' || inlineFontWeight === 'bolder') {
							// 涔熻妫€鏌isplay灞炴€э紝纭繚鏄唴鑱斿厓绱?
							const inlineDisplay = node.style.display;
							if (!inlineDisplay || inlineDisplay === 'inline' || inlineDisplay === 'inline-block') {
								return true;
							}
						}
					}

					// 涔熸鏌ヨ绠楁牱寮忎綔涓哄悗澶囷紙鏌愪簺鎯呭喌涓嬪彲鑳芥湁鐢級
					try {
						const style = window.getComputedStyle(node);
						const fontWeight = style.fontWeight;
						if (fontWeight && (parseInt(fontWeight) >= 600 || fontWeight === 'bold')) {
							// 鍙鐞嗗寘鍚枃鏈殑鍐呰仈鍏冪礌
							const hasText = node.textContent && node.textContent.trim().length > 0;
							const isInline = style.display === 'inline' || style.display === 'inline-block';
							return hasText && isInline;
						}
					} catch (e) {
						// 濡傛灉获取鏍峰紡澶辫触锛屽拷鐣?
					}
				}
				return false;
			},
			replacement: function (content) {
				// 灏嗗唴瀹瑰寘瑁瑰湪 ** 涓〃绀哄姞绮?
				return content ? `**${content}**` : '';
			}
		});

		// 鏂板锛氳瘑鍒鍐呭浘鐗?(Emoji 绛?锛屼繚鐣欎负 HTML <img> 鏍囩骞舵坊鍔?class
		turndownService.addRule('imgRule', {
			filter: 'img',
			replacement: function (content, node) {
				const src = node.getAttribute('src');
				const alt = node.getAttribute('alt') || '';

				// 鍒ゆ柇鏄惁涓鸿鍐呭浘鐗?(Emoji)锛?
				// 1. 鍖呭惈 'emoji' 绫诲悕 (Twitter/X 绛夊父鐢?
				// 2. 鎴栬€?SRC URL 涓寘鍚?'emoji' (閽堝 Twitter/X 鐨勫浘鐗?URL: https://.../emoji/...)
				// 3. 鎴栬€呭搴?楂樺害寰堝皬 (< 32px)
				const isEmoji = (node.classList && node.classList.contains('emoji')) ||
					(src && src.includes('emoji')) ||
					(node.width > 0 && node.width <= 32) ||
					(node.height > 0 && node.height <= 32);

				if (isEmoji) {
					// 鍙湁瀵逛簬琛屽唴鍥剧墖锛屾垜浠繑鍥?HTML锛岃繖鏍峰甫鏈?class
					return `<img src="${src}" alt="${alt}" class="inline-img" />`;
				}

				// 瀵逛簬澶у浘锛屼娇鐢ㄦ爣鍑?Markdown 鏍煎紡锛屽畠浼氬彈鍒版垜浠箣鍓嶆坊鍔犵殑 .note-content img 鏍峰紡褰卞搷 (max-width: 100%)
				// 濡傛灉鍥剧墖鏄湪娈佃惤鍐咃紝Turndown 浼氳嚜鍔ㄥ鐞嗐€?
				// 娉ㄦ剰锛氬鏋滃浘鐗囨槸鐙珛鐨勶紝鏈€濂界‘淇濆畠鍓嶅悗鏈夋崲琛岋紝浣嗘爣鍑?Markdown image 璇硶閫氬父瓒冲銆?
				return src ? `![${alt}](${src})` : '';
			}
		});
	}


	// 2. 绮樿创浜嬩欢处理鍑芥暟
	function handleSmartPaste(event) {
		// 纭繚鍙湪 textarea 鍏冪礌涓敓鏁堬紝骞朵笖 Turndown 搴撳凡鎴愬姛加载
		const textarea = event.target;
		if (!textarea.matches('textarea') || !turndownService) {
			return;
		}

		const clipboardData = event.clipboardData || window.clipboardData;
		const pastedHtml = clipboardData.getData('text/html');
		const pastedText = clipboardData.getData('text/plain');

		// 鍏抽敭鏉′欢锛?
		// 1. 濡傛灉鏈?HTML 鍐呭涓斾笌绾枃鏈笉鍚岋紝杩涜 HTML 杞?Markdown 处理
		// 2. 濡傛灉鍙湁绾枃鏈紝妫€鏌ユ槸鍚﹀寘鍚┖鐧借锛屽鏋滄湁鍒欐墜鍔ㄥ鐞嗕互淇濈暀绌虹櫧琛?
		const hasHtml = pastedHtml && pastedHtml.length > 0 && pastedHtml !== pastedText;
		const hasBlankLines = pastedText && /\n\s*\n/.test(pastedText);

		if (hasHtml) {

			// 闃绘娴忚鍣ㄩ粯璁ょ殑銆佷細涓㈠け鏍煎紡鐨勭矘璐磋涓?
			event.preventDefault();

			// 棰勫鐞?HTML锛氫繚鐣欐枃鏈妭鐐逛腑鐨勬崲琛岀
			// 璁稿缃戠珯 (濡?X/Twitter) 浣跨敤 white-space: pre-wrap锛屽鍒剁殑 HTML 鍖呭惈鎹㈣绗︿絾娌℃湁 <br>
			// Turndown 榛樿浼氬拷鐣ヨ繖浜涙崲琛岀锛屾墍浠ユ垜浠渶瑕佸厛灏嗗畠浠浆鎹负 <br>
			const tempDiv = document.createElement('div');
			tempDiv.innerHTML = pastedHtml;

			/**
			 * Detect elements with block-like display styles (block, flex, grid, etc.)
			 * and convert them to standard block elements (divs) so Turndown respects the line breaks.
			 * This fixes issues where content relies on CSS for line breaks but uses inline tags (span, img).
			 */
			function convertStyledBlocks(node) {
				if (node.nodeType === Node.ELEMENT_NODE) {
					const display = node.style.display || '';
					const isBlockStyle = ['block', 'flex', 'grid', 'table', 'table-row', 'list-item'].some(d => display.includes(d));
					// Tags that are already blocks don't need conversion.
					// We also exclude 'A' (anchors) and 'CODE'/'SPAN' (explicitly inline) to prevent breaking their semantic meaning,
					// even if they happen to have block styling in the source.
					const isBlockTag = /^(DIV|P|H[1-6]|UL|OL|LI|TABLE|TR|TBODY|THEAD|TFOOT|SECTION|ARTICLE|ASIDE|HEADER|FOOTER|BLOCKQUOTE|PRE|A|CODE|SPAN)$/i.test(node.nodeName);

					if (isBlockStyle && !isBlockTag) {
						if (node.nodeName === 'IMG') {
							// Check if it's an inline emoji-like image
							const src = node.getAttribute('src') || '';
							const isEmoji = (node.classList && node.classList.contains('emoji')) ||
								(src && src.includes('emoji')) ||
								(node.width > 0 && node.width <= 32) ||
								(node.height > 0 && node.height <= 32);

							if (isEmoji) {
								// HEURISTIC: Block-styled emoji.
								// If it is followed by text, it acts as a "Bullet" (starts a line).
								// If it is NOT followed by text, it acts as a "Trailer" (inline end of sentence), even if styled as block.
								const nextNode = node.nextSibling;
								const hasFollowingText = nextNode && nextNode.textContent && nextNode.textContent.trim().length > 0;

								if (hasFollowingText) {
									// It's a bullet. We need to ensure it's on a new line.
									// But if the previous sibling is ALREADY a newline (text node ending in \n), preserveNewlines will handle it.
									// We only force a <br> if there is NO preceding newline.
									let prevIsNewline = false;
									if (node.previousSibling && node.previousSibling.nodeType === Node.TEXT_NODE) {
										if (/\r?\n\s*$/.test(node.previousSibling.nodeValue)) {
											prevIsNewline = true;
										}
									}

									if (!prevIsNewline) {
										const br = document.createElement('br');
										node.parentNode.insertBefore(br, node);
									}
								}
								// If NO following text, we do nothing (treat as inline).
							} else {
								// For large images, wrap in a proper block container
								const wrapper = document.createElement('div');
								node.parentNode.insertBefore(wrapper, node);
								wrapper.appendChild(node);
							}
							// Don't recurse into img (void element)
							return;
						} else {
							// Convert other elements (e.g. span) to div
							const div = document.createElement('div');
							// Copy all attributes
							Array.from(node.attributes).forEach(attr => {
								div.setAttribute(attr.name, attr.value);
							});
							// Move all children
							while (node.firstChild) {
								div.appendChild(node.firstChild);
							}
							node.parentNode.replaceChild(div, node);
							// Recurse into the new div to check its children
							convertStyledBlocks(div);
							return;
						}
					}
					// Recurse for children
					Array.from(node.children).forEach(convertStyledBlocks);
				}
			}

			function preserveNewlines(node) {
				if (node.nodeType === Node.TEXT_NODE) {
					// 濡傛灉鏂囨湰鍖呭惈鎹㈣绗︼紝涓斾笉鍦?pre/code 鏍囩鍐?(Turndown 浼氳嚜宸卞鐞嗚繖浜?
					if (/\r?\n/.test(node.nodeValue)) {
						const parent = node.parentNode;
						if (parent && /^(PRE|CODE|TABLE|THEAD|TBODY|TR|TH|TD|STYLE|SCRIPT)$/i.test(parent.nodeName)) {
							return;
						}

						const frag = document.createDocumentFragment();
						const parts = node.nodeValue.split(/\r?\n/);

						// Helper to check if a node is (or contains) an emoji
						function isEmojiNode(n) {
							if (!n || n.nodeType !== Node.ELEMENT_NODE) return false;
							if (n.nodeName === 'IMG') {
								const src = n.getAttribute('src') || '';
								return (n.classList && n.classList.contains('emoji')) ||
									(src && src.includes('emoji')) ||
									(n.width > 0 && n.width <= 32) ||
									(n.height > 0 && n.height <= 32);
							}
							// Check first child (for wrapped emojis)
							if (n.firstChild) return isEmojiNode(n.firstChild);
							return false;
						}

						// Check if the next visible siblings are inline emojis
						// We need to check ALL consecutive emojis, not just the first one
						let emojiSequence = [];
						let sibling = node.nextSibling;

						// Collect all consecutive emojis (skipping whitespace text nodes)
						while (sibling) {
							if (isEmojiNode(sibling)) {
								emojiSequence.push(sibling);
								sibling = sibling.nextSibling;
								continue;
							}
							// Skip empty/whitespace text nodes
							if (sibling.nodeType === Node.TEXT_NODE && !sibling.nodeValue.trim()) {
								sibling = sibling.nextSibling;
								continue;
							}
							// Found a non-empty text node or other element, stop collecting
							break;
						}

						// Key Check: Are these emojis acting as "Bullets" or "Trailers"?
						// They are bullets if there is following text content after the ENTIRE sequence.
						// If they are bullets, we DO NOT suppress the newline (we want the line break).
						// If they are NOT bullets (they're trailers), we SUPPRESS the newline (glue them).
						let nextIsBullet = false;
						if (emojiSequence.length > 0) {
							// Check what comes after the LAST emoji in the sequence
							let lastEmoji = emojiSequence[emojiSequence.length - 1];
							let after = lastEmoji.nextSibling;

							// Find first meaningful content after the last emoji
							while (after) {
								if (after.nodeType === Node.TEXT_NODE && after.nodeValue.trim().length > 0) {
									nextIsBullet = true;
									break;
								}
								if (after.nodeType === Node.ELEMENT_NODE && !/^(BR)$/i.test(after.nodeName)) {
									nextIsBullet = true; // Followed by element
									break;
								}
								after = after.nextSibling;
							}
						}

						const nextIsEmoji = emojiSequence.length > 0;

						parts.forEach((part, index) => {
							// Logic: Suppress <br> in several cases:
							// 1. Trailing newline before emoji trailers (not bullets)
							// 2. Newlines between short text segments (like Twitter name/handle: "Latte\n@0xbisc")
							const isLast = index === parts.length - 1;
							const isTrailingNewline = index > 0 && isLast && part === '';

							// Case 1: Emoji trailer suppression
							let shouldSuppressEmoji = isTrailingNewline && nextIsEmoji && !nextIsBullet;

							// Case 2: Short text segment suppression (Twitter name/handle pattern)
							// Check if this is an empty part (newline) between two short text segments
							let shouldSuppressShortText = false;
							if (index > 0 && part.trim() === '') {
								const prevPart = parts[index - 1];
								// Check if there's a next part (not at the end)
								const nextPart = index < parts.length - 1 ? parts[index + 1] : null;

								// Check if both surrounding parts are short (likely name/handle)
								// Typical pattern: "Name\n@handle" or "Name\nhandle"
								const prevIsShort = prevPart && prevPart.trim().length > 0 && prevPart.trim().length < 50;
								const nextIsShort = nextPart && nextPart.trim().length > 0 && nextPart.trim().length < 50;

								// Additional check: next part starts with @ (Twitter handle) or is very short
								const nextLooksLikeHandle = nextPart && (nextPart.trim().startsWith('@') || nextPart.trim().length < 20);

								if (prevIsShort && nextIsShort && nextLooksLikeHandle) {
									shouldSuppressShortText = true;
								}
							}

							const shouldSuppress = shouldSuppressEmoji || shouldSuppressShortText;

							if (shouldSuppress) {
								// If suppressing, strip trailing spaces from the previous part so it glues perfectly.
								part = part.trimEnd();
							}

							if (index > 0 && !shouldSuppress) {
								frag.appendChild(document.createElement('br'));
							}
							if (part) frag.appendChild(document.createTextNode(part));
						});
						parent.replaceChild(frag, node);
					}
				} else if (node.nodeType === Node.ELEMENT_NODE) {
					// 閫掑綊处理锛屼絾璺宠繃 pre/code 绛?
					if (!/^(PRE|CODE|STYLE|SCRIPT)$/i.test(node.nodeName)) {
						// 闇€瑕佸皢瀛愯妭鐐硅浆鎹负鏁扮粍锛屽洜涓洪亶鍘嗚繃绋嬩腑鍙兘浼氫慨鏀?DOM 缁撴瀯
						Array.from(node.childNodes).forEach(preserveNewlines);
					}
				}
			}

			// 1. First, convert visual blocks to semantic blocks
			convertStyledBlocks(tempDiv);
			// 2. Then, preserve text newlines
			preserveNewlines(tempDiv);

			const processedHtml = tempDiv.innerHTML;

			let markdown = turndownService.turndown(processedHtml);

			// 淇 1: 灏嗚浆涔夌殑涓嬪垝绾?\_ 鏇挎崲鍥?_锛屼互姝ｇ‘显示鐢ㄦ埛鍚嶇瓑
			markdown = markdown.replace(/\\_/g, '_');

			// 淇 2: 绉婚櫎閾炬帴鏂囨湰涓殑鎹㈣绗﹀拰澶氫綑绌烘牸
			// 閽堝 X (Twitter) 甯栧瓙锛孾Title\n](url) -> [Title](url)
			markdown = markdown.replace(/\[([\s\S]*?)\]\(([^)]+)\)/g, (match, text, url) => {
				// 灏嗘墍鏈夌┖鐧藉瓧绗︼紙鍖呮嫭鎹㈣锛夋浛鎹负鍗曚釜绌烘牸锛岀劧鍚庡幓闄ら灏剧┖鏍?
				const cleanText = text.replace(/\s+/g, ' ').trim();
				return `[${cleanText}](${url})`;
			});

			// 淇 3: 鍘婚櫎棣栧熬绌虹櫧瀛楃
			markdown = markdown.trim();

			// 灏嗚浆鎹㈠悗鐨?Markdown 鎻掑叆鍒板綋鍓嶅厜鏍囨墍鍦ㄧ殑浣嶇疆
			insertTextAtCursor(textarea, markdown);
		} else if (hasBlankLines) {
			// 处理绾枃鏈腑鐨勭┖鐧借锛氬皢杩炵画鐨勬崲琛岀杞崲涓?Markdown 纭崲琛岋紙涓や釜绌烘牸 + 鎹㈣锛?
			event.preventDefault();

			// 灏嗙┖鐧借锛堣繛缁崲琛岋級杞崲涓?Markdown 鏍煎紡
			// 鍗曚釜鎹㈣淇濇寔涓嶅彉锛岀┖鐧借鐢ㄤ袱涓┖鏍?鎹㈣鏉ヨ〃绀?
			let processedText = pastedText;

			// 灏嗚繛缁殑绌鸿锛圽n\n锛夎浆鎹负 Markdown 娈佃惤鍒嗛殧锛堜繚鐣欙級
			// 涓嶉渶瑕佺壒娈婂鐞嗭紝Markdown 鏈韩鏀寔绌鸿

			insertTextAtCursor(textarea, processedText);
		}
		// 濡傛灉涓嶆弧瓒充互涓婃潯浠讹紝鍒欎笉鎵ц浠讳綍鎿嶄綔锛岃娴忚鍣ㄦ墽琛岄粯璁ょ殑绾枃鏈矘璐淬€?
	}

	function handleGlobalPaste(event) {
		// 纭繚绮樿创鐨勭洰鏍囨槸涓€涓?textarea
		const textarea = event.target;
		if (!textarea.matches('textarea')) {
			return;
		}

		const clipboardData = event.clipboardData || window.clipboardData;
		if (!clipboardData) return;

		// --- 浼樺厛绾?1: 妫€鏌ュ苟处理鍥剧墖鏂囦欢 ---
		const imageFile = Array.from(clipboardData.files).find(file => file.type.startsWith('image/'));
		if (imageFile) {
			event.preventDefault();
			handlePastedImage(imageFile, textarea);
			return; // 处理瀹屾瘯锛岀粨鏉熷嚱鏁?
		}

		// --- 浼樺厛绾?2: 妫€鏌ュ苟处理鍏朵粬绫诲瀷鐨勬枃浠?(闈炲浘鐗? ---
		const otherFiles = Array.from(clipboardData.files).filter(file => !file.type.startsWith('image/'));
		if (otherFiles.length > 0) {
			// 鎴戜滑鍙湪涓荤紪杈戝尯处理闈炲浘鐗囨枃浠剁殑绮樿创锛屽皢鍏朵綔涓洪檮浠?
			if (textarea.id === 'note-input') {
				event.preventDefault();
				// 浣跨敤 DataTransfer 鏉ュ畨鍏ㄥ湴鍚堝苟鐜版湁鏂囦欢鍜屾柊绮樿创鐨勬枃浠?
				const dt = new DataTransfer();
				for (const f of noteFile.files) {
					dt.items.add(f);
				}
				for (const f of otherFiles) {
					dt.items.add(f);
				}
				noteFile.files = dt.files;
				updateMainFileDisplay();
			}
			return;
		}
		handleSmartPaste(event);
	}

	document.addEventListener('paste', handleGlobalPaste);

	noteForm.addEventListener('submit', async e => {
		e.preventDefault();
		if (!noteInput.value.trim() && noteFile.files.length === 0) return showCustomAlert('Content or a file is required.', 'error');

		const btn = e.target.querySelector('button[type="submit"]');
		btn.disabled = true;
		btn.textContent = 'Saving...';

		const formData = new FormData();
		formData.append('content', noteInput.value);
		Array.from(noteFile.files).forEach(file => {
			if (!file.type.startsWith('image/')) {
				formData.append('file', file);
			}
		});
		try {
			const res = await fetch('/api/notes', { method: 'POST', body: formData });
			if (!res.ok) throw new Error(`Save error: ${await res.text()}`);
			noteForm.reset();
			mainEditPreview.innerHTML = '';
			noteForm.classList.remove('preview-mode');
			mainPreviewToggleBtn.classList.remove('active');
			autoResizeTextarea(noteInput);
			updateMainFileDisplay();
			await refreshNotes();
		} catch (error) {
			showCustomAlert(error.message, 'error');
		} finally {
			btn.disabled = false;
			btn.textContent = 'Save';
		}
	});

	const refreshNotes = (shouldScroll = true) => {
		appState.filters.query = '';
		appState.filters.tag = null;
		appState.filters.date = null;
		globalSearchInput.value = '';
		clearSearchBtn.style.display = 'none';

		// 閲嶇疆UI
		document.querySelectorAll('.timeline-item.active, .tag-item.active').forEach(i => i.classList.remove('active'));
		clearFilterBtn.classList.remove('visible');
		clearTagsBtn.classList.remove('visible');

		// 濡傛灉褰撳墠涓嶅湪 home 妯″紡锛屽垏鎹㈠洖鍘?
		if (appState.baseMode !== 'home') {
			appState.baseMode = 'home';
			updateSidebarTabsUI();
		}

		reloadNotes(shouldScroll);
		// 閲嶆柊加载渚ц竟鏍忔暟鎹?
		loadAndRenderTags();
		loadAndRenderTimeline();
		loadAndRenderStats();
	};
	refreshBtn.addEventListener('click', refreshNotes);

	const imagePreviewModal = document.getElementById('image-preview-modal');
	const modalImage = document.getElementById('modal-image');
	const imageCaption = document.getElementById('image-preview-caption');
	const closeImagePreview = document.querySelector('.image-preview-close');
	const videoPreviewModal = document.getElementById('video-preview-modal');
	const modalVideo = document.getElementById('modal-video');
	const videoCaption = document.getElementById('video-preview-caption');
	const closeVideoPreviewBtn = document.querySelector('.video-preview-close');
	function openImagePreview(src, alt) {
		imagePreviewModal.style.display = 'flex';
		if (modalImage.src !== src) {
			modalImage.src = src;
		}
		imageCaption.innerHTML = alt;
	}

	function closePreview() {
		imagePreviewModal.style.display = 'none';
	}
	function openVideoPreview(src, alt) {
		videoPreviewModal.style.display = 'flex';
		if (modalVideo.src !== src) {
			modalVideo.src = src;
		}
		videoCaption.innerHTML = alt;
		modalVideo.play();
	}
	function closeVideoPreview() {
		videoPreviewModal.style.display = 'none';
		modalVideo.pause();
		modalVideo.src = '';
	}

	closeImagePreview.onclick = closePreview;
	imagePreviewModal.addEventListener('click', (e) => {
		if (e.target === imagePreviewModal) {
			closePreview();
		}
	});
	closeVideoPreviewBtn.onclick = closeVideoPreview;
	videoPreviewModal.addEventListener('click', (e) => {
		if (e.target === videoPreviewModal) {
			closeVideoPreview();
		}
	});
	// --- Event Delegation for Notes Container (Corrected for SVG Icons) ---
	notesContainer.addEventListener('click', async e => {
		const target = e.target;

		const expandBtn = target.closest('.expand-note-btn');
		if (expandBtn) {
			const noteElement = expandBtn.closest('.note');
			if (noteElement) {
				const noteId = noteElement.dataset.id;
				const formData = new FormData();
				formData.append('isCollapsed', 'false');
				try {
					const res = await fetch(`/api/notes/${noteId}`, { method: 'PUT', body: formData });
					if (!res.ok) throw new Error('Failed to expand note.');

					// Update UI
					noteElement.classList.remove('collapsed');

					// Update cache
					const noteInCache = allNotesCache.find(n => n.id === parseInt(noteId));
					if (noteInCache) noteInCache.is_collapsed = 0;
				} catch (error) {
					showCustomAlert(error.message, 'error');
				}
			}
			return;
		}

		const shareBtn = target.closest('.share-file-btn');
		if (shareBtn) {
			e.preventDefault();
			e.stopPropagation();

			const noteId = shareBtn.dataset.noteId;
			const fileId = shareBtn.dataset.fileId;
			const originalIcon = shareBtn.innerHTML;
			const successIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 0 24 24" width="18px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;

			shareBtn.disabled = true;
			shareBtn.innerHTML = '...';

			try {
				const response = await fetch(`/api/notes/${noteId}/files/${fileId}/share`, { method: 'POST' });
				if (!response.ok) {
					const errorData = await response.json();
					throw new Error(errorData.error || 'Failed to generate link.');
				}
				const { url } = await response.json();

				await navigator.clipboard.writeText(url);

				shareBtn.innerHTML = successIcon;
				shareBtn.classList.add('copied');
				shareBtn.title = 'Copied!';

				setTimeout(() => {
					shareBtn.innerHTML = originalIcon;
					shareBtn.classList.remove('copied');
					shareBtn.title = 'Get public link';
					shareBtn.disabled = false;
				}, 2000);

			} catch (error) {
				showCustomAlert(`Error: ${error.message}`, 'error');
				shareBtn.innerHTML = originalIcon;
				shareBtn.disabled = false;
			}
			return; // 处理瀹屽垎浜偣鍑诲悗锛岀粓姝㈠悗缁簨浠跺鐞?
		}
		const dateHeader = target.closest('.date-group-header');
		if (dateHeader) {
			const group = dateHeader.parentElement;
			const icon = dateHeader.querySelector('.toggle-icon');
			group.classList.toggle('collapsed');
			icon.classList.toggle('expanded', !group.classList.contains('collapsed'));
			return;
		}
		if (target.matches('.note-image-attachment')) {
			e.preventDefault();
			openImagePreview(target.src, target.alt);
			return;
		}

		const noteElement = target.closest('.note');
		if (!noteElement) return;
		const noteId = noteElement.dataset.id;
		const moreBtn = target.closest('.waterfall-more-btn');
		if (moreBtn) {
			e.stopPropagation(); // 闃绘浜嬩欢鍐掓场鍒癲ocument鐨勫叧闂洃鍚櫒
			showWaterfallPopover(moreBtn, noteId);
			return;
		}
		const editBtn = target.closest('.edit');
		const fullscreenEditBtn = target.closest('.fullscreen-edit');

		const cancelEditBtn = target.closest('.cancel-edit');
		const removeFileBtn = target.closest('.remove-file-btn');
		const saveEditBtn = target.closest('.save-edit');
		const previewToggleBtn = target.closest('.md-preview-toggle-btn');
		const splitToggleBtn = target.closest('.md-split-toggle-btn');
		// 妫€鏌ヨ点击鐨勫厓绱犳垨鍏剁埗鍏冪礌鏄惁鏄?.inline-tag
		const inlineTag = event.target.closest('.inline-tag');

		const unpinBtn = target.closest('.unpin-btn');
		if (unpinBtn) {
			unpinBtn.disabled = true;
			const formData = new FormData();
			formData.append('isPinned', 'false');
			try {
				const res = await fetch(`/api/notes/${noteId}`, { method: 'PUT', body: formData });
				if (!res.ok) throw new Error('Failed to unpin note.');
				await refreshNotes();
			} catch (error) {
				showCustomAlert(error.message, 'error');
				unpinBtn.disabled = false;
			}
			return;
		}
		if (inlineTag) {
			// 闃绘 <a> 鏍囩鐨勯粯璁よ烦杞涓?
			event.preventDefault();

			const tagName = inlineTag.dataset.tagName;
			if (!tagName) return;
			appState.filters.tag = tagName;
			// 更新UI
			document.querySelectorAll('.tag-item.active').forEach(i => i.classList.remove('active'));
			const leftSidebarTag = document.querySelector(`#tags-container .tag-item[data-tag-name="${tagName}"]`);
			if (leftSidebarTag) leftSidebarTag.classList.add('active');
			clearTagsBtn.classList.add('visible');

			reloadNotes();
		}

		if (fullscreenEditBtn) {
			// 浠庡綋鍓嶇瑪璁扮殑 DOM 鍏冪礌涓壘鍒版鍦ㄧ紪杈戠殑 textarea
			const editTextarea = noteElement.querySelector('.edit-textarea');
			// 获取 textarea 涓渶鏂扮殑銆佸彲鑳藉皻鏈繚瀛樼殑鍐呭
			const currentContent = editTextarea.value;
			// 浣跨敤杩欎釜鏈€鏂扮殑鍐呭鎵撳紑鍏ㄥ睆缂栬緫鍣?
			openFullscreenEditor(currentContent, noteId);
		} else if (editBtn) {
			noteElement.classList.add('editing');
			// 鍒濆鍖栦负缂栬緫妯″紡 (raw)
			noteElement.dataset.editMode = 'raw';
			noteElement.querySelector('.md-preview-toggle-btn').classList.remove('active');
			noteElement.querySelector('.md-split-toggle-btn').classList.remove('active');

			const noteData = allNotesCache.find(n => n.id === parseInt(noteId, 10));
			noteElement.newFiles = new DataTransfer().files;

			const filesContainer = noteElement.querySelector('.edit-files-container');
			filesContainer.innerHTML = '';
			const editTextarea = noteElement.querySelector('.edit-textarea');
			autoResizeTextarea(editTextarea);
			noteData.files.forEach(file => filesContainer.appendChild(createFileTag(file.name, file.id)));

			syncNoteEditorLayout(noteElement);
			noteEditorResizeObserver.observe(noteElement);
			// --- 鑷姩鑱氱劍骞跺皢鍏夋爣绉诲姩鍒版湯灏?---
			// 浣跨敤 requestAnimationFrame 鍙互纭繚鍦ㄦ祻瑙堝櫒瀹屾垚UI娓叉煋锛堜娇textarea鍙锛変箣鍚庡啀鎵ц鑱氱劍鎿嶄綔锛?
			requestAnimationFrame(() => {
				const editTextarea = noteElement.querySelector('.edit-textarea');
				editTextarea.focus({ preventScroll: true });
				const textLength = editTextarea.value.length;
				editTextarea.setSelectionRange(textLength, textLength);
				// 濡傛灉鏂囨湰寰堥暱锛岀‘淇?textarea 鍐呴儴涔熸粴鍔ㄥ埌搴曢儴锛?
				editTextarea.scrollTop = editTextarea.scrollHeight;
			});
		} else if (cancelEditBtn) {
			// 1. 浠庣紦瀛樹腑鎵惧埌杩欐潯绗旇鐨勫師濮嬫暟鎹?
			const noteId = parseInt(noteElement.dataset.id, 10);
			const originalNoteData = allNotesCache.find(n => n.id === noteId);

			if (originalNoteData) {
				// 2. 灏?textarea 鐨勫唴瀹归噸缃负鍘熷鏂囨湰
				const editTextarea = noteElement.querySelector('.edit-textarea');
				editTextarea.value = originalNoteData.content;

				// 3. 閲嶇疆楂樺害锛屼互闃叉枃鏈彉鐭悗鐣欎笅绌虹櫧
				autoResizeTextarea(editTextarea);
			}
			// 娓呯┖鍦ㄦ湰娆＄紪杈戜腑鏂版殏瀛樼殑鏂囦欢
			noteElement.newFiles = new DataTransfer().files;
			// 绉婚櫎鎵€鏈夋枃浠剁殑鈥滃緟删除鈥濇爣璁?
			noteElement.querySelectorAll('.edit-file-tag.deleted').forEach(tag => {
				tag.classList.remove('deleted');
				delete tag.dataset.deleted;
			});
			// 绉婚櫎涓烘柊鏂囦欢鍒涘缓鐨刄I鏍囩
			// 锛堝洜涓轰笅娆＄偣鍑荤紪杈戞椂浼氶噸鏂版覆鏌擄紝鎵€浠ヨ繖涓€姝ュ彲浠ョ渷鐣ワ紝浣嗗姞涓婃洿涓ヨ皑锛?
			const filesContainer = noteElement.querySelector('.edit-files-container');
			filesContainer.innerHTML = '';
			if (originalNoteData && originalNoteData.files) {
				originalNoteData.files.forEach(file => filesContainer.appendChild(createFileTag(file.name, file.id)));
			}
			// 5. 鏈€鍚庯紝鎵ц鍘熷鐨刄I娓呯悊鎿嶄綔
			noteElement.classList.remove('editing', 'preview-mode', 'split-mode');
			noteEditorResizeObserver.unobserve(noteElement);
			delete noteElement.dataset.editMode;
		} else if (removeFileBtn) {
			const fileTag = removeFileBtn.closest('.edit-file-tag');
			if (fileTag.dataset.fileId) { // Existing file
				fileTag.classList.toggle('deleted');
				fileTag.dataset.deleted = fileTag.classList.contains('deleted');
			} else { // New file
				const fileName = fileTag.dataset.fileName;
				const dt = new DataTransfer();
				for (const file of noteElement.newFiles) {
					if (file.name !== fileName) dt.items.add(file);
				}
				noteElement.newFiles = dt.files;
				fileTag.remove();
			}

		} else if (saveEditBtn) {
			noteEditorResizeObserver.unobserve(noteElement);
			saveEditBtn.disabled = true;
			// 鎵惧埌SVG骞舵浛鎹负加载涓殑鍔ㄧ敾鎴栨枃鏈?
			const originalIcon = saveEditBtn.innerHTML;
			saveEditBtn.innerHTML = '...';

			const formData = new FormData();
			formData.append('content', noteElement.querySelector('.edit-textarea').value.trim());

			const timestampToggle = noteElement.querySelector('.update-timestamp-toggle');
			const shouldUpdate = !timestampToggle.checked;
			formData.append('update_timestamp', shouldUpdate.toString());

			const filesToDelete = Array.from(noteElement.querySelectorAll('.edit-file-tag[data-deleted="true"]')).map(t => t.dataset.fileId);
			formData.append('filesToDelete', JSON.stringify(filesToDelete));

			Array.from(noteElement.newFiles).forEach(file => formData.append('file', file));

			try {
				// 1. Capture scroll and element position
				const currentScrollY = window.scrollY;
				const oldNoteElement = noteElement; // noteElement is already the target note
				const oldNoteOffsetTop = oldNoteElement.getBoundingClientRect().top + window.scrollY; // Position relative to document

				// 2. Perform save operation
				const res = await fetch(`/api/notes/${noteId}`, { method: 'PUT', body: formData });
				if (!res.ok) throw new Error(`Update failed`);
				const updatedNoteResponse = await res.json();
				const updatedNote = updatedNoteResponse.note;

				if (!updatedNote || typeof updatedNote.id === 'undefined') {
					throw new Error('Server response missing updated note data.');
				}

				// 3. Create a *new* noteElement
				const newNoteElement = createNoteElement(updatedNote);

				// 4. Replace old with new
				if (oldNoteElement.parentNode) {
					oldNoteElement.parentNode.replaceChild(newNoteElement, oldNoteElement);
					// If in waterfall mode, observe the new element to fix layout bug.
					if (appState.isWaterfall) {
						waterfallObserver.observe(newNoteElement);
					}
				} else {
					console.warn('Parent node of oldNoteElement not found during replacement.');
				}

				// 5. Restore scroll position
				// Calculate the new offset top of the new note element
				const newNoteOffsetTop = newNoteElement.getBoundingClientRect().top + window.scrollY; // Position relative to document
				const scrollDelta = newNoteOffsetTop - oldNoteOffsetTop;

				// Adjust the scroll position
				window.scrollTo(0, currentScrollY + scrollDelta);

				// 6. Update allNotesCache
				const indexInCache = allNotesCache.findIndex(n => n.id === updatedNote.id);
				if (indexInCache !== -1) {
					allNotesCache[indexInCache] = updatedNote;
				}

			} catch (error) {
				showCustomAlert(error.message, 'error');
				saveEditBtn.disabled = false;
				saveEditBtn.innerHTML = originalIcon; // 鎭㈠鍥炬爣
			}
		} else if (previewToggleBtn) {
			const currentMode = noteElement.dataset.editMode || 'raw';
			const newMode = currentMode === 'raw' ? 'preview' : 'raw';
			noteElement.dataset.editMode = newMode;

			previewToggleBtn.classList.toggle('active', newMode === 'preview');
			if (newMode === 'preview') {
				const textarea = noteElement.querySelector('.edit-textarea');
				const preview = noteElement.querySelector('.edit-preview');
				preview.innerHTML = postProcessMarkdownHtml(marked.parse(textarea.value || ''));
			}
		} else if (splitToggleBtn) {
			noteElement.classList.toggle('split-mode');
			splitToggleBtn.classList.toggle('active');
			if (splitToggleBtn.classList.contains('active')) {
				const textarea = noteElement.querySelector('.edit-textarea');
				const preview = noteElement.querySelector('.edit-preview');
				preview.innerHTML = postProcessMarkdownHtml(marked.parse(textarea.value || ''));
			}
		}
	});

	notesContainer.addEventListener('mouseover', e => {
		const noteElement = e.target.closest('.note');
		if (!noteElement) return;
		const noteId = noteElement.dataset.id;

		const moreBtn = e.target.closest('.more-actions-btn');
		if (moreBtn) {
			showNotePopover(moreBtn, noteId);
			return;
		}
		const waterfallMoreBtn = e.target.closest('.waterfall-more-btn');
		if (waterfallMoreBtn) {
			showWaterfallPopover(waterfallMoreBtn, noteId);
			return;
		}
	});

	notesContainer.addEventListener('mouseout', e => {
		if (e.target.closest('.more-actions-btn')) {
			hideNotePopover();
		}
		if (e.target.closest('.waterfall-more-btn')) {
			hideWaterfallPopover();
		}
	});

	function createFileTag(name, id = null) {
		const tag = document.createElement('div');
		tag.className = 'edit-file-tag';
		tag.textContent = name;
		if (id) tag.dataset.fileId = id;
		else tag.dataset.fileName = name;
		tag.innerHTML += '<button class="remove-file-btn">&times;</button>';
		return tag;
	}

	// Handle adding new files in edit mode
	function addFilesToEditNote(files, noteElement) {
		const filesContainer = noteElement.querySelector('.edit-files-container');
		const dt = new DataTransfer();
		for (const f of noteElement.newFiles) dt.items.add(f);

		const attachmentFiles = Array.from(files).filter(f => !f.type.startsWith('image/'));
		for (const f of attachmentFiles) {
			dt.items.add(f);
			filesContainer.appendChild(createFileTag(f.name));
		}
		noteElement.newFiles = dt.files;
	}

	notesContainer.addEventListener('change', async e => {
		if (e.target.matches('.edit-file-input')) {
			const noteElement = e.target.closest('.note');
			const textarea = noteElement.querySelector('.edit-textarea');
			await handleImageUploadAndInsert(e.target.files, textarea);
			// 鏃х殑闄勪欢閫昏緫鐜板湪鍙鐞嗛潪鍥剧墖鏂囦欢
			addFilesToEditNote(e.target.files, noteElement);
			e.target.value = '';
		}
	});

	['dragover', 'dragleave', 'drop'].forEach(eventName => {
		notesContainer.addEventListener(eventName, async e => {
			const textarea = e.target.closest('.edit-textarea');
			if (!textarea) return;
			e.preventDefault();
			e.stopPropagation();
			if (eventName === 'dragover') textarea.classList.add('dragover');
			else if (eventName === 'dragleave') textarea.classList.remove('dragover');
			else if (eventName === 'drop') {
				textarea.classList.remove('dragover');
				await handleImageUploadAndInsert(e.dataTransfer.files, textarea.closest('.note').querySelector('.edit-textarea'));

				addFilesToEditNote(e.dataTransfer.files, textarea.closest('.note'));
			}
		});
	});
	notesContainer.addEventListener('input', e => {
		const textarea = e.target;
		const noteElement = textarea.closest('.note');
		if (noteElement) {
			const preview = noteElement.querySelector('.edit-preview');
			if (preview) {
				preview.innerHTML = postProcessMarkdownHtml(marked.parse(textarea.value || ''));
			}
		}
		if (e.target.matches('.edit-textarea')) {
			autoResizeTextarea(e.target);
		}

	});
	notesContainer.addEventListener('contextmenu', e => {
		const link = e.target.closest('.attachment-link');
		if (!link || !link.download) return;
		if (textFileExtensions.includes(link.download.split('.').pop().toLowerCase())) {
			e.preventDefault();
			window.open(`${link.href}?preview=true`, '_blank');
		}
	});

	// --- Infinite Scroll & Initial Load ---
	window.addEventListener('scroll', () => {
		if (window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 100) {
			if (appState.baseMode === 'attachments') {
				if (attachmentsState.hasMore && !attachmentsState.isLoading) {
					fetchAllAttachments();
				}
			} else if (appState.pagination.hasMore && !appState.pagination.isLoading) {
				fetchNotes(appState.pagination.currentPage + 1);
			}
		}
	});

	// 获取骞舵覆鏌撴椂闂寸嚎鍜岀儹鍔涘浘
	async function loadAndRenderTimeline() {
		const timelineContainer = document.getElementById('timeline-container');
		try {
			const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
			const apiUrl = `/api/notes/timeline?timezone=${encodeURIComponent(userTimezone)}`;
			const response = await fetch(apiUrl);
			if (!response.ok) throw new Error('Failed to fetch timeline');
			const timelineData = await response.json();
			loadAndRenderHeatmap(timelineData);

			timelineContainer.innerHTML = '';
			const rootUl = document.createElement('ul');
			const sortedYears = Object.keys(timelineData).sort((a, b) => b - a);

			for (const year of sortedYears) {
				const yearData = timelineData[year];
				const yearLi = createTimelineNode('year', year, yearData.count, { year });
				rootUl.appendChild(yearLi);

				const monthUl = document.createElement('ul');
				monthUl.className = 'timeline-children';
				yearLi.appendChild(monthUl);

				monthUl.style.display = 'block'; //鐩存帴设置鏈堜唤鍒楄〃涓哄彲瑙?
				const yearToggle = yearLi.querySelector('.timeline-toggle');
				if (yearToggle) {
					yearToggle.classList.add('expanded');
				}
				const sortedMonths = Object.keys(yearData.months).sort((a, b) => b - a);
				for (const month of sortedMonths) {
					const monthData = yearData.months[month];
					const monthLi = createTimelineNode('month', month, monthData.count, { year, month });
					monthUl.appendChild(monthLi);

					const dayUl = document.createElement('ul');
					dayUl.className = 'timeline-children';
					monthLi.appendChild(dayUl);
					const sortedDays = Object.keys(monthData.days).sort((a, b) => b - a);
					for (const day of sortedDays) {
						const dayData = monthData.days[day];
						const dayLi = createTimelineNode('day', day, dayData.count, { year, month, day });
						dayUl.appendChild(dayLi);
					}
				}
			}
			timelineContainer.appendChild(rootUl);

		} catch (error) {
			console.error('Error loading timeline:', error);
			timelineContainer.innerHTML = '<p>Error loading timeline.</p>';
		}
	}

	// 鍒涘缓鏃堕棿绾胯妭鐐圭殑杈呭姪鍑芥暟锛屼互鏀寔鏂扮殑浜や簰妯″瀷
	function createTimelineNode(level, label, count, dateParts = {}) {
		const li = document.createElement('li');
		const itemDiv = document.createElement('div');
		itemDiv.className = 'timeline-item';
		itemDiv.dataset.level = level;
		// 瀛樺偍鏃ユ湡淇℃伅鐢ㄤ簬绛涢€?
		if (dateParts.year) itemDiv.dataset.year = dateParts.year;
		if (dateParts.month) itemDiv.dataset.month = dateParts.month;
		if (dateParts.day) itemDiv.dataset.day = dateParts.day;

		const isExpandable = level === 'year' || level === 'month';

		let filterButtonHtml = '';
		if (isExpandable) {
			filterButtonHtml = `
                <button class='timeline-filter-btn' title='Filter notes for ${label}'>
                    <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 4.5h18'/><path d='M3 9.5h18'/><path d='M3 14.5h18'/><path d='M3 19.5h18'/></svg>
                </button>
            `;
		}

		itemDiv.innerHTML = `
            <span class='timeline-label'>
                ${isExpandable ? `<svg class='timeline-toggle' viewBox='0 0 24 24'><path fill='currentColor' d='M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z'></path></svg>` : '<span style="width:24px"></span>'}
                ${label}
            </span>
            <div class='timeline-actions'>
                <span class='timeline-count'>${count}</span>
                ${filterButtonHtml}
            </div>
        `;
		li.appendChild(itemDiv);
		return li;
	}

	const clearFilterBtn = document.getElementById('clear-filter-btn');
	clearFilterBtn.innerHTML = `
        <svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='currentColor'>
            <path d='M0 0h24v24H0V0z' fill='none'/>
            <path d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z'/>
        </svg>
    `;

	clearFilterBtn.addEventListener('click', () => {
		appState.filters.date = null;
		document.querySelectorAll('#timeline-container .timeline-item.active').forEach(i => i.classList.remove('active'));
		clearFilterBtn.classList.remove('visible');
		reloadNotes();
	});

	// 处理鏃堕棿绾跨偣鍑讳簨浠讹紝鐢卞鎴风璁＄畻绮剧‘鏃堕棿鎴?
	document.getElementById('timeline-container').addEventListener('click', (event) => {
		const item = event.target.closest('.timeline-item');
		if (!item) return;

		const filterBtn = event.target.closest('.timeline-filter-btn');
		const level = item.dataset.level;

		const applyFilter = (targetItem) => {
			// --- 1. 浠?data-* 灞炴€т腑获取骞?鏈?鏃?(骞惰浆鎹负鏁板瓧) ---
			const year = parseInt(targetItem.dataset.year);
			const month = targetItem.dataset.month ? parseInt(targetItem.dataset.month) : null;
			const day = targetItem.dataset.day ? parseInt(targetItem.dataset.day) : null;

			// --- 2. 浣跨敤鏈湴鏃跺尯璁＄畻绮剧‘鐨勫紑濮嬪拰缁撴潫鏃堕棿鎴?---
			let startOfDay, endOfDay;
			const monthIndex = month ? month - 1 : 0;

			if (day) { // 绮剧‘鍒板ぉ
				startOfDay = new Date(year, monthIndex, day); // 鏈湴鏃堕棿鐨勫綋澶?00:00:00
				endOfDay = new Date(year, monthIndex, day + 1); // 鏈湴鏃堕棿鐨勪笅涓€澶?00:00:00
			} else if (month) { // 绮剧‘鍒版湀
				startOfDay = new Date(year, monthIndex, 1); // 鏈湴鏃堕棿鐨勫綋鏈堢涓€澶?00:00:00
				endOfDay = new Date(year, monthIndex + 1, 1); // 鏈湴鏃堕棿鐨勪笅涓湀绗竴澶?00:00:00
			} else { // 绮剧‘鍒板勾
				startOfDay = new Date(year, 0, 1); // 鏈湴鏃堕棿鐨勫綋骞寸涓€澶?00:00:00
				endOfDay = new Date(year + 1, 0, 1); // 鏈湴鏃堕棿鐨勪笅涓€骞寸涓€澶?00:00:00
			}

			appState.filters.date = {
				startTimestamp: startOfDay.getTime(),
				endTimestamp: endOfDay.getTime()
			};

			document.querySelectorAll('#timeline-container .timeline-item.active').forEach(activeItem => {
				activeItem.classList.remove('active');
			});
			targetItem.classList.add('active');
			clearFilterBtn.classList.add('visible');
			reloadNotes();
		};

		if (filterBtn) {
			applyFilter(item);
			return;
		}
		if (level === 'day') {
			applyFilter(item);
			return;
		}
		if (level === 'year' || level === 'month') {
			const toggle = item.querySelector('.timeline-toggle');
			const childrenUl = item.parentElement.querySelector('.timeline-children');
			if (childrenUl && toggle) {
				const isExpanded = childrenUl.style.display === 'block';
				childrenUl.style.display = isExpanded ? 'none' : 'block';
				toggle.classList.toggle('expanded', !isExpanded);
			}
		}
	});

	async function loadAndRenderTags() {
		const tagsContainer = document.getElementById('tags-container');
		try {
			const response = await fetch('/api/tags');
			if (!response.ok) throw new Error('Failed to fetch tags');
			const tags = await response.json();

			tagsContainer.innerHTML = '<ul></ul>';
			const listElement = tagsContainer.querySelector('ul');

			if (tags.length === 0) {
				listElement.innerHTML = '<li><div class="tag-item-placeholder">No tags yet.</div></li>';
				return;
			}
			tags.forEach(tag => {
				const tagLi = document.createElement('li');
				tagLi.innerHTML = `
                    <div class='tag-item' data-tag-name='${tag.name}' title='Filter by tag: #${tag.name}'>
                        <span class='tag-label'>
                            <span class='tag-hash'>#</span>
                            <span class='tag-name'>${tag.name}</span>
                        </span>
                        <span class='tag-count'>${tag.count}</span>
                    </div>
                `;
				listElement.appendChild(tagLi);
			});
		} catch (error) {
			console.error('Error loading tags:', error);
			tagsContainer.innerHTML = '<p>Error loading tags.</p>';
		}
	}

	const clearTagsBtn = document.getElementById('clear-tags-filter-btn');
	document.getElementById('tags-container').addEventListener('click', (event) => {
		const item = event.target.closest('.tag-item');
		if (!item) return;
		appState.filters.tag = item.dataset.tagName;
		// 更新UI
		document.querySelectorAll('#tags-container .tag-item.active').forEach(i => i.classList.remove('active'));
		item.classList.add('active');
		clearTagsBtn.classList.add('visible');

		reloadNotes();
	});
	clearTagsBtn.innerHTML = `
        <svg xmlns='http://www.w3.org/2000/svg' height='24px' viewBox='0 0 24 24' width='24px' fill='currentColor'>
            <path d='M0 0h24v24H0V0z' fill='none'/>
            <path d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z'/>
        </svg>
    `;

	clearTagsBtn.addEventListener('click', () => {
		appState.filters.tag = null;
		document.querySelectorAll('#tags-container .tag-item.active').forEach(i => i.classList.remove('active'));
		clearTagsBtn.classList.remove('visible');
		reloadNotes();
	});

	/**
	 * 鐩戝惉 textarea 鐨勯敭鐩樹簨浠讹紝瀹炵幇鍒楄〃鑷姩琛ュ叏
	 * @param {KeyboardEvent} event
	 */
	function handleListAutoInsertion(event) {
		if (event.key !== 'Enter') return;

		const textarea = event.target;
		const cursorPosition = textarea.selectionStart;
		const text = textarea.value;

		// 瀵绘壘褰撳墠琛岀殑璧峰浣嶇疆
		const lineStart = text.lastIndexOf('\n', cursorPosition - 1) + 1;
		const currentLine = text.substring(lineStart, cursorPosition);

		// 鍖归厤鏃犲簭鍒楄〃锛屼緥濡?"- ", "* ", "+ "
		const unorderedListMatch = currentLine.match(/^(\s*[-*+]\s+)/);
		// 鍖归厤鏈夊簭鍒楄〃锛屼緥濡?"1. ", "2. "
		const orderedListMatch = currentLine.match(/^(\s*)(\d+)(\.\s+)/);
		let wasHandled = false;

		if ((unorderedListMatch && currentLine.trim() === unorderedListMatch[0].trim()) ||
			(orderedListMatch && currentLine.trim() === orderedListMatch[0].trim())) {
			event.preventDefault();
			const replacementText = '\n';
			textarea.setRangeText(replacementText, lineStart, cursorPosition);

			const newCursorPosition = lineStart + replacementText.length;
			textarea.selectionStart = textarea.selectionEnd = newCursorPosition;
			wasHandled = true;
		} else {
			let textToInsert = '';
			if (unorderedListMatch) {
				textToInsert = `\n${unorderedListMatch[1]}`;
			} else if (orderedListMatch) {
				const leadingSpace = orderedListMatch[1];
				const number = parseInt(orderedListMatch[2], 10);
				const separator = orderedListMatch[3];
				textToInsert = `\n${leadingSpace}${number + 1}${separator}`;
			}

			if (textToInsert) {
				event.preventDefault();
				textarea.setRangeText(textToInsert, cursorPosition, textarea.selectionEnd);
				const newCursorPosition = cursorPosition + textToInsert.length;
				textarea.selectionStart = textarea.selectionEnd = newCursorPosition;
				wasHandled = true;
			}
		}
		if (wasHandled) {
			autoResizeTextarea(textarea);
		}
	}

	// 涓轰富杈撳叆妗嗙粦瀹?
	noteInput.addEventListener('keydown', event => {
		handleTabIndentation(event);
		handleEditorShortcuts(event);
		handleListAutoInsertion(event);
	});

	// 閫氳繃浜嬩欢濮旀墭涓虹瑪璁板崱鐗囧唴鐨勭紪杈戞缁戝畾
	notesContainer.addEventListener('keydown', event => {
		if (event.target.matches('.edit-textarea')) {
			handleTabIndentation(event);
			handleEditorShortcuts(event);
			handleListAutoInsertion(event);
		}
	});

	function initializeHeatmapDragToScroll() {
		const scrollContainer = document.getElementById('heatmap-scroll-container');
		// 濡傛灉鎵句笉鍒板鍣紙渚嬪加载澶辫触锛夛紝鍒欎笉鎵ц浠讳綍鎿嶄綔
		if (!scrollContainer) return;

		let isDown = false;
		let isDragging = false;
		let startX;
		let scrollLeftStart;

		scrollContainer.addEventListener('mousedown', (e) => {
			// 闃绘榛樿鐨勬枃鏈€夋嫨绛夎涓?
			e.preventDefault();
			isDown = true;
			isDragging = false; // 姣忔鎸変笅榧犳爣鏃讹紝閲嶇疆鎷栨嫿鐘舵€?
			scrollContainer.classList.add('active-drag');
			// 璁板綍璧峰鐐?
			startX = e.pageX - scrollContainer.offsetLeft;
			scrollLeftStart = scrollContainer.scrollLeft;
		});
		scrollContainer.addEventListener('mouseleave', () => {
			isDown = false;
			scrollContainer.classList.remove('active-drag');
		});

		scrollContainer.addEventListener('mouseup', () => {
			isDown = false;
			scrollContainer.classList.remove('active-drag');
		});

		scrollContainer.addEventListener('mousemove', (e) => {
			if (!isDown) return;
			isDragging = true;
			const x = e.pageX - scrollContainer.offsetLeft;
			const walk = (x - startX) * 1.5; //涔樹互1.5鍙互澧炲姞鎷栧姩閫熷害锛屾劅瑙夋洿鐏垫晱
			scrollContainer.scrollLeft = scrollLeftStart - walk;
		});

		scrollContainer.addEventListener('click', (e) => {
			if (isDragging) {
				e.preventDefault();
				e.stopPropagation();
			}
		}, true);
	}

	async function start() {
		document.body.classList.add('loading');

		await loadSettings();

		initializeTheme();
		initializeThemeColor();
		initializeSettings();

		await initializeApp();

		const editorResizeObserver = new ResizeObserver(() => {
			handleEditorLayout();
			syncMainEditorLayout();
		});
		editorResizeObserver.observe(noteForm);
		handleEditorLayout();

		// Finally, hide loader
		document.body.classList.remove('loading');
		const initialLoader = document.getElementById('initial-loader');
		initialLoader.style.opacity = '0';
		setTimeout(() => {
			initialLoader.style.display = 'none';
		}, 500);
	}

	start();
	// });
</script>

<!-- Share Dialog Implementation -->
<style>
	/* Share Modal Styles */
	.share-modal-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.5);
		display: flex;
		align-items: center;
		justify-content: center;
		z-index: 2000;
		opacity: 0;
		visibility: hidden;
		transition: opacity 0.2s;
	}

	.share-modal-overlay.active {
		opacity: 1;
		visibility: visible;
	}

	.share-modal {
		background: var(--surface-color);
		padding: 1.5rem;
		border-radius: 8px;
		width: 90%;
		max-width: 500px;
		box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
		color: var(--text-color);
	}

	.share-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1.5rem;
	}

	.share-header h3 {
		margin: 0;
		font-size: 1.2rem;
	}

	.close-share-btn {
		background: none;
		border: none;
		font-size: 1.5rem;
		cursor: pointer;
		color: var(--text-secondary);
		padding: 0;
		line-height: 1;
	}

	.share-body {
		display: flex;
		flex-direction: column;
		gap: 1.2rem;
	}

	.share-field label {
		display: block;
		margin-bottom: 0.5rem;
		font-weight: 500;
		font-size: 0.9rem;
		color: var(--text-secondary);
	}

	.share-input-group {
		display: flex;
		gap: 0.5rem;
	}

	.share-input {
		flex: 1;
		padding: 0.6rem;
		border: 1px solid var(--border-color);
		border-radius: 4px;
		background: var(--bg-color);
		color: var(--text-color);
		font-size: 0.9rem;
	}

	.share-btn {
		padding: 0.6rem 1rem;
		background: #367cff;
		color: white;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-weight: 500;
		white-space: nowrap;
	}

	.share-btn:hover {
		background: #2a63cc;
	}

	.share-delete-btn {
		padding: 0.6rem 1rem;
		background: transparent;
		color: var(--danger-color);
		border: 1px solid var(--danger-color);
		border-radius: 4px;
		cursor: pointer;
		font-weight: 500;
		margin-top: 0.5rem;
		margin-left: 0.5rem;
		align-self: flex-start;
		width: 140px;
		/* 固定宽度与导出按钮一致 */
	}

	.share-delete-btn:hover {
		background: rgba(229, 62, 62, 0.1);
	}

	.expiration-select {
		padding: 0.6rem;
		border: 1px solid var(--border-color);
		border-radius: 4px;
		background: var(--surface-color);
		color: var(--text-color);
		width: 100%;
	}

	.export-image-btn {
		padding: 0.6rem 1rem;
		background: transparent;
		color: #28a745;
		border: 1px solid #28a745;
		border-radius: 4px;
		cursor: pointer;
		font-weight: 500;
		margin-top: 0.5rem;
		align-self: flex-start;
		width: 140px;
		/* 固定宽度确保按钮长度一致 */
	}

	.export-image-btn:hover {
		background: rgba(40, 167, 69, 0.1);
	}

	.share-buttons-row {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		margin-top: 0.5rem;
	}

	.share-buttons-row .export-image-btn,
	.share-buttons-row .share-delete-btn {
		margin-top: 0;
		margin-left: 0;
	}
</style>

<div class="share-modal-overlay" id="share-modal-overlay">
	<div class="share-modal">
		<div class="share-header">
			<h3>Share Note</h3>
			<button class="close-share-btn" onclick="closeShareDialog()">&times;</button>
		</div>
		<div class="share-body">
			<p style="margin:0; color:var(--text-secondary); font-size:0.9rem;">
				Anyone with these public links can view this note.
			</p>

			<div class="share-field">
				<label>Display Link</label>
				<div class="share-input-group">
					<input type="text" class="share-input" id="share-link-input" readonly
						placeholder="Click 'Create Share Link' to generate">
					<button class="share-btn" id="create-share-btn" onclick="createAndCopyShareLink()">Create Share
						Link</button>
				</div>
			</div>

			<div class="share-field">
				<label>Expires in</label>
				<select class="expiration-select" id="share-expiration-select">
					<option value="3600">1 Hour</option>
					<option value="86400">1 Day</option>
					<option value="604800">7 Days</option>
					<option value="0" selected>Permanent</option>
				</select>
			</div>

			<div class="share-buttons-row">
				<button class="share-btn export-image-btn" onclick="exportNoteAsImage()">📷 导出为图片</button>
				<button class="share-delete-btn" onclick="deleteShare()">停止分享</button>
			</div>
		</div>
	</div>
</div>

<script>
	let currentSharingNoteId = null;
	const STORAGE_KEY_EXPIRATION = 'flynotes_share_expiration';

	// Open Share Dialog
	async function openShareDialog(noteId) {
		currentSharingNoteId = noteId;
		const modal = document.getElementById('share-modal-overlay');
		const input = document.getElementById('share-link-input');
		const select = document.getElementById('share-expiration-select');
		const createBtn = document.getElementById('create-share-btn');

		// Restore last expiration
		const lastExpires = localStorage.getItem(STORAGE_KEY_EXPIRATION);
		if (lastExpires !== null) {
			select.value = lastExpires;
		}

		modal.classList.add('active');

		// 检查 localStorage 中是否有已缓存的分享链接
		const cachedLink = localStorage.getItem(`share_link_${noteId}`);

		if (cachedLink) {
			// 已有分享链接，显示并设置为复制模式
			input.value = cachedLink;
			createBtn.textContent = 'Copy Again';
			createBtn.onclick = () => {
				input.select();
				document.execCommand('copy');
				createBtn.textContent = 'Copied!';
				setTimeout(() => createBtn.textContent = 'Copy Again', 1500);
			};
		} else {
			// 没有分享链接，设置为创建模式
			input.value = '';
			createBtn.textContent = 'Create Share Link';
			createBtn.onclick = createAndCopyShareLink;
		}

		createBtn.disabled = false;
	}

	// Close Share Dialog
	function closeShareDialog() {
		document.getElementById('share-modal-overlay').classList.remove('active');
		currentSharingNoteId = null;
	}

	// Generate/Update Share Link
	async function generateShareLink() {
		if (!currentSharingNoteId) return;

		const expiresIn = parseInt(document.getElementById('share-expiration-select').value);
		// Persist setting
		localStorage.setItem(STORAGE_KEY_EXPIRATION, expiresIn);

		const input = document.getElementById('share-link-input');

		try {
			const response = await fetch(`/api/notes/${currentSharingNoteId}/share`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ expiresIn })
			});

			if (response.ok) {
				const data = await response.json();
				input.value = data.url;
			} else {
				input.value = 'Error generating link';
			}
		} catch (e) {
			console.error('Share Error:', e);
			input.value = 'Error generating link';
		}
	}

	// Update Expiration
	async function updateShareExpiration() {
		const input = document.getElementById('share-link-input');
		input.value = 'Updating...';
		await generateShareLink();
	}

	// Delete Share
	async function deleteShare() {
		if (!currentSharingNoteId) return;
		if (!confirm('Are you sure you want to stop sharing this note? The link will become invalid.')) return;

		const input = document.getElementById('share-link-input');
		input.value = 'Deleting...';

		try {
			const response = await fetch(`/api/notes/${currentSharingNoteId}/share`, {
				method: 'DELETE'
			});

			if (response.ok) {
				// 清除 localStorage 中的缓存
				localStorage.removeItem(`share_link_${currentSharingNoteId}`);
				closeShareDialog();
			} else {
				input.value = 'Error deleting share';
			}
		} catch (e) {
			console.error('Delete Share Error:', e);
			input.value = 'Error';
		}
	}

	// Create and Copy Share Link
	async function createAndCopyShareLink() {
		const btn = document.getElementById('create-share-btn');
		const input = document.getElementById('share-link-input');
		const originalText = btn.textContent;

		btn.textContent = 'Creating...';
		btn.disabled = true;

		try {
			await generateShareLink();

			// 自动复制到剪贴板
			if (input.value && !input.value.includes('Error')) {
				// 缓存分享链接到 localStorage
				localStorage.setItem(`share_link_${currentSharingNoteId}`, input.value);

				input.select();
				document.execCommand('copy');
				btn.textContent = 'Copied!';
				setTimeout(() => {
					btn.textContent = 'Copy Again';
					btn.onclick = () => {
						input.select();
						document.execCommand('copy');
						btn.textContent = 'Copied!';
						setTimeout(() => btn.textContent = 'Copy Again', 1500);
					};
				}, 1500);
			} else {
				btn.textContent = originalText;
			}
		} catch (error) {
			console.error('Create share error:', error);
			btn.textContent = originalText;
		} finally {
			btn.disabled = false;
		}
	}

	// Export Note as Image
	async function exportNoteAsImage() {
		if (!currentSharingNoteId) return;

		const noteElement = document.querySelector(`.note[data-id="${currentSharingNoteId}"]`);
		if (!noteElement) {
			showCustomAlert('找不到笔记元素', 'error');
			return;
		}

		const exportBtn = document.querySelector('.export-image-btn');
		const originalText = exportBtn.textContent;
		exportBtn.textContent = '正在生成图片...';
		exportBtn.disabled = true;

		try {
			// 克隆笔记元素
			const clone = noteElement.cloneNode(true);

			// 移除操作按钮
			const actions = clone.querySelector('.note-actions');
			if (actions) actions.remove();

			// 临时添加到页面用于渲染
			clone.style.position = 'absolute';
			clone.style.left = '-9999px';
			clone.style.width = noteElement.offsetWidth + 'px';
			clone.style.zIndex = '-1';
			document.body.appendChild(clone);

			// 等待图片加载
			const images = clone.querySelectorAll('img');
			await Promise.all(Array.from(images).map(img => {
				if (img.complete) return Promise.resolve();
				return new Promise(resolve => {
					img.onload = resolve;
					img.onerror = resolve;
					setTimeout(resolve, 3000); // 超时保护
				});
			}));

			// 使用 html2canvas 生成图片
			const canvas = await html2canvas(clone, {
				backgroundColor: getComputedStyle(noteElement).backgroundColor,
				scale: 2,
				logging: false,
				useCORS: true,
				allowTaint: true,
				imageTimeout: 0,
				removeContainer: false
			});

			// 移除临时元素
			document.body.removeChild(clone);

			// 转换为 Blob 并下载
			canvas.toBlob((blob) => {
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `note-${currentSharingNoteId}-${Date.now()}.png`;
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				URL.revokeObjectURL(url);
			});

			// 导出成功，不显示提示
		} catch (error) {
			console.error('Export error:', error);
			showCustomAlert('导出失败：' + error.message, 'error');
		} finally {
			exportBtn.textContent = originalText;
			exportBtn.disabled = false;
		}
	}
</script>
</body>

</html>